<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Banco Provincia — OptiRutas v8 (Dashboard · Rutas · Órdenes · ATMs · Sucursales · Cabeceras · Otros)</title>

  <!-- Fuentes y librerías -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <!-- Leaflet (mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    /* ===========================================================
       VARIABLES DE TEMA (claro/oscuro) + UI parametrizable
       =========================================================== */
    :root{
      /* Base (claro) */
      --app-bg:#f3f5f6;
      --text:#182230;
      --muted-text:#6B7B86;

      /* Paleta */
      --brand-50:#effaf3;  --brand-100:#dff5e7; --brand-200:#c8ecd7; --brand-300:#a4ddbe; --brand-400:#7acc9f;
      --brand-500:#55b97f; --brand-600:#43a46d; --brand-650:#3b9562; --brand-700:#2f7c51; --brand-800:#275f41;

      --ink-900:#0f1720; --ink-800:#1a2430; --ink-700:#223042; --ink-600:#2f3f53; --ink-500:#415468; --ink-400:#6b7a8c; --ink-300:#94a0ae; --ink-200:#c9d0d6; --ink-100:#e9edf0;

      --card:#ffffff; 
      --muted:#f7f8f9; 
      --shadow:0 2px 10px rgba(16, 24, 40, .08), 0 1px 3px rgba(16, 24, 40, .06);
      --line-clr: rgba(0,0,0,.08);

      /* Shell */
      --sidebar-bg:linear-gradient(180deg,#11181f 0%, #0e151a 70%);
      --sidebar-text:#EAF0F4;
      --topbar-grad:linear-gradient(180deg,#4a9c6f 0%, #3a865f 100%);

      /* Charts */
      --chart-text:#6b7a8c;
      --chart-grid:#ebeff3;
      --chart-accent:#43a46d;
      --chart-accent-2:#3b9562;
      --chart-accent-soft:rgba(67,164,109,.18);

      /* Rutas */
      --route-a:#2fbb6b;   /* tramo A */
      --route-b:#2a7bc6;   /* tramo B */
      --route-c:#e35a5a;   /* tramo conflicto/penalidad */

      /* Banner */
      --banner-from:#2a7bc6; --banner-mid:#1e589b; --banner-to:#134476; --banner-text:#ffffff;

      /* Accentos */
      --accent:#2fbb6b;
      --accent-2:#2aa862;
      --danger:#e35a5a;

      /* UI parametrizable */
      --ui-fontscale: 1;             /* escala tipográfica */
      --ui-radius: 14px;             /* radio por defecto */
      --ui-accent: #43a46d;          /* color acento */
    }

    html[data-theme="dark"]{
      --app-bg:#0e1620;
      --text:#e8eef7;
      --muted-text:#c8d3e3;

      --brand-50:#141e2c; 
      --brand-100:rgba(255,255,255,.08); 
      --brand-200:#1f2a3a; 
      --brand-300:#233042; 
      --brand-400:#2b3a4e;
      --brand-500:#31614e; 
      --brand-600:#3ca870; 
      --brand-650:#3b9562; 
      --brand-700:#2b7a51; 
      --brand-800:#1f5b3e;

      --ink-900:#f2f6fb; --ink-800:#e8eef7; --ink-700:#c8d3e3; --ink-600:#aab6c8; --ink-500:#8e9cb0; --ink-400:#7f8da4; --ink-300:#6c7b93; --ink-200:#56657c; --ink-100:#3a485d;

      --card:#182231; 
      --muted:#111b28; 
      --shadow:0 14px 26px rgba(0,10,30,.28), inset 0 1px 0 rgba(255,255,255,.04);
      --line-clr: rgba(255,255,255,.12);

      --sidebar-bg:#0c141d;
      --sidebar-text:#c8d3e3;
      --topbar-grad:linear-gradient(180deg,#1b2636 0%, #131c29 100%);

      --chart-text:#c8d3e3;
      --chart-grid:rgba(255,255,255,.12);
      --chart-accent:#39d07c;
      --chart-accent-2:#2f6df6;
      --chart-accent-soft:rgba(67,164,109,.20);

      --banner-from:#2a7bc6; --banner-mid:#1e589b; --banner-to:#134476; --banner-text:#ffffff;

      --accent:#2fbb6b;
      --accent-2:#2aa862;
      --danger:#e35a5a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-size:calc(16px * var(--ui-fontscale));
      background:var(--app-bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Layout ===== */
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:var(--sidebar-bg);color:var(--sidebar-text);position:relative}
    .sidebar .brand{position:absolute;bottom:16px;left:16px;display:flex;gap:10px;align-items:center;opacity:.9}
    .sidebar .brand svg{filter:drop-shadow(0 2px 0 rgba(0,0,0,.25))}
    .menu{padding:14px 12px 84px;}
    .menu h1{display:flex;gap:10px;align-items:center;padding:14px 14px 10px;font-weight:800;font-size:18px;opacity:.95}
    .menu h1 .logo{border-radius:10px;background:rgba(255,255,255,.07);padding:8px;display:grid;place-items:center}
    .nav{margin-top:8px;display:flex;flex-direction:column;gap:4px}
    .nav button{appearance:none;border:0;background:transparent;color:var(--sidebar-text);display:flex;gap:12px;align-items:center;width:100%;padding:10px 12px;border-radius:10px;cursor:pointer;position:relative;overflow:hidden}
    .nav button .ico{width:20px;height:20px;opacity:.95}
    .nav button .txt{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:165px}
    .nav button:hover{background:rgba(255,255,255,.06)}
    .nav button.active{background:rgba(59,149,98,.25);color:#fff;box-shadow:inset 0 0 0 1px rgba(87,177,128,.55)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple .6s linear;background:rgba(255,255,255,.25)}
    @keyframes ripple{to{transform:scale(3.5);opacity:0}}

    .main{display:grid;grid-template-rows:78px 1fr;}
    .topbar{background:var(--topbar-grad);padding:14px 22px;color:#fff;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow)}
    .topbar .title{display:flex;gap:10px;align-items:center;font-weight:800;font-size:22px;letter-spacing:.2px}
    .topbar .title .mark{display:grid;place-items:center;background:rgba(255,255,255,.15);padding:8px;border-radius:10px}
    .topbar .actions{display:flex;gap:10px;align-items:center}

    .icon-btn{--size:36px;width:var(--size);height:var(--size);border-radius:10px;background:rgba(255,255,255,.15);display:grid;place-items:center;border:1px solid rgba(255,255,255,.25);backdrop-filter: blur(2px);cursor:pointer;transition:transform .15s ease, background .2s;}
    .icon-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.22)}
    .icon-btn.small{--size:32px}

    .content{padding:22px;display:grid;gap:18px;grid-template-columns:1fr}
    .hidden{display:none !important}

    /* ====== Cards / tablas ====== */
    .card{background:var(--card);border-radius:var(--ui-radius);box-shadow:var(--shadow);position:relative;border:1px solid var(--line-clr)}
    .card.fade-in{animation:rise .35s ease both}
    @keyframes rise{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .table{background:var(--card);border-radius:var(--ui-radius);box-shadow:var(--shadow);border:1px solid var(--line-clr)}
    .table header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 0}
    .table header h3{margin:0;font-size:16px;font-weight:800;color:var(--text)}
    .table .body{padding:10px 18px 18px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{text-align:left;padding:12px 10px;color:var(--muted-text);font-weight:800;border-bottom:1px solid var(--line-clr)}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--line-clr);color:var(--text)}
    tbody tr{transition: background .18s ease}
    tbody tr:hover{background:rgba(0,0,0,.03)}
    html[data-theme="dark"] tbody tr:hover{background:rgba(255,255,255,.03)}
    tbody tr.selected{background:linear-gradient(180deg, rgba(47,187,107,.22), rgba(47,187,107,.09)); box-shadow: inset 0 0 0 1px rgba(47,187,107,.38)}

    /* ====== Dashboard ====== */
    .stats{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:18px}
    .stat{display:grid;grid-template-columns:auto 1fr;gap:12px;padding:18px}
    .stat .circle{width:44px;height:44px;border-radius:12px;background:var(--brand-50);display:grid;place-items:center;border:1px solid var(--brand-100);box-shadow: inset 0 -1px 0 rgba(0,0,0,.05)}
    .stat .value{font-size:28px;font-weight:800;color:var(--ink-800);letter-spacing:-.5px}
    .stat .label{margin-top:-3px;color:var(--muted-text);font-weight:700}
    .panels{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{background:var(--card);border-radius:var(--ui-radius);box-shadow:var(--shadow);padding:18px;border:1px solid var(--line-clr)}
    .panel h3{margin:0 0 12px 2px;font-size:16px;font-weight:800;color:var(--text)}
    .legend{display:flex;gap:18px;align-items:center;justify-content:center;margin-top:8px}
    .legend .item{display:flex;gap:8px;align-items:center;color:var(--ink-600);font-weight:700}
    .legend .dot{width:10px;height:10px;border-radius:999px}
    .panel-wide{grid-column:1/-1}
    canvas{user-select:none}
    .chart-wrap{position:relative}
    .pie-side-label{position:absolute;top:45%;transform:translateY(-50%);font-weight:800;color:var(--ink-600)}
    .pie-side-label.left{left:4%}
    .pie-side-label.right{right:4%}

    /* ====== About ====== */
    .about .head{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:8px}
    .about .title{font-size:28px;font-weight:800;letter-spacing:.2px;margin:0;color:var(--text)}
    .about .lead{font-size:18px;line-height:1.55;color:var(--ink-600);margin:12px 0 18px;max-width:980px}
    .about .grid{display:grid;gap:18px;grid-template-columns:1fr 1fr}
    .about .card h4{margin:0 0 10px;font-size:16px;font-weight:800;color:var(--text)}
    .about ul{margin:0;padding-left:20px;color:var(--ink-600);font-weight:700}
    .about li{margin:8px 0}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.04));border:1px solid var(--line-clr);color:var(--text);font-weight:800;letter-spacing:.2px;cursor:pointer;transition:transform .15s ease, box-shadow .25s ease, background .25s ease}
    .chip.icon{padding:4px 8px;font-size:12px;line-height:1;min-width:0;justify-content:center}
    .chip.icon.prio-toggle{font-size:14px;min-width:32px}
    .chip.icon.prio-toggle.active{color:#d97706;border-color:rgba(217,119,6,.45);box-shadow:inset 0 0 0 1px rgba(217,119,6,.35);background:rgba(217,119,6,.08)}
    html[data-theme="dark"] .chip.icon.prio-toggle.active{color:#facc15;border-color:rgba(250,204,21,.35);box-shadow:inset 0 0 0 1px rgba(250,204,21,.35);background:rgba(250,204,21,.15)}
    button.chip:disabled{opacity:.45;cursor:not-allowed;transform:none;box-shadow:none}
    html[data-theme="dark"] .chip{background:linear-gradient(180deg,#0c1015,#0a0e13)}
    .chip:hover{transform:translateY(-1px)}
    .route-actions{display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap}
    .banner{position:relative;border-radius:var(--ui-radius);overflow:hidden;min-height:110px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border:1px solid var(--line-clr);background:radial-gradient(120% 140% at -10% 50%, var(--banner-from) 0%, var(--banner-mid) 60%, var(--banner-to) 100%);box-shadow:var(--shadow);isolation:isolate}
    .banner .bapro{font-weight:800;font-size:46px;letter-spacing:.4px;color:var(--banner-text);text-shadow:0 2px 8px rgba(0,0,0,.35)}
    .banner .tag{font-weight:700;font-size:22px;color:var(--banner-text);opacity:.96}

    /* ====== Map panels comunes ====== */
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .search{--h:44px;position:relative;display:flex;align-items:center;gap:10px;min-width:260px;flex:1 1 420px;background:linear-gradient(180deg,rgba(0,0,0,.02),rgba(0,0,0,.04));border:1px solid var(--line-clr);border-radius:12px;height:var(--h);padding:0 12px}
    html[data-theme="dark"] .search{background:linear-gradient(180deg,#26323c,#202a33)}
    .search input{all:unset;color:var(--text);font:700 15px/1 "Inter",sans-serif;width:100%}
    .chip.muted{padding:6px 10px;border-radius:100px;font-weight:700;font-size:12px;background:rgba(0,0,0,.03);border:1px solid var(--line-clr);color:var(--muted-text)}
    html[data-theme="dark"] .chip.muted{background:rgba(255,255,255,.05)}
    .coord{color:var(--muted-text);font-variant-numeric:tabular-nums}
    .map-skeleton{height:420px;display:grid;place-items:center;background:linear-gradient(90deg, #e8edf0 25%, #f1f4f6 37%, #e8edf0 63%);background-size:400% 100%;animation: shimmer 1.6s infinite;border-radius:0 0 var(--ui-radius) var(--ui-radius);overflow:hidden}
    html[data-theme="dark"] .map-skeleton{background: linear-gradient(90deg, #22303a 25%, #273845 37%, #22303a 63%)}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    #atmMap,#sucMap,#routeMap{height:520px;border-radius: 0 0 var(--ui-radius) var(--ui-radius);overflow:hidden}

    /* ====== RUTAS UI ====== */
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .toolbar .left, .toolbar .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:100px;background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.05));border:1px solid var(--line-clr);font-weight:800}
    html[data-theme="dark"] .pill{background:linear-gradient(180deg,#263744,#21323d)}

    .tag{padding:3px 8px;border-radius:999px;font-weight:800;font-size:11px;letter-spacing:.3px;text-transform:uppercase;border:1px solid var(--line-clr);background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.05))}
    .tag.ok{background:linear-gradient(180deg, rgba(47,187,107,.20), rgba(47,187,107,.06));border-color:rgba(47,187,107,.38)}

    .split{display:grid;grid-template-columns:minmax(420px, 0.9fr) minmax(480px, 1.1fr);gap:14px}
    @media (max-width:1150px){ .split{grid-template-columns:1fr} }

    .order-num{display:inline-grid;place-items:center;width:22px;height:22px;border-radius:6px;background:var(--brand-50);border:1px solid var(--brand-100);font:800 11px/1 "Inter",sans-serif}
    .priority{color:#d97706;font-weight:800}
    .route-summary{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .route-summary.alert{padding:12px;border-radius:var(--ui-radius);background:linear-gradient(180deg,rgba(227,90,90,.12),rgba(227,90,90,.08));box-shadow:inset 0 0 0 1px rgba(227,90,90,.35);transition:background .25s ease, box-shadow .25s ease;}
    .route-summary.alert .kv div{color:var(--danger);}
    @media (max-width:900px){ .route-summary{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .kv{background:linear-gradient(180deg,rgba(0,0,0,.02),rgba(0,0,0,.04));border:1px solid var(--line-clr);border-radius:12px;padding:12px 12px 10px}
    html[data-theme="dark"] .kv{background:linear-gradient(180deg,#263744,#21323d)}
    .kv small{color:var(--muted-text);display:block;font-weight:800;letter-spacing:.1em;text-transform:uppercase}
    .kv div{margin-top:6px;font-weight:800;font-size:16px}
    .kv.warning{background:linear-gradient(180deg,rgba(250,204,21,.18),rgba(250,204,21,.06));border-color:rgba(250,204,21,.45);box-shadow:inset 0 0 0 1px rgba(250,204,21,.25)}
    html[data-theme="dark"] .kv.warning{background:linear-gradient(180deg,rgba(202,138,4,.32),rgba(146,64,14,.18));border-color:rgba(234,179,8,.45);box-shadow:inset 0 0 0 1px rgba(234,179,8,.32)}
    .kv.warning div{color:#b45309}
    html[data-theme="dark"] .kv.warning div{color:#fbbf24}
    .kv.danger{background:linear-gradient(180deg,rgba(227,90,90,.22),rgba(227,90,90,.08));border-color:rgba(227,90,90,.45);box-shadow:inset 0 0 0 1px rgba(227,90,90,.35)}
    html[data-theme="dark"] .kv.danger{background:linear-gradient(180deg,rgba(185,28,28,.35),rgba(127,29,29,.2));border-color:rgba(248,113,113,.45);box-shadow:inset 0 0 0 1px rgba(248,113,113,.32)}
    .kv.danger div{color:var(--danger)}

    /* ====== Login + Splash ====== */
    .splash{position:fixed;inset:0;display:none;place-items:center;background:#0b1a12;z-index:400}
    .splash.is-open{display:grid;animation:fadeOut 1s ease 1.2s forwards}
    .splash img{width:min(70vw,640px);max-width:92vw;filter:drop-shadow(0 20px 40px rgba(0,0,0,.4))}
    @keyframes fadeOut{to{opacity:0;visibility:hidden;pointer-events:none}}

    .login-view{position:fixed; inset:0; display:grid; place-items:center; background: radial-gradient(circle at center, #1f3529, #0d1a13); z-index:300}
    .login-container{background:#111; padding:2rem; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,.5); width:min(92vw, 340px); animation: rise .35s ease both}
    .login-container .logo{display:flex; align-items:center; justify-content:center; margin-bottom:1rem}
    .login-container .logo img{width:48px; margin-right:10px}
    .login-container .logo h1{font-size:1.2rem; color:#fff; font-weight:800; line-height:1.1}
    .login-container .logo span{display:block; font-weight:600; font-size:1rem}
    .login-container h2{ text-align:center; color:#fff; font-weight:800; margin:0 0 1rem}
    .login-container .input-group{ margin-bottom:1rem }
    .login-container label{ display:block; color:#ccc; font-weight:700; font-size:.9rem; margin-bottom:6px }
    .login-container input[type="text"], 
    .login-container input[type="password"]{ width:100%; padding:10px 12px; border:1px solid #444; border-radius:8px; background:#1a1a1a; color:#fff; font:600 15px/1 "Inter", system-ui, sans-serif; outline:none; transition: all .2s ease }
    .login-container input:focus{ border-color:#2ecc71; background:#222; box-shadow: 0 0 0 3px rgba(46,204,113,.25) }
    .login-container .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin: 4px 0 12px }
    .login-container .remember{ color:#bbb; font-weight:700; font-size:.85rem; display:flex; align-items:center; gap:8px }
    .login-container .btn{ width:100%; padding:12px; border:0; border-radius:10px; background:#1f5e3a; color:#fff; font:800 15px/1 "Inter", system-ui, sans-serif; cursor:pointer; transition: transform .12s ease, box-shadow .2s ease, background .2s ease }
    .login-container .btn:hover{ background:#2ecc71; transform: translateY(-1px); box-shadow:0 10px 24px rgba(46,204,113,.25) }
    .login-container .error{ margin-top:10px; color:#ff9b9b; font-weight:800; min-height:1.1em }
    @media (prefers-color-scheme: light){
      .login-view{ background: radial-gradient(circle at center, #e9f3ed, #cfe4d8) }
      .login-container{ background:#fff; color:#182230; box-shadow:0 14px 30px rgba(16,24,40,.22) }
      .login-container label{ color:#51606b }
      .login-container input{ background:#f7f8f9; color:#182230 }
      .login-container .btn{ background:#43a46d }
      .login-container .btn:hover{ background:#55b97f }
    }

    /* ====== Loader (camioncito) ====== */
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:20px;z-index:350;background:rgba(9,12,16,.6);backdrop-filter: blur(8px) saturate(120%);transition:opacity .2s ease}
    .modal.open{display:grid}
    .sheet{width:min(760px, 96vw);background:var(--card);border:1px solid var(--line-clr);border-radius:20px;box-shadow:var(--shadow);animation: sheetIn .18s ease}
    @keyframes sheetIn{from{opacity:0;transform:translateY(12px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    .sheet-h{padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;justify-content:space-between;align-items:center;font-weight:800}
    .sheet-b{padding:12px 16px 18px;display:grid;gap:12px}
    .progress{margin: 6px 2px 0 2px;background: #ffffff;border-radius: 999px;border: 1px solid rgba(15,23,42,.08);overflow:hidden;inline-size: 100%; block-size: 10px}
    .bar{inline-size:0%;block-size:100%;background:linear-gradient(90deg, var(--accent), #7cc2ff);transition:inline-size .4s ease}
    .status{font-size:.95rem;color:var(--text);opacity:.85;margin-top:6px}
    #loaderClose{transition:background .2s ease, color .2s ease, box-shadow .2s ease, transform .15s ease}
    #loaderClose:disabled{opacity:.45;cursor:not-allowed;pointer-events:none;transform:none}
    #loaderClose.is-ready{background:linear-gradient(180deg, rgba(227,90,90,.18), rgba(227,90,90,.08));border-color:rgba(227,90,90,.32);color:var(--danger);box-shadow:0 10px 24px rgba(227,90,90,.18)}
    #loaderClose.is-ready:hover{background:linear-gradient(180deg, rgba(227,90,90,.24), rgba(227,90,90,.12))}

    .scene{position:relative;inline-size:100%; block-size: clamp(240px, 48svh, 460px); border: 12px solid #fff; border-radius: calc(var(--ui-radius) + 6px); overflow:hidden; background:#e6f5ff; box-shadow: inset 0 0 0 1px rgba(15,23,42,.05)}
    .background, .foreground{position:absolute; inset:auto 0 0 0; inline-size:100%; block-size:100%; background-size:cover; background-repeat: repeat-x; z-index:0; animation-play-state:paused}
    .background{background-image:url('load1.png'); animation:scroll-bg 15s linear infinite}
    .foreground{background-image:url('load2.png'); animation:scroll-fg 6s linear infinite; z-index:1}
    .truck{position:absolute; left:50%; bottom:1%; transform:translateX(-50%); inline-size:clamp(200px, 36vw, 520px); z-index:3; animation:bounce 1.2s ease-in-out infinite; animation-play-state:paused}
    .smoke, .dust{position:absolute;border-radius:50%;z-index:2;animation-play-state:paused}
    .smoke{left:30%; bottom:3%; inline-size:40px; block-size:40px; background:rgba(150,150,150,.6); animation:smoke 2s infinite}
    .dust{ left:30%; bottom:3%; inline-size:16px; block-size:16px; background:rgba(180,140,80,.6); animation:dust 1.5s infinite}

    .scene.is-running .background,
    .scene.is-running .foreground,
    .scene.is-running .truck,
    .scene.is-running .smoke,
    .scene.is-running .dust{ animation-play-state:running }

    .scene.is-paused .background,
    .scene.is-paused .foreground,
    .scene.is-paused .truck,
    .scene.is-paused .smoke,
    .scene.is-paused .dust{ animation-play-state:paused }

    .modal.has-error .status{color:var(--danger);font-weight:700}

    @keyframes scroll-bg{ from{background-position:0 0} to{background-position:-1920px 0} }
    @keyframes scroll-fg{ from{background-position:0 0} to{background-position:-1280px 0} }
    @keyframes bounce{ 0%,100%{ transform:translate(-50%, 0) } 50%{ transform:translate(-50%, -8px) rotate(-1deg) } }
    @keyframes smoke{ 0%{ transform:scale(.4); opacity:.8 } 50%{ transform:scale(1.2) translateY(-30px); opacity:.4 } 100%{ transform:scale(2) translateY(-60px); opacity:0 } }
    @keyframes dust{ 0%{ transform:scale(.5); opacity:.7 } 50%{ transform:scale(1) translateX(-20px) translateY(-10px); opacity:.5 } 100%{ transform:scale(1.5) translateX(-40px) translateY(-20px); opacity:0 } }
  </style>
</head>
<body>

  <!-- ===== SPLASH ===== -->
  <div id="splash" class="splash" aria-hidden="true">
    <!-- El usuario debe colocar splash.png al lado de index -->
    <img src="splash.png" alt="OptiRutas" />
  </div>

  <!-- ===== LOGIN ===== -->
  <div id="loginView" class="login-view" role="dialog" aria-label="Iniciar sesión">
    <div class="login-container">
      <div class="logo">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Logo_Banco_Provincia.svg/1024px-Logo_Banco_Provincia.svg.png" alt="Banco Provincia" />
        <h1>Banco <span>Provincia</span></h1>
      </div>
      <h2>Iniciar sesión</h2>
      <form id="loginForm" autocomplete="on" novalidate>
        <div class="input-group">
          <label for="usuario">Usuario</label>
          <input type="text" id="usuario" placeholder="1001@oper" required autofocus />
        </div>
        <div class="input-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" placeholder="••••••••" required />
        </div>
        <div class="row">
          <label class="remember"><input type="checkbox" id="remember" /> Recordarme</label>
          <a href="#" id="fakeForgot" style="color:#9ad6b0;font-weight:800; text-decoration:none">¿Olvidaste tu clave?</a>
        </div>
        <button class="btn" id="loginBtn" type="submit">Iniciar sesión</button>
        <div class="error" id="loginError" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appRoot" class="app hidden" aria-hidden="true">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="menu">
        <h1><span class="logo" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.5 3.5C14 4 6 9.5 6 15.5C6 17.985 8.015 20 10.5 20C16.5 20 22 12 20.5 3.5Z" fill="#9ee3b4"/><path d="M3 21C6 16 10.5 12.5 14.5 10.5" stroke="#d9f6df" stroke-width="2" stroke-linecap="round"/></svg>
        </span>Banco Provincia</h1>

        <nav class="nav" id="nav">
          <button class="active" data-name="Dashboard" data-target="dashboard">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M4 19l4-7 4 3 4-8 4 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span class="txt">Dashboard</span>
          </button>
          <button data-name="Rutas" data-target="rutas">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M4 6h5l3 3h8M4 18h10l3-4h3" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span class="txt">Rutas</span>
          </button>
          <button data-name="Órdenes" data-target="ordenes">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M4 5h16v14H4z"/><path d="M7 8h10M7 12h10M7 16h6"/></svg>
            <span class="txt">Órdenes</span>
          </button>
          <button data-name="Sucursales" data-target="sucursales">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 9l9-6 9 6-9 6-9-6z"/><path d="M21 15l-9 6-9-6"/><path d="M3 9l9 6 9-6"/></svg>
            <span class="txt">Sucursales</span>
          </button>
          <button data-name="ATMs" data-target="atms">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 4v4m8-4v4"/></svg>
            <span class="txt">ATMs</span>
          </button>
          <button data-name="Cabeceras" data-target="cabeceras">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 7l1.5-3h9L18 7M6 7h12l-1 12H7L6 7Z"/><path d="M9 11h6" stroke-linecap="round"/></svg>
            <span class="txt">Cabeceras</span>
          </button>
          <button data-name="Otros Bancos" data-target="otros">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
            <span class="txt">Otros Bancos</span>
          </button>
          <button data-name="Choferes" data-target="choferes">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="8" r="3"/><path d="M4 20c1.5-4 6.5-6 8-6s6.5 2 8 6"/></svg>
            <span class="txt">Choferes</span>
          </button>
          <button data-name="Camiones" data-target="camiones">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="7" width="10" height="8" rx="1"/><path d="M13 10h4l3 3v2h-2"/><circle cx="7" cy="18" r="1.5"/><circle cx="17" cy="18" r="1.5"/></svg>
            <span class="txt">Camiones</span>
          </button>
          <button data-name="Costos" data-target="costos">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="9"/><path d="M8 12h8M12 8v8"/></svg>
            <span class="txt">Costos</span>
          </button>
          <button data-name="Reportes" data-target="reportes">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 4h16v16H4z"/><path d="M8 8h8M8 12h8M8 16h5"/></svg>
            <span class="txt">Reportes</span>
          </button>
          <button data-name="Configuración" data-target="config">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1 .6l-.09.1a2 2 0 1 1-3.2 0l-.09-.1a1.65 1.65 0 0 0-1-.6 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-.6-1l-.1-.09a2 2 0 1 1 0-3.2l.1-.09a1.65 1.65 0 0 0 .6-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.94 3.9l.06.06A1.65 1.65 0 0 0 8 4.6c.38 0 .74-.14 1-.4l.09-.1a2 2 0 1 1 3.2 0l.09.1c.26.26.62.4 1 .4.63 0 1.22-.25 1.65-.69l.06-.06A2 2 0 1 1 20.1 6.94l-.06.06c-.46.43-.7 1.02-.7 1.65 0 .38.14.74.4 1l.1.09a1.65 1.65 0 0 0 .6 1z"/></svg>
            <span class="txt">Configuración</span>
          </button>
          <button data-name="Acerca de" data-target="about">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <circle cx="12" cy="12" r="9"></circle>
              <line x1="12" y1="10" x2="12" y2="16"></line>
              <circle cx="12" cy="7" r="1" fill="currentColor"></circle>
            </svg>
            <span class="txt">Acerca de</span>
          </button>
        </nav>
      </div>
      <div class="brand" aria-hidden="true">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="2" width="20" height="20" rx="6" fill="#2b865b"/>
          <path d="M7 16c2.5-3.5 6.5-6 10-7-1 5-5 9-10 7z" fill="#bdf1cc"/>
        </svg>
        <div>
          <div style="font-weight:800;letter-spacing:.2px">Banco</div>
          <div style="opacity:.7">Provincia</div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="title" id="topTitle">
          <span class="mark" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M12 3l3 7h7l-6 4 2 7-6-4-6 4 2-7-6-4h7l3-7z"/></svg>
          </span>
          <span id="topTitleText">Dashboard</span>
        </div>
        <div class="actions">
          <button class="icon-btn" aria-label="Notificaciones" data-tip="Notificaciones">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 1 0-12 0v3.2c0 .53-.21 1.04-.59 1.41L4 17h5"/><path d="M9 20a3 3 0 0 0 6 0"/></svg>
          </button>
          <button class="icon-btn" id="themeToggle" aria-label="Cambiar tema" data-tip="Cambiar tema">
            <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
          <span class="chip muted hidden" id="userChip" style="user-select:none"></span>
          <button class="icon-btn" id="logoutBtn" aria-label="Cerrar sesión" data-tip="Cerrar sesión">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8">
              <path d="M10 17l-1 0a6 6 0 110-10h1" stroke-linecap="round"/>
              <path d="M14 8l4 4-4 4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M18 12H9" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </header>

      <!-- ===== Dashboard ===== -->
      <section class="content" id="dashboardSection" aria-label="Dashboard">
        <div class="stats">
          <div class="card stat fade-in" style="animation-delay:.02s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.8"><path d="M3 21l4-7 4 3 4-8 4 12" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div><div class="value" data-count="12">12</div><div class="label">Rutas</div></div>
          </div>
          <div class="card stat fade-in" style="animation-delay:.06s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.7"><path d="M4 18c3-5 7-5 10-10 1.5-2.1 3-3 6-3" stroke-linecap="round"/><path d="M15 14c2.5-1 4-1 5.5 0" stroke-linecap="round"/></svg></div>
            <div><div class="value" data-count="427">427</div><div class="label">Km</div></div>
          </div>
          <div class="card stat fade-in" style="animation-delay:.1s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.7"><circle cx="12" cy="12" r="8"/><path d="M12 7v5l3 3" stroke-linecap="round"/></svg></div>
            <div><div class="value" data-count="8.2" data-decimal="," data-fixed="1">8,2</div><div class="label">Horas</div></div>
          </div>
          <div class="card stat fade-in" style="animation-delay:.14s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.8"><path d="M6 6l12 12M6 18L18 6" stroke-linecap="round"/></svg></div>
            <div><div class="value" data-count="5">5</div><div class="label">No servidos</div></div>
          </div>
        </div>

        <div class="panels">
          <div class="panel fade-in" style="animation-delay:.18s">
            <h3>Montos Transportados</h3>
            <div class="chart-wrap"><canvas id="montosChart" height="172"></canvas></div>
          </div>
          <div class="panel fade-in" style="animation-delay:.22s">
            <h3>Desglose de Entregas con Éxito</h3>
            <div class="chart-wrap" style="height:200px">
              <canvas id="entregasChart"></canvas>
              <div class="pie-side-label left" id="pieLeft">31,3 %</div>
              <div class="pie-side-label right" id="pieRight">68,7 %</div>
            </div>
            <div class="legend">
              <div class="item"><span class="dot" style="background:var(--brand-650)"></span> Sucursales</div>
              <div class="item"><span class="dot" style="background:var(--brand-200)"></span> ATMs</div>
            </div>
          </div>
          <div class="panel panel-wide fade-in" style="animation-delay:.26s">
            <h3>Entregas Fallidas y Exitosas</h3>
            <div class="chart-wrap"><canvas id="fallidasChart" height="160"></canvas></div>
          </div>
        </div>

        <div class="table card fade-in" style="animation-delay:.30s">
          <header><h3>Rutas Recientes</h3></header>
          <div class="body">
            <table aria-label="Rutas recientes">
              <thead><tr><th>Ruta</th><th>Paradas</th><th>Vehículo</th><th>Horas</th><th>Kilómetros</th></tr></thead>
              <tbody id="recentRoutes"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===== RUTAS ===== -->
      <section class="content hidden" id="rutasSection" aria-label="Rutas">
        <div class="toolbar">
          <div class="left">
            <span class="pill">
              <label for="selOrigen" style="font-weight:800;color:var(--muted-text)">Cabecera</label>
              <select id="selOrigen" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;min-width:180px;font-weight:800"><option value="">—</option></select>
            </span>
            <span class="pill">
              <label for="nCamiones" style="font-weight:800;color:var(--muted-text)">Camiones</label>
              <input id="nCamiones" type="number" min="1" value="1" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:70px;font-weight:800" />
            </span>
            <span class="pill">
              <label for="selCamion" style="font-weight:800;color:var(--muted-text)">Vehículo</label>
              <select id="selCamion" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;min-width:200px;font-weight:800"><option value="">—</option></select>
            </span>
            <span class="pill">
              <label><input type="checkbox" id="prioAbast" checked /> Abastecimientos primero</label>
            </span>
            <span class="pill">
              <label><input type="checkbox" id="prioDescargaAlta" /> Descargar montos altos antes</label>
            </span>
          </div>
          <div class="right">
            <button class="chip" id="btnOptimizar" data-tip="Optimizar (A* + 2-opt)">Optimizar</button>
            <button class="chip" id="btnTransito" data-tip="Consultar tránsito/Simular">Tránsito</button>
            <button class="chip" id="btnExportar" data-tip="Abrir en Google Maps">Exportar</button>
            <button class="chip" id="btnAprobar" data-tip="Aprobar y agregar al historial" style="background: linear-gradient(180deg, rgba(47,187,107,.24), rgba(47,187,107,.08)); border-color:rgba(47,187,107,.32)">Aprobar</button>
          </div>
        </div>

        <div class="split">
          <!-- LISTA DE PUNTOS -->
          <section class="card" aria-labelledby="ptsTitle">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" id="ptsTitle" style="font-weight:800">Puntos disponibles</div>
              <div class="row">
                <div class="search">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                  <input id="ptsQ" placeholder="Buscar (código/nombre)" />
                </div>
                <span class="chip muted">Mostrando <strong id="ptsCount">0</strong></span>
                <button class="chip" id="addFromOrdenes" data-tip="Agregar órdenes seleccionadas">+ Órdenes</button>
              </div>
            </div>
            <div class="card-body" style="overflow:auto; max-height:520px">
              <table class="table" id="ptsTable" role="grid" aria-label="Listado de puntos" style="border:0">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Código/Nombre</th>
                    <th class="right">Lat</th>
                    <th class="right">Lng</th>
                    <th class="right">Monto</th>
                    <th>Servicio</th>
                    <th>Priorizar</th>
                    <th>Agregar</th>
                  </tr>
                </thead>
                <tbody id="ptsTbody"></tbody>
              </table>
            </div>
          </section>

          <!-- MAPA RUTA -->
          <section class="card" aria-labelledby="mapTitle">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" id="mapTitle" style="font-weight:800">Ruta manual / optimizada</div>
              <div class="row">
                <button class="chip" id="btnLimpiarRuta">Limpiar</button>
                <button class="chip" id="btnDeshacer">Deshacer</button>
              </div>
            </div>
            <div class="card-body">
              <div class="map-skeleton" id="routeMapSkeleton">Cargando mapa…</div>
              <div id="routeMap" class="hidden" role="application" aria-label="Mapa de Rutas"></div>
            </div>
            <div class="card-footer" style="padding:12px 16px;border-top:1px solid var(--line-clr)">
              <div class="route-summary" id="routeSummary">
                <div class="kv"><small>Puntos</small><div id="sumPuntos">0</div></div>
                <div class="kv"><small>Camiones comisión</small><div id="sumCamiones">1</div></div>
                <div class="kv"><small>Monto transportado (pico)</small><div id="sumMonto">$ 0</div></div>
                <div class="kv"><small>Peso acumulado</small><div id="sumPeso">0 kg</div></div>
                <div class="kv"><small>Tiempo estimado</small><div id="sumTiempo">0:00 h</div></div>
                <div class="kv"><small>Distancia (km)</small><div id="sumDistKm">0</div></div>
              </div>
            </div>
          </section>

          <!-- PUNTOS IGNORADOS -->
          <section class="card" style="grid-column:1/-1">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" style="font-weight:800">Puntos ignorados</div>
              <span class="chip muted" id="ignoredPtsSummary">Sin incidencias</span>
            </div>
            <div class="card-body" style="overflow:auto; max-height:200px">
              <table class="table" style="border:0">
                <thead><tr><th>Fuente</th><th>Referencia</th><th class="right">Lat</th><th class="right">Lng</th><th>Motivo</th></tr></thead>
                <tbody id="ignoredPtsTbody"><tr><td colspan="5" style="color:var(--muted-text);font-style:italic;">Sin incidencias</td></tr></tbody>
              </table>
            </div>
          </section>

          <!-- RUTA ACTUAL -->
          <section class="card" style="grid-column:1/-1">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" style="font-weight:800">Paradas de la ruta (orden manual/opt.)</div>
            </div>
            <div class="card-body" style="overflow:auto; max-height:320px">
              <table class="table" style="border:0">
                <thead><tr><th>#</th><th>Tipo</th><th>Nombre</th><th class="right">Monto</th><th>Servicio</th><th>Prioridad</th><th>Acciones</th></tr></thead>
                <tbody id="rutaTbody"></tbody>
              </table>
            </div>
          </section>

          <!-- HISTORIAL -->
          <section class="card" style="grid-column:1/-1">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" style="font-weight:800">Historial de Rutas</div>
              <div class="row">
                <button class="chip" id="btnExportHist">Exportar Historial</button>
                <button class="chip" id="btnImportHist">Importar Historial</button>
                <input type="file" id="histImportInput" accept=".json" class="hidden">
              </div>
            </div>
            <div class="card-body" style="overflow:auto; max-height:260px">
              <table class="table" style="border:0">
                <thead><tr><th>Fecha</th><th>Nombre</th><th>Paradas</th><th>Vehículo</th><th>Tiempo</th><th>Distancia (km)</th><th>Monto pico</th><th>Estado</th><th>Acciones</th></tr></thead>
                <tbody id="histTbody"></tbody>
              </table>
            </div>
          </section>
        </div>
      </section>

      <!-- ===== ÓRDENES ===== -->
      <section class="content hidden" id="ordenesSection" aria-label="Órdenes">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="ordQ" placeholder="Buscar por código/nombre/fecha" />
          </div>
          <span class="chip muted">Mostrando <strong id="ordCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="ordNew">Nuevo</button>
            <button class="chip" id="ordImport">Importar CSV</button>
            <button class="chip" id="ordExport">Exportar CSV</button>
            <button class="chip" id="ordTemplate">Descargar plantilla</button>
            <input type="file" id="ordImportInput" accept=".csv" class="hidden">
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="ordTable" aria-label="Listado de órdenes" style="border:0">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Categoría</th>
                  <th>Código/Nombre</th>
                  <th class="right">Monto</th>
                  <th>Moneda</th>
                  <th>Denominación</th>
                  <th>Servicio</th>
                  <th class="right">Peso (kg)</th>
                  <th>Lat</th>
                  <th>Lng</th>
                  <th>Usar</th>
                  <th>Editar</th>
                  <th>Borrar</th>
                </tr>
              </thead>
              <tbody id="ordTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== Sucursales ===== -->
      <section class="content hidden" id="sucSection" aria-label="Sucursales">
        <div class="row" role="search">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="sucQ" placeholder="Buscar Código o Nombre (Ctrl/⌘+K)" />
          </div>
          <span class="chip muted">Mostrando <strong id="sucCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="sucNew">Nuevo</button>
            <button class="chip" id="sucImport">Importar CSV</button>
            <button class="chip" id="sucExport">Exportar CSV</button>
            <button class="chip" id="sucLocate">Mi ubicación</button>
            <input type="file" id="sucImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <div class="panels" style="grid-template-columns:minmax(520px,1.1fr) minmax(360px,.9fr)">
          <section class="card">
            <div class="card-body" style="overflow:auto; max-height:460px">
              <table class="table" id="sucTable" role="grid" aria-label="Listado de Sucursales" style="border:0">
                <thead><tr><th>Código</th><th>Nombre</th><th>Lat</th><th>Lng</th><th>Cochera</th><th>Acciones</th></tr></thead>
                <tbody id="sucTbody"></tbody>
              </table>
            </div>
          </section>
          <section class="card">
            <div class="card-body">
              <div class="map-skeleton" id="sucMapSkeleton">Cargando mapa…</div>
              <div id="sucMap" class="hidden"></div>
            </div>
          </section>
        </div>
      </section>

      <!-- ===== ATMs ===== -->
      <section class="content hidden" id="atmsSection" aria-label="ATMs">
        <div class="row" role="search">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="atmQ" placeholder="Buscar Código o Nombre (Ctrl/⌘+K)" />
          </div>
          <span class="chip muted">Mostrando <strong id="atmCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="atmNew">Nuevo</button>
            <button class="chip" id="atmImport">Importar CSV</button>
            <button class="chip" id="atmExport">Exportar CSV</button>
            <button class="chip" id="atmLocate">Mi ubicación</button>
            <input type="file" id="atmImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <div class="panels" style="grid-template-columns:minmax(520px,1.1fr) minmax(360px,.9fr)">
          <section class="card">
            <div class="card-body" style="overflow:auto; max-height:460px">
              <table class="table" id="atmTable" role="grid" aria-label="Listado de ATMs" style="border:0">
                <thead><tr><th>Código</th><th>Nombre</th><th>Lat</th><th>Lng</th></tr></thead>
                <tbody id="atmTbody"></tbody>
              </table>
            </div>
          </section>
          <section class="card">
            <div class="card-body">
              <div class="map-skeleton" id="atmMapSkeleton">Cargando mapa…</div>
              <div id="atmMap" class="hidden"></div>
            </div>
          </section>
        </div>
      </section>

      <!-- ===== CABECERAS ===== -->
      <section class="content hidden" id="cabSection" aria-label="Cabeceras">
        <div class="row" role="search">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="cabQ" placeholder="Buscar en cualquier campo (Ctrl/⌘+/)" />
          </div>
          <span class="chip muted">Mostrando <strong id="cabCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="cabNew">Nuevo</button>
            <button class="chip" id="cabImport">Importar CSV</button>
            <button class="chip" id="cabExport">Exportar CSV</button>
            <input type="file" id="cabImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:460px">
            <table class="table" id="cabTable" role="grid" aria-label="Listado de Cabeceras" style="border:0">
              <thead><tr><th>Código</th><th>Nombre</th><th>Dirección</th><th>Localidad</th><th>Lat</th><th>Lng</th><th>Supervisor</th><th>Teléfono</th></tr></thead>
              <tbody id="cabTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== OTROS BANCOS ===== -->
      <section class="content hidden" id="otrosSection" aria-label="Otros Bancos">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="otrosQ" placeholder="Buscar Bancos/Terceros" />
          </div>
          <span class="chip muted">Mostrando <strong id="otrosCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="otrosNew">Nuevo</button>
            <button class="chip" id="otrosImport">Importar CSV</button>
            <button class="chip" id="otrosExport">Exportar CSV</button>
            <input type="file" id="otrosImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="otrosTable" aria-label="Otros Bancos/Terceros">
              <thead><tr><th>Código</th><th>Nombre</th><th>Lat</th><th>Lng</th><th>Dirección</th></tr></thead>
              <tbody id="otrosTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== CHOFERES ===== -->
      <section class="content hidden" id="choferesSection" aria-label="Choferes">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="choQ" placeholder="Buscar chofer" />
          </div>
          <span class="chip muted">Mostrando <strong id="choCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="choNew">Nuevo</button>
            <button class="chip" id="choImport">Importar CSV</button>
            <button class="chip" id="choExport">Exportar CSV</button>
            <input type="file" id="choImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="choTable" aria-label="Choferes">
              <thead><tr><th>Legajo</th><th>Nombre</th><th>Licencia</th><th>Vencimiento</th><th>Teléfono</th></tr></thead>
              <tbody id="choTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== CAMIONES ===== -->
      <section class="content hidden" id="camionesSection" aria-label="Camiones">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="camQ" placeholder="Buscar camión" />
          </div>
          <span class="chip muted">Mostrando <strong id="camCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="camNew">Nuevo</button>
            <button class="chip" id="camImport">Importar CSV</button>
            <button class="chip" id="camExport">Exportar CSV</button>
            <input type="file" id="camImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="camTable" aria-label="Camiones">
              <thead><tr><th>Patente/ID</th><th>Modelo</th><th>Capacidad $</th><th>Capacidad (kg)</th><th>Vel máx (km/h)</th></tr></thead>
              <tbody id="camTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== COSTOS (placeholder sintético) ===== -->
      <section class="content hidden" id="costosSection" aria-label="Costos">
        <div style="font-weight:800;font-size:16px">Parámetros de Costos</div>
        <div class="panel">
          <div class="kv"><small>Costo por parada</small><div>$ 750</div></div>
          <div class="kv"><small>Costo por km (CABA)</small><div>$ 50</div></div>
          <div class="kv"><small>Costo por km (AMBA)</small><div>$ 55</div></div>
        </div>
      </section>

      <!-- ===== REPORTES (placeholder ligero) ===== -->
      <section class="content hidden" id="reportesSection" aria-label="Reportes">
        <div class="panel"><h3>Reportes</h3><p style="color:var(--muted-text);font-weight:700">Listo para integrarse con los reportes de la versión anterior.</p></div>
      </section>

      <!-- ===== CONFIGURACIÓN ===== -->
      <section class="content hidden" id="configSection" aria-label="Configuración">
        <div class="panel">
          <h3>Parámetros operativos</h3>
          <div class="row" style="flex-wrap:wrap">
            <span class="pill"><label>Monto máx. por camión</label><input id="cfgMaxMonto" type="number" value="200000000" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:160px;font-weight:800" /></span>
            <span class="pill"><label>Tiempo máx. ruta (min)</label><input id="cfgMaxMin" type="number" value="480" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:120px;font-weight:800" /></span>
            <span class="pill"><label>Velocidad base (km/h)</label><input id="cfgVel" type="number" value="40" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:100px;font-weight:800" /></span>
            <span class="pill"><label>Parada Sucursal (min)</label><input id="cfgStopSuc" type="number" value="5" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
            <span class="pill"><label>Parada ATM (min)</label><input id="cfgStopATM" type="number" value="15" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
            <span class="pill"><label>Parada Cabecera (min)</label><input id="cfgStopCab" type="number" value="10" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
            <span class="pill"><label>Parada BCRA/Otros (min)</label><input id="cfgStopExt" type="number" value="20" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
          </div>
        </div>
        <div class="panel">
          <h3>Interfaz</h3>
          <div class="row">
            <span class="pill"><label>Fuente/escala</label><input id="cfgFont" type="range" min="0.9" max="1.2" step="0.01" value="1" /></span>
            <span class="pill"><label>Radio UI</label><input id="cfgRadius" type="range" min="10" max="22" step="1" value="14" /></span>
            <span class="pill"><label>Acento</label><input id="cfgAccent" type="color" value="#43a46d" /></span>
          </div>
        </div>
      </section>

      <!-- ===== ACERCA DE ===== -->
      <section class="content hidden" id="aboutSection" aria-label="Acerca de">
        <div class="about">
          <div class="head"><h2 class="title">Acerca de</h2></div>
          <p class="lead">Aplicación de optimización logística de rutas y flota de la Tesorería General del Banco de la Provincia de Buenos Aires. Versión 8.</p>
          <div class="about grid">
            <div class="card"><div class="body" style="padding:18px">
              <h4>Créditos</h4>
              <ul>
                <li>Idea, diseño y desarrollo: <strong>Gaston Jorge Contreras Deguin</strong></li>
                <li>Departamento de Presupuesto del Tesoro</li>
              </ul>
              <div class="version" style="margin-top:14px">
                <h4 style="margin:14px 0 10px">Versión</h4>
                <button class="chip" id="versionChip" data-copy="v8.0.0">v8.0.0</button>
              </div>
            </div></div>
            <div class="card"><div class="body" style="padding:0">
              <div class="banner"><div class="bapro">Gerencia de Tesorería General</div><div class="tag">Banco Provincia</div></div>
            </div></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== MODAL: Loader (camioncito) ===== -->
  <div class="modal" id="loaderModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="loaderTitle" aria-describedby="loaderDesc">
    <div class="sheet" role="document">
      <div class="sheet-h">
        <div id="loaderTitle">Optimizando…</div>
        <button class="icon-btn small" id="loaderClose" aria-label="Cerrar">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="sheet-b">
        <div class="scene" id="scene">
          <div class="background"></div>
          <div class="foreground"></div>
          <img src="camioncito.png" alt="Camión de reparto" class="truck" loading="eager">
          <div class="smoke"></div><div class="dust"></div>
        </div>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="bar" id="progressBar"></div></div>
        <p class="status" id="loaderDesc">Preparando…</p>
      </div>
    </div>
  </div>

  <!-- ===== TOAST ===== -->
  <div class="toast" id="toast">Listo</div>

  <script>
  /* =====================================================================
     UTILIDADES / ESTADO GLOBAL
  ===================================================================== */
  const fmtES = new Intl.NumberFormat('es-AR', { maximumFractionDigits: 1 });
  const fmtMoney = (n) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits:0 }).format(n||0);
  const fmtMinutes = (min) => {
    const total = Math.max(0, Math.round(min||0));
    const hours = Math.floor(total/60);
    const minutes = total % 60;
    return `${hours}:${String(minutes).padStart(2,'0')} h`;
  };
  const fmtKg = (n) => Number.isFinite(n) ? `${fmtES.format(n)} kg` : '—';
  const htmlEl = document.documentElement;

  // THEME
  const THEME_KEY = 'bp-theme';
  const savedTheme = localStorage.getItem(THEME_KEY);
  htmlEl.dataset.theme = savedTheme || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  const themeIcon = document.getElementById('themeIcon');
  function setIcon(){
    if(!themeIcon) return;
    themeIcon.innerHTML = (htmlEl.dataset.theme==='dark')
      ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'
      : '<circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>';
  }
  setIcon();
  document.getElementById('themeToggle')?.addEventListener('click', ()=>{
    htmlEl.dataset.theme = htmlEl.dataset.theme === 'dark' ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, htmlEl.dataset.theme);
    setIcon();
  });

  // NAV
  const sections = {
    dashboard: document.getElementById('dashboardSection'),
    rutas: document.getElementById('rutasSection'),
    ordenes: document.getElementById('ordenesSection'),
    sucursales: document.getElementById('sucSection'),
    atms: document.getElementById('atmsSection'),
    cabeceras: document.getElementById('cabSection'),
    otros: document.getElementById('otrosSection'),
    choferes: document.getElementById('choferesSection'),
    camiones: document.getElementById('camionesSection'),
    costos: document.getElementById('costosSection'),
    reportes: document.getElementById('reportesSection'),
    config: document.getElementById('configSection'),
    about: document.getElementById('aboutSection')
  };
  const topTitleText = document.getElementById('topTitleText');
  document.getElementById('nav')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    Object.values(sections).forEach(s=>s.classList.add('hidden'));
    const target = btn.dataset.target || 'dashboard';
    sections[target].classList.remove('hidden');
    topTitleText.textContent = btn.dataset.name || 'Dashboard';
    // Fix Leaflet sizing when becoming visible
    setTimeout(()=>{
      try{ if(window.routeMap) routeMap.invalidateSize(); if(window.sucMap) sucMap.invalidateSize(); if(window.atmMap) atmMap.invalidateSize(); }catch(e){}
    }, 80);
  });

  // TOAST
  const toast = document.getElementById('toast');
  function showToast(text="Listo"){
    toast.textContent = text;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.classList.remove('show'), 1600);
  }

  const WARN_THRESHOLD = 0.9;
  const WARN_PERCENT_LABEL = Math.round(WARN_THRESHOLD * 100);
  const limitAlertState = { monto: 'ok', tiempo: 'ok', peso: 'ok' };
  function setMetricLevel(metric, level, card, toastMessage){
    if(card){
      card.classList.toggle('danger', level === 'danger');
      card.classList.toggle('warning', level === 'warning');
    }
    if(limitAlertState[metric] !== level){
      if(level === 'danger' && toastMessage){
        showToast(toastMessage);
      }
      limitAlertState[metric] = level;
    }
  }

  /* =====================================================================
     AUTH + SPLASH
  ===================================================================== */
  (function(){
    const AUTH_KEY = 'bp-auth';
    const MAX_AGE = 1000 * 60 * 60 * 8; // 8 horas
    const USERS = {
      "1001@oper": { pwd:"oper123", name:"Operador", role:"oper" },
      "2001@super": { pwd:"super123", name:"Supervisor", role:"super" },
      "admin@tesoro": { pwd:"admin123", name:"Administrador", role:"admin" }
    };
    const appRoot   = document.getElementById('appRoot');
    const loginView = document.getElementById('loginView');
    const loginForm = document.getElementById('loginForm');
    const userEl    = document.getElementById('usuario');
    const passEl    = document.getElementById('password');
    const err       = document.getElementById('loginError');
    const remember  = document.getElementById('remember');
    const userChip  = document.getElementById('userChip');
    const logoutBtn = document.getElementById('logoutBtn');
    const splash    = document.getElementById('splash');

    function getSession(){ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)) || null; }catch(e){ return null; } }
    function setSession(s){ localStorage.setItem(AUTH_KEY, JSON.stringify(s)); }
    function clearSession(){ localStorage.removeItem(AUTH_KEY); }

    function isSessionValid(s){
      if(!s || !s.user) return false;
      const age = Date.now() - (s.ts||0);
      if(s.remember) return true;
      return age < MAX_AGE;
    }

    function showApp(){
      loginView.classList.add('hidden');
      appRoot.classList.remove('hidden');
      appRoot.removeAttribute('aria-hidden');
      const s = getSession();
      if(userChip && s){ userChip.textContent = s.name || s.user; userChip.classList.remove('hidden'); }
      // splash al ingresar
      splash.classList.add('is-open');
      // Leaflet sizing
      setTimeout(()=>{ try{ if(window.routeMap) routeMap.invalidateSize(); }catch(e){} }, 200);
      setTimeout(()=>{ splash.classList.remove('is-open'); splash.setAttribute('aria-hidden','true'); }, 2400);
    }

    function showLogin(){
      appRoot.classList.add('hidden'); appRoot.setAttribute('aria-hidden','true');
      loginView.classList.remove('hidden');
      if(err) err.textContent = '';
      userEl && userEl.focus();
    }

    function tryAuto(){ const s = getSession(); if(isSessionValid(s)) showApp(); else showLogin(); }

    loginForm?.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      if(!userEl.value || !passEl.value){ err.textContent = 'Completá usuario y contraseña'; return; }
      const u = (userEl.value||'').trim(); const p = passEl.value;
      const ok = !!u && !!p && ((USERS[u] && USERS[u].pwd===p) || (!USERS[u] && p==='bapro')); // fallback demo
      if(ok){
        const profile = USERS[u] || {name: u, role: 'invitado'};
        setSession({ user:u, name:profile.name, role:profile.role, ts:Date.now(), remember: !!remember?.checked });
        passEl.value = ''; showApp();
      }else{
        err.textContent = 'Usuario o contraseña inválidos';
      }
    });

    logoutBtn?.addEventListener('click', ()=>{ clearSession(); showToast('Sesión cerrada'); showLogin(); });

    tryAuto();
  })();

  /* =====================================================================
     CHARTS DASHBOARD (ligeros)
  ===================================================================== */
  (function(){
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    const barCtx = document.getElementById('montosChart');
    if(barCtx){
      const bar = new Chart(barCtx, {
        type: 'bar',
        data: { labels: ['mar. 9','mar. 10','mar. 12','mar. 12','mar. 14'],
          datasets: [{ label: 'Montos (M)', data: [4.4,3.5,2.6,1.9,1.4], backgroundColor: cssVar('--chart-accent')||'rgba(67,164,109,.85)', borderRadius: 6, borderSkipped: false, maxBarThickness: 46 }]},
        options: { animation:{duration:700}, plugins:{ legend:{display:false} },
          scales:{ x:{ grid:{display:false} }, y:{ grid:{color:cssVar('--chart-grid')}, suggestedMax:5 } }
        }
      });
    }
    const pieCtx = document.getElementById('entregasChart');
    if(pieCtx){
      new Chart(pieCtx, { type:'doughnut', data:{ labels:['Sucursales','ATMs'],
        datasets:[{ data:[68.7,31.3], backgroundColor:[cssVar('--chart-accent-2')||'#3b9562', cssVar('--brand-200')||'#c8ecd7'], borderColor:['#eaf7ef','#f3faf6'], borderWidth:2 }]},
        options:{ cutout:'62%', rotation:-40, plugins:{ legend:{display:false} } } });
    }
    const lineCtx = document.getElementById('fallidasChart');
    if(lineCtx){
      const grad = lineCtx.getContext('2d').createLinearGradient(0,0,0,160); grad.addColorStop(0, 'rgba(67,164,109,.18)'); grad.addColorStop(1,'rgba(67,164,109,0)');
      new Chart(lineCtx, { type:'line',
        data:{ labels:['abr. 2','abr. 4','abr. 6','abr. 7','abr. 8','abr. 10','abr. 4','abr. 10','abr. 10'],
               datasets:[{ data:[2,3,7,6,3,5,4,6,3], borderColor: cssVar('--chart-accent-2')||'#3b9562', backgroundColor: grad, tension:.35, fill:true, pointRadius:3, pointBackgroundColor:'#fff', pointBorderWidth:2 }]},
        options:{ plugins:{ legend:{display:false} }, scales:{ x:{grid:{display:false}}, y:{grid:{color:cssVar('--chart-grid')}, suggestedMax:10} } }
      });
    }
  })();

  /* =====================================================================
     HELPERS CSV + GEO + LEAFLET
  ===================================================================== */
  function parseNumber(x){
    if(typeof x === 'number') return x;
    if(!x) return NaN;
    const s = String(x).trim().replace(/\./g,'').replace(',', '.').replace(/[^0-9\.\-]/g, '');
    return parseFloat(s);
  }
  function haversine(lat1, lon1, lat2, lon2){
    const R = 6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); // km
  }
  function waitForLeaflet(){
    return new Promise(res=>{
      (function check(){ if(window.L && typeof L.map==='function') res(); else setTimeout(check, 40); })();
    });
  }
  function clamp(i, min, max){ return Math.max(min, Math.min(max, i)); }
  function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function fmtCoord(n){
    if(n === null || n === undefined || n === '') return '—';
    const num = typeof n === 'number' ? n : parseNumber(n);
    return Number.isFinite(num) ? num.toFixed(4) : '—';
  }
  function sanitizeHTML(value){
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    };
    return String(value ?? '').replace(/[&<>"']/g, ch => map[ch]);
  }

  /* =====================================================================
     BASES DE DATOS (localStorage) y Seeds
  ===================================================================== */
  const DB = {
    atms: 'db-atms-v3',
    suc:  'db-suc-v3',
    cab:  'db-cab-v3',
    otros:'db-otros-v1',
    cho:  'db-cho-v1',
    cam:  'db-cam-v1',
    ord:  'db-ord-v2',
    hist: 'db-routes-history-v3',
    cfg:  'db-config-v3'
  };
  function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch(e){ return fallback; } }
  function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  const seedATMs = [
    {codigo:"50007", nombre:"América",     lat:-35.426, lng:-61.306},
    {codigo:"50009", nombre:"Ayacucho",    lat:-37.149, lng:-57.139},
    {codigo:"50010", nombre:"Bahía Blanca",lat:-38.715, lng:-62.268},
    {codigo:"50012", nombre:"Bragado",     lat:-35.119, lng:-60.494}
  ];
  const seedSuc = [
    {codigo:"10001", nombre:"Bahía Blanca - Centro", lat:-38.718, lng:-62.268, cochera:false},
    {codigo:"10002", nombre:"La Plata - Catedral",   lat:-34.921, lng:-57.954, cochera:true},
    {codigo:"10003", nombre:"Mar del Plata",         lat:-38.002, lng:-57.556, cochera:false}
  ];
  const seedCab = [
    {codigo:"0106", nombre:"Quilmes", direccion:"Av. Calchaquí", localidad:"Quilmes", supervisor:"M. Ruiz", telefono:"11-23456", lat:-34.7206, lng:-58.2546},
    {codigo:"0101", nombre:"La Plata", direccion:"Av. 7 925", localidad:"La Plata", supervisor:"J. Pérez", telefono:"11-12348", lat:-34.9214, lng:-57.9545}
  ];
  const seedOtros = [
    {codigo:"BCRA01", nombre:"BCRA", lat:-34.6037, lng:-58.3816, direccion:"Reconquista 266"},
    {codigo:"OTRO01", nombre:"Otro Banco X", lat:-34.6, lng:-58.44, direccion:"Av. Siempre Viva 123"}
  ];
  const seedCho = [
    {legajo:"C001", nombre:"Juan Pérez", licencia:"C1", vto:"2026-06-30", tel:"11-1234-5678"},
    {legajo:"C002", nombre:"María López", licencia:"C2", vto:"2025-11-15", tel:"11-2345-6789"}
  ];
  const seedCam = [
    {id:"TRK101", modelo:"Iveco Daily", capMonto:200000000, capKg:1500, velMax:60},
    {id:"TRK102", modelo:"Mercedes Sprinter", capMonto:250000000, capKg:1700, velMax:65}
  ];
  const seedOrd = [
    {id:uuid(), fecha:"2025-08-22", categoria:"ATM", codigo:"50010", nombre:"Bahía Blanca", lat:-38.715, lng:-62.268, monto:-30000000, moneda:"ARS", denominacion:"$1000", servicio:"Abastecimiento", peso:20, usar:false},
    {id:uuid(), fecha:"2025-08-22", categoria:"Sucursal", codigo:"10003", nombre:"Mar del Plata", lat:-38.002, lng:-57.556, monto:45000000, moneda:"ARS", denominacion:"Mixta", servicio:"Retiro", peso:30, usar:false}
  ];

  // CONFIG por defecto
  const cfg = Object.assign({
    maxMonto: 200000000, // $
    maxMin:   480,       // minutos
    maxKg:    1500,      // kg
    vel:      40,        // km/h
    stopSuc:  5,         // min
    stopATM:  15,        // min
    stopCab:  10,        // min
    stopExt:  20,        // min
    uiFont:   1,
    uiRadius: 14,
    uiAccent: '#43a46d',
    trafficFactor: 1.0
  }, load(DB.cfg, {}));
  applyUIConfig();

  function applyUIConfig(){
    document.documentElement.style.setProperty('--ui-fontscale', String(cfg.uiFont||1));
    document.documentElement.style.setProperty('--ui-radius', (cfg.uiRadius||14)+'px');
    document.documentElement.style.setProperty('--ui-accent', cfg.uiAccent||'#43a46d');
  }

  /* =====================================================================
     CSV IMPORT/EXPORT HELPERS
  ===================================================================== */
  function csvParse(text, sepGuess=','){
    const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
    if(!lines.length) return { headers:[], rows:[] };
    const sep = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : sepGuess;
    const headers = lines[0].split(sep).map(h=>h.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const row = []; let cur='', inQ=false;
      const s = lines[i];
      for(let j=0;j<s.length;j++){
        const ch = s[j];
        if(ch==='\"'){ inQ = !inQ; continue; }
        if(ch===sep && !inQ){ row.push(cur); cur=''; } else cur+=ch;
      }
      row.push(cur);
      rows.push(row);
    }
    return { headers, rows };
  }
  function csvExport(arr, headers){
    const hdr = headers;
    const csv = [hdr.join(',')].concat(arr.map(o => hdr.map(h => {
      const v = (o[h]===undefined || o[h]===null) ? '' : String(o[h]);
      const needs = /[,"\n]/.test(v);
      return needs ? ('"'+v.replace(/"/g,'""')+'"') : v;
    }).join(','))).join('\n');
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement("a"), { href:url, download:"export.csv" });
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /* =====================================================================
     MÓDULO DATOS ENTIDADES (ATMs, Suc, Cab, Otros, Choferes, Camiones)
  ===================================================================== */
  const State = {
    atms: load(DB.atms, seedATMs),
    suc: load(DB.suc, seedSuc),
    cab: load(DB.cab, seedCab),
    otros: load(DB.otros, seedOtros),
    cho: load(DB.cho, seedCho),
    cam: load(DB.cam, seedCam),
    ord: load(DB.ord, seedOrd),
    hist: load(DB.hist, [])
  };

  function notifyDataUpdate(scope){
    document.dispatchEvent(new CustomEvent('data:updated', { detail: { scope } }));
    const routeAPI = globalThis.Route;
    if(routeAPI && typeof routeAPI.refreshSources === 'function'){
      routeAPI.refreshSources();
    }
  }

  // ========= Sucursales =========
  (function(){
    const tbody = document.getElementById('sucTbody');
    const cntEl = document.getElementById('sucCount');
    const qEl = document.getElementById('sucQ');
    let sucMap, sucMarker;

    function render(){
      const q = (qEl.value||'').toLowerCase();
      const arr = State.suc.filter(r=>{
        const cod = r.codigo == null ? '' : String(r.codigo);
        const nom = r.nombre == null ? '' : String(r.nombre);
        return !q || cod.toLowerCase().includes(q) || nom.toLowerCase().includes(q);
      });
      cntEl.textContent = arr.length;
      const rows = arr.map(rec => ({ rec, idx: State.suc.indexOf(rec) })).filter(row => row.idx >= 0);
      tbody.innerHTML = rows.map(({rec, idx}) => {
        const codigo = sanitizeHTML(rec.codigo || '');
        const nombre = sanitizeHTML(rec.nombre || '');
        const lat = sanitizeHTML(fmtCoord(rec.lat));
        const lng = sanitizeHTML(fmtCoord(rec.lng));
        const cochera = rec.cochera ? 'Sí' : 'No';
        return `
          <tr data-index="${idx}">
            <td>${codigo}</td>
            <td>${nombre}</td>
            <td class="right">${lat}</td>
            <td class="right">${lng}</td>
            <td>${cochera}</td>
            <td>
              <div class="row" style="gap:8px;flex-wrap:nowrap">
                <button class="chip" data-act="edit">Editar</button>
                <button class="chip" data-act="del">Eliminar</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      Array.from(tbody.querySelectorAll('tr')).forEach((tr, i)=>{
        const row = rows[i];
        if(!row) return;
        tr.addEventListener('click', (ev)=>{
          if(ev.target.closest('button[data-act]')) return;
          focusSucursal(row.rec);
        });
        tr.querySelector('button[data-act="edit"]')?.addEventListener('click', (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          editSucursal(row.idx);
        });
        tr.querySelector('button[data-act="del"]')?.addEventListener('click', (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          deleteSucursal(row.idx);
        });
      });
      notifyDataUpdate('sucursales');
    }
    qEl?.addEventListener('input', render);

    function focusSucursal(r){
      if(!r || !sucMap || !sucMarker) return;
      const lat = parseNumber(r.lat);
      const lng = parseNumber(r.lng);
      if(!Number.isFinite(lat) || !Number.isFinite(lng)){
        showToast('Sucursal sin coordenadas válidas');
        return;
      }
      sucMarker.setLatLng([lat,lng]);
      sucMap.flyTo([lat,lng], 12, {duration:.6});
    }
    function editSucursal(idx){
      const current = State.suc[idx];
      if(!current) return;
      const latVal = Number.isFinite(parseNumber(current.lat)) ? String(current.lat) : '';
      const lngVal = Number.isFinite(parseNumber(current.lng)) ? String(current.lng) : '';
      const html = `
        <div class="field"><label>Código</label><input id="sucEditCodigo" value="${sanitizeHTML(current.codigo || '')}"></div>
        <div class="field"><label>Nombre</label><input id="sucEditNombre" value="${sanitizeHTML(current.nombre || '')}"></div>
        <div class="field"><label>Lat</label><input id="sucEditLat" value="${sanitizeHTML(latVal)}" placeholder="-34.6037"></div>
        <div class="field"><label>Lng</label><input id="sucEditLng" value="${sanitizeHTML(lngVal)}" placeholder="-58.3816"></div>
        <div class="field"><label>Cochera</label>
          <select id="sucEditCochera">
            <option value="no"${current.cochera ? '' : ' selected'}>No</option>
            <option value="si"${current.cochera ? ' selected' : ''}>Sí</option>
          </select>
        </div>
      `;
      openSmallModal('Editar sucursal', html, ()=>{
        const codigo = (document.getElementById('sucEditCodigo')?.value || '').trim();
        const nombre = (document.getElementById('sucEditNombre')?.value || '').trim();
        const lat = parseNumber(document.getElementById('sucEditLat')?.value);
        const lng = parseNumber(document.getElementById('sucEditLng')?.value);
        const cochera = (document.getElementById('sucEditCochera')?.value || 'no') === 'si';
        if(!codigo || !nombre){ showToast('Completá código y nombre'); return false; }
        if(!Number.isFinite(lat) || !Number.isFinite(lng)){ showToast('Ingresá coordenadas válidas'); return false; }
        const duplicate = State.suc.some((s, i)=> i !== idx && (s.codigo||'').trim().toLowerCase() === codigo.toLowerCase());
        if(duplicate){ showToast('Ya existe una sucursal con ese código'); return false; }
        Object.assign(current, { codigo, nombre, lat, lng, cochera });
        save(DB.suc, State.suc);
        render();
        focusSucursal(State.suc[idx]);
        showToast('Sucursal actualizada');
        return true;
      });
    }
    function deleteSucursal(idx){
      const current = State.suc[idx];
      if(!current) return;
      const label = [current.codigo, current.nombre].filter(Boolean).join(' — ');
      if(!confirm(`¿Eliminar sucursal${label ? ` ${label}` : ''}?`)) return;
      State.suc.splice(idx,1);
      save(DB.suc, State.suc);
      render();
      showToast('Sucursal eliminada');
    }
    // CSV import/export
    document.getElementById('sucImport')?.addEventListener('click', ()=> document.getElementById('sucImportInput').click());
    document.getElementById('sucImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h)),
          cochera: headers.findIndex(h=>/cochera/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = parseNumber(cells[idx.lat]); const lng = parseNumber(cells[idx.lng]);
          return { codigo: (cells[idx.codigo]||'').trim(), nombre:(cells[idx.nombre]||'').trim(), lat, lng, cochera: String(cells[idx.cochera]||'').toLowerCase().startsWith('s') };
        }).filter(r=>r.codigo && r.nombre && isFinite(r.lat) && isFinite(r.lng));
        if(out.length){ State.suc = out; save(DB.suc, State.suc); render(); showToast('Sucursales importadas'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('sucExport')?.addEventListener('click', ()=>{
      csvExport(State.suc, ['codigo','nombre','lat','lng','cochera']);
    });

    // Mapa
    waitForLeaflet().then(()=>{
      const sk = document.getElementById('sucMapSkeleton'); const el = document.getElementById('sucMap'); if(!el) return;
      sk.classList.add('hidden'); el.classList.remove('hidden');
      sucMap = L.map('sucMap', { zoomControl:true, minZoom:3 }); 
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(sucMap);
      const firstValidSuc = State.suc.map(s=>({ lat: parseNumber(s.lat), lng: parseNumber(s.lng) }))
        .find(pos => Number.isFinite(pos.lat) && Number.isFinite(pos.lng));
      const initialSuc = firstValidSuc ? [firstValidSuc.lat, firstValidSuc.lng] : [-34.60, -58.38];
      sucMarker = L.marker(initialSuc).addTo(sucMap);
      sucMap.setView(initialSuc, 10);
    });

    // Quick actions
    document.getElementById('sucNew')?.addEventListener('click', ()=>{
      const cod = String(Math.max(0,...State.suc.map(r=>+r.codigo||0))+1).padStart(5,'0');
      State.suc.push({codigo:cod, nombre:'Nueva', lat:-34.6, lng:-58.38, cochera:false});
      save(DB.suc, State.suc); render();
    });
    document.getElementById('sucLocate')?.addEventListener('click', ()=>{
      if(!navigator.geolocation) return showToast('Sin geolocalización');
      navigator.geolocation.getCurrentPosition(pos=>{
        sucMap && sucMap.flyTo([pos.coords.latitude, pos.coords.longitude], 12, {duration:.8});
      });
    });

    render();
  })();

  // ========= ATMs =========
  (function(){
    const tbody = document.getElementById('atmTbody');
    const cntEl = document.getElementById('atmCount');
    const qEl = document.getElementById('atmQ');
    let atmMap, atmMarker;

    function render(){
      const q = (qEl.value||'').toLowerCase();
      const arr = State.atms.filter(r=> !q || r.codigo.includes(q) || (r.nombre||'').toLowerCase().includes(q));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `
        <tr data-cod="${r.codigo}"><td>${r.codigo}</td><td>${r.nombre||''}</td><td class="right">${fmtCoord(r.lat)}</td><td class="right">${fmtCoord(r.lng)}</td></tr>
      `).join('');
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        tr.addEventListener('click', ()=>{
          const r = State.atms.find(x=>x.codigo===tr.dataset.cod);
          if(r && atmMap){
            const lat = parseNumber(r.lat);
            const lng = parseNumber(r.lng);
            if(!Number.isFinite(lat) || !Number.isFinite(lng)){
              showToast('ATM sin coordenadas válidas');
              return;
            }
            atmMarker.setLatLng([lat,lng]);
            atmMap.flyTo([lat,lng], 12, {duration:.6});
          }
        });
      });
      notifyDataUpdate('atms');
    }
    qEl?.addEventListener('input', render);

    document.getElementById('atmImport')?.addEventListener('click', ()=> document.getElementById('atmImportInput').click());
    document.getElementById('atmImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = parseNumber(cells[idx.lat]); const lng = parseNumber(cells[idx.lng]);
          return { codigo: (cells[idx.codigo]||'').trim().padStart(5,'0'), nombre:(cells[idx.nombre]||'').trim(), lat, lng };
        }).filter(r=>r.codigo && r.nombre && isFinite(r.lat) && isFinite(r.lng));
        if(out.length){ State.atms = out; save(DB.atms, State.atms); render(); showToast('ATMs importados'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('atmExport')?.addEventListener('click', ()=> csvExport(State.atms, ['codigo','nombre','lat','lng']));

    waitForLeaflet().then(()=>{
      const sk = document.getElementById('atmMapSkeleton'); const el = document.getElementById('atmMap'); if(!el) return;
      sk.classList.add('hidden'); el.classList.remove('hidden');
      atmMap = L.map('atmMap', { zoomControl:true, minZoom:3 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(atmMap);
      const firstValidAtm = State.atms.map(a=>({ lat: parseNumber(a.lat), lng: parseNumber(a.lng) }))
        .find(pos => Number.isFinite(pos.lat) && Number.isFinite(pos.lng));
      const initialAtm = firstValidAtm ? [firstValidAtm.lat, firstValidAtm.lng] : [-34.60, -58.38];
      atmMarker = L.marker(initialAtm).addTo(atmMap);
      atmMap.setView(initialAtm, 10);
    });

    document.getElementById('atmNew')?.addEventListener('click', ()=>{
      const cod = String(Math.max(0,...State.atms.map(r=>+r.codigo||0))+1).padStart(5,'0');
      State.atms.push({codigo:cod, nombre:'Nuevo', lat:-34.6, lng:-58.38});
      save(DB.atms, State.atms); render();
    });
    document.getElementById('atmLocate')?.addEventListener('click', ()=>{
      if(!navigator.geolocation) return showToast('Sin geolocalización');
      navigator.geolocation.getCurrentPosition(pos=>{
        atmMap && atmMap.flyTo([pos.coords.latitude, pos.coords.longitude], 12, {duration:.8});
      });
    });

    render();
  })();

  // ========= Cabeceras =========
  (function(){
    const tbody = document.getElementById('cabTbody');
    const cntEl = document.getElementById('cabCount');
    const qEl = document.getElementById('cabQ');
    const selOrigen = document.getElementById('selOrigen');

    function render(){
      const q = (qEl.value||'').toLowerCase();
      const arr = State.cab.filter(r => !q || Object.values(r).some(v => (''+v).toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `
        <tr>
          <td>${r.codigo}</td>
          <td>${r.nombre||''}</td>
          <td>${r.direccion||''}</td>
          <td>${r.localidad||''}</td>
          <td class="right">${fmtCoord(r.lat)}</td>
          <td class="right">${fmtCoord(r.lng)}</td>
          <td>${r.supervisor||''}</td>
          <td>${r.telefono||''}</td>
        </tr>
      `).join('');
      if(selOrigen){
        const prev = selOrigen.value;
        const validCab = State.cab.filter(c => Number.isFinite(parseNumber(c.lat)) && Number.isFinite(parseNumber(c.lng)));
        selOrigen.innerHTML = '<option value="">—</option>' + validCab.map(c => `<option value="${c.codigo}">${c.codigo} — ${c.nombre}</option>`).join('');
        if(validCab.some(c => c.codigo === prev)){
          selOrigen.value = prev;
        }else if(prev){
          selOrigen.value = '';
          selOrigen.dispatchEvent(new Event('change'));
        }
      }
      notifyDataUpdate('cabeceras');
    }
    qEl?.addEventListener('input', render);

    document.getElementById('cabImport')?.addEventListener('click', ()=> document.getElementById('cabImportInput').click());
    document.getElementById('cabImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          direccion: headers.findIndex(h=>/direccion/i.test(h)),
          localidad: headers.findIndex(h=>/localidad/i.test(h)),
          lat: headers.findIndex(h=>/(^lat$|latitud)/i.test(h)),
          lng: headers.findIndex(h=>/(^lng$|^lon$|longitud)/i.test(h)),
          supervisor: headers.findIndex(h=>/supervisor/i.test(h)),
          telefono: headers.findIndex(h=>/telefono/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = idx.lat>=0 ? parseNumber(cells[idx.lat]) : NaN;
          const lng = idx.lng>=0 ? parseNumber(cells[idx.lng]) : NaN;
          return {
            codigo:(cells[idx.codigo]||'').trim(),
            nombre:(cells[idx.nombre]||'').trim(),
            direccion:(cells[idx.direccion]||'').trim(),
            localidad:(cells[idx.localidad]||'').trim(),
            lat: Number.isFinite(lat) ? lat : null,
            lng: Number.isFinite(lng) ? lng : null,
            supervisor:(cells[idx.supervisor]||'').trim(),
            telefono:(cells[idx.telefono]||'').trim()
          };
        }).filter(r=>r.codigo && r.nombre);
        if(out.length){ State.cab = out; save(DB.cab, State.cab); render(); showToast('Cabeceras importadas'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('cabExport')?.addEventListener('click', ()=> csvExport(State.cab, ['codigo','nombre','direccion','localidad','lat','lng','supervisor','telefono']));

    document.getElementById('cabNew')?.addEventListener('click', ()=>{
      const cod = String(Math.max(0,...State.cab.map(r=>parseInt(r.codigo)||0))+1).padStart(4,'0');
      State.cab.push({codigo:cod, nombre:'Nueva', direccion:'—', localidad:'—', lat:null, lng:null, supervisor:'—', telefono:'—'});
      save(DB.cab, State.cab); render();
    });

    render();
  })();

  // ========= Otros Bancos =========
  (function(){
    const tbody = document.getElementById('otrosTbody'); const cntEl = document.getElementById('otrosCount'); const qEl = document.getElementById('otrosQ');
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.otros.filter(r=> !q || (r.codigo||'').toLowerCase().includes(q) || (r.nombre||'').toLowerCase().includes(q));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `<tr><td>${r.codigo||''}</td><td>${r.nombre||''}</td><td>${fmtCoord(r.lat)}</td><td>${fmtCoord(r.lng)}</td><td>${r.direccion||''}</td></tr>`).join('');
      notifyDataUpdate('otros');
    }
    qEl?.addEventListener('input', render);
    document.getElementById('otrosImport')?.addEventListener('click', ()=> document.getElementById('otrosImportInput').click());
    document.getElementById('otrosImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h)),
          direccion: headers.findIndex(h=>/direccion/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = parseNumber(cells[idx.lat]); const lng = parseNumber(cells[idx.lng]);
          return { codigo:(cells[idx.codigo]||'').trim(), nombre:(cells[idx.nombre]||'').trim(), lat, lng, direccion:(cells[idx.direccion]||'').trim() };
        }).filter(r=>r.codigo && isFinite(r.lat) && isFinite(r.lng));
        if(out.length){ State.otros = out; save(DB.otros, State.otros); render(); showToast('Otros bancos importados'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('otrosExport')?.addEventListener('click', ()=> csvExport(State.otros, ['codigo','nombre','lat','lng','direccion']));
    document.getElementById('otrosNew')?.addEventListener('click', ()=>{
      State.otros.push({codigo:'OTRO'+String(State.otros.length+1).padStart(2,'0'), nombre:'Nuevo', lat:-34.6, lng:-58.38, direccion:'—'});
      save(DB.otros, State.otros); render();
    });
    render();
  })();

  // ========= Choferes =========
  (function(){
    const tbody = document.getElementById('choTbody'); const cntEl = document.getElementById('choCount'); const qEl = document.getElementById('choQ');
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.cho.filter(r=> !q || Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `<tr><td>${r.legajo}</td><td>${r.nombre}</td><td>${r.licencia}</td><td>${r.vto}</td><td>${r.tel||''}</td></tr>`).join('');
      notifyDataUpdate('choferes');
    }
    qEl?.addEventListener('input', render);
    document.getElementById('choImport')?.addEventListener('click', ()=> document.getElementById('choImportInput').click());
    document.getElementById('choImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return; const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {legajo: headers.indexOf('legajo'), nombre: headers.indexOf('nombre'), licencia: headers.indexOf('licencia'), vto: headers.indexOf('vto'), tel: headers.indexOf('tel')};
        const out = rows.map(c => ({legajo:c[idx.legajo], nombre:c[idx.nombre], licencia:c[idx.licencia], vto:c[idx.vto], tel:c[idx.tel]})).filter(r=>r.legajo && r.nombre);
        if(out.length){ State.cho = out; save(DB.cho, State.cho); render(); showToast('Choferes importados'); }
      };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('choExport')?.addEventListener('click', ()=> csvExport(State.cho, ['legajo','nombre','licencia','vto','tel']));
    document.getElementById('choNew')?.addEventListener('click', ()=>{
      State.cho.push({legajo:'C'+String(State.cho.length+1).padStart(3,'0'), nombre:'Nuevo', licencia:'C1', vto:'2026-01-01', tel:''});
      save(DB.cho, State.cho); render();
    });
    render();
  })();

  // ========= Camiones =========
  (function(){
    const tbody = document.getElementById('camTbody'); const cntEl = document.getElementById('camCount'); const qEl = document.getElementById('camQ');
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.cam.filter(r=> !q || Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `<tr><td>${r.id}</td><td>${r.modelo||''}</td><td class="right">${fmtMoney(r.capMonto||0)}</td><td class="right">${r.capKg||0}</td><td class="right">${r.velMax||0}</td></tr>`).join('');
      notifyDataUpdate('camiones');
    }
    qEl?.addEventListener('input', render);
    document.getElementById('camImport')?.addEventListener('click', ()=> document.getElementById('camImportInput').click());
    document.getElementById('camImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return; const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {id: headers.indexOf('id'), modelo: headers.indexOf('modelo'), capMonto: headers.indexOf('capMonto'), capKg: headers.indexOf('capKg'), velMax: headers.indexOf('velMax')};
        const out = rows.map(c => ({id:c[idx.id], modelo:c[idx.modelo], capMonto: parseNumber(c[idx.capMonto]), capKg: parseNumber(c[idx.capKg]), velMax: parseNumber(c[idx.velMax])})).filter(r=>r.id);
        if(out.length){ State.cam = out; save(DB.cam, State.cam); render(); showToast('Camiones importados'); }
      };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('camExport')?.addEventListener('click', ()=> csvExport(State.cam, ['id','modelo','capMonto','capKg','velMax']));
    document.getElementById('camNew')?.addEventListener('click', ()=>{
      State.cam.push({id:'TRK'+String(State.cam.length+1).padStart(3,'0'), modelo:'Nuevo', capMonto:200000000, capKg:1500, velMax:60});
      save(DB.cam, State.cam); render();
    });
    render();
  })();

  /* =====================================================================
     ÓRDENES (CRUD + CSV)
  ===================================================================== */
  (function(){
    const tbody = document.getElementById('ordTbody'); const cntEl = document.getElementById('ordCount'); const qEl = document.getElementById('ordQ');
    const sel = (s,sc)=> (sc||document).querySelector(s);
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.ord.filter(r=> !q || [r.fecha, r.categoria, r.codigo, r.nombre, r.servicio].some(v => String(v||'').toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `
        <tr data-id="${r.id}">
          <td>${r.fecha||''}</td><td>${r.categoria||''}</td><td>${(r.codigo||'')+' — '+(r.nombre||'')}</td>
          <td class="right">${fmtMoney(r.monto||0)}</td><td>${r.moneda||'ARS'}</td><td>${r.denominacion||''}</td><td>${r.servicio||''}</td>
          <td class="right">${r.peso||0}</td><td>${r.lat??''}</td><td>${r.lng??''}</td>
          <td><input type="checkbox" ${r.usar?'checked':''} data-act="usar" /></td>
          <td><button class="chip" data-act="edit">Editar</button></td>
          <td><button class="chip" data-act="del">Borrar</button></td>
        </tr>`).join('');
      [...tbody.querySelectorAll('input[data-act="usar"]')].forEach(inp=>{
        inp.addEventListener('change', (ev)=>{
          const id = ev.target.closest('tr').dataset.id;
          const o = State.ord.find(x=>x.id===id);
          if(o){
            o.usar = !!ev.target.checked;
            save(DB.ord, State.ord);
            const routeAPI = globalThis.Route;
            if(routeAPI && typeof routeAPI.refreshSources === 'function'){
              routeAPI.refreshSources();
            }
          }
        });
      });
      [...tbody.querySelectorAll('button[data-act="edit"]')].forEach(btn=>{
        btn.addEventListener('click', ()=> editRow(btn.closest('tr').dataset.id));
      });
      [...tbody.querySelectorAll('button[data-act="del"]')].forEach(btn=>{
        btn.addEventListener('click', ()=> delRow(btn.closest('tr').dataset.id));
      });
    }
    qEl?.addEventListener('input', render);

    function editRow(id){
      const o = State.ord.find(x=>x.id===id) || {id:uuid(), fecha:'', categoria:'', codigo:'', nombre:'', lat:'', lng:'', monto:0, moneda:'ARS', denominacion:'', servicio:'', peso:0, usar:false};
      const html = `
        <div class="field"><label>Fecha</label><input id="fFecha" type="date" value="${o.fecha||''}"></div>
        <div class="field"><label>Categoría</label><input id="fCat" value="${o.categoria||''}" placeholder="Sucursal/ATM/Cabecera/BCRA/Otro"></div>
        <div class="field"><label>Código</label><input id="fCod" value="${o.codigo||''}"></div>
        <div class="field"><label>Nombre</label><input id="fNom" value="${o.nombre||''}"></div>
        <div class="field"><label>Lat</label><input id="fLat" value="${o.lat??''}"></div>
        <div class="field"><label>Lng</label><input id="fLng" value="${o.lng??''}"></div>
        <div class="field"><label>Monto (negativo=entrega)</label><input id="fMonto" value="${o.monto??0}"></div>
        <div class="field"><label>Moneda</label><input id="fMon" value="${o.moneda||'ARS'}"></div>
        <div class="field"><label>Denominación</label><input id="fDen" value="${o.denominacion||''}"></div>
        <div class="field"><label>Servicio</label><input id="fServ" value="${o.servicio||''}" placeholder="Abastecimiento/Retiro/Transferencia/Descarga"></div>
        <div class="field"><label>Peso (kg)</label><input id="fPeso" value="${o.peso||0}"></div>
      `;
      openSmallModal('Editar orden', html, ()=>{
        Object.assign(o, {
          fecha: sel('#fFecha').value, categoria: sel('#fCat').value, codigo: sel('#fCod').value, nombre: sel('#fNom').value,
          lat: parseNumber(sel('#fLat').value), lng: parseNumber(sel('#fLng').value), monto: parseNumber(sel('#fMonto').value),
          moneda: sel('#fMon').value, denominacion: sel('#fDen').value, servicio: sel('#fServ').value, peso: parseNumber(sel('#fPeso').value)
        });
        if(!State.ord.find(x=>x.id===o.id)) State.ord.push(o);
        save(DB.ord, State.ord); render(); showToast('Orden guardada');
      });
    }
    function delRow(id){
      const i = State.ord.findIndex(x=>x.id===id); if(i<0) return;
      if(confirm('¿Eliminar orden?')){ State.ord.splice(i,1); save(DB.ord, State.ord); render(); }
    }

    // Botones
    document.getElementById('ordNew')?.addEventListener('click', ()=> editRow(null));
    document.getElementById('ordImport')?.addEventListener('click', ()=> document.getElementById('ordImportInput').click());
    document.getElementById('ordImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return; const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          fecha: headers.findIndex(h=>/fecha/i.test(h)),
          categoria: headers.findIndex(h=>/categoria/i.test(h)),
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          monto: headers.findIndex(h=>/monto/i.test(h)),
          moneda: headers.findIndex(h=>/moneda/i.test(h)),
          denominacion: headers.findIndex(h=>/denominacion/i.test(h)),
          servicio: headers.findIndex(h=>/servicio/i.test(h)),
          peso: headers.findIndex(h=>/peso/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h))
        };
        const out = rows.map(c => ({
          id: uuid(),
          fecha: c[idx.fecha]||'',
          categoria: c[idx.categoria]||'',
          codigo: c[idx.codigo]||'',
          nombre: c[idx.nombre]||'',
          monto: parseNumber(c[idx.monto]), moneda: c[idx.moneda]||'ARS', denominacion: c[idx.denominacion]||'',
          servicio: c[idx.servicio]||'', peso: parseNumber(c[idx.peso]),
          lat: parseNumber(c[idx.lat]), lng: parseNumber(c[idx.lng]), usar:false
        })).filter(o => o.categoria && isFinite(o.lat) && isFinite(o.lng));
        if(out.length){ State.ord = out; save(DB.ord, State.ord); render(); showToast('Órdenes importadas'); }
      };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('ordExport')?.addEventListener('click', ()=> csvExport(State.ord, ['id','fecha','categoria','codigo','nombre','monto','moneda','denominacion','servicio','peso','lat','lng','usar']));
    document.getElementById('ordTemplate')?.addEventListener('click', ()=>{
      const sample = [
        {fecha:'2025-08-23', categoria:'ATM', codigo:'50010', nombre:'Bahía Blanca', monto:-30000000, moneda:'ARS', denominacion:'$1000', servicio:'Abastecimiento', peso:20, lat:-38.715, lng:-62.268},
        {fecha:'2025-08-23', categoria:'Sucursal', codigo:'10003', nombre:'Mar del Plata', monto:45000000, moneda:'ARS', denominacion:'Mixta', servicio:'Retiro', peso:30, lat:-38.002, lng:-57.556}
      ];
      csvExport(sample, ['fecha','categoria','codigo','nombre','monto','moneda','denominacion','servicio','peso','lat','lng']);
    });

    render();
  })();

  /* =====================================================================
     UI: Modal pequeño reutilizable
  ===================================================================== */
  function openSmallModal(title, innerHTML, onAccept){
    const m = document.createElement('div'); m.className='modal open';
    m.innerHTML = `
      <div class="sheet" role="dialog" aria-modal="true">
        <div class="sheet-h"><div>${title||''}</div><button class="icon-btn small" id="mClose"><svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div>
        <div class="sheet-b" id="mBody" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">${innerHTML||''}</div>
        <div style="display:flex;gap:10px;justify-content:flex-end;padding:0 16px 12px">
          <button class="chip" id="mCancel">Cancelar</button>
          <button class="chip" id="mOk" style="background: linear-gradient(180deg, rgba(47,187,107,.24), rgba(47,187,107,.08)); border-color:rgba(47,187,107,.32)">Guardar</button>
        </div>
      </div>`;
    document.body.appendChild(m);
    const close = ()=>{ m.remove(); };
    m.addEventListener('click', (e)=>{ if(e.target===m) close(); });
    m.querySelector('#mClose').addEventListener('click', close);
    m.querySelector('#mCancel').addEventListener('click', close);
    m.querySelector('#mOk').addEventListener('click', ()=>{
      if(onAccept){
        const result = onAccept();
        if(result === false) return;
      }
      close();
    });
  }

  /* =====================================================================
     LOADER API (Camioncito)
  ===================================================================== */
  const Loader = (()=>{
    const modal = document.getElementById('loaderModal');
    const scene = document.getElementById('scene');
    const bar = document.getElementById('progressBar');
    const status = document.getElementById('loaderDesc');
    const closeBtn = document.getElementById('loaderClose');
    const CLOSE_READY_CLASS = 'is-ready';
    const MODAL_FAIL_CLASS = 'has-error';
    const SCENE_PAUSED_CLASS = 'is-paused';
    let failTimer = null;
    let timerId = null;
    closeBtn.addEventListener('click', hide);
    function open(msg){
      modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
      modal.classList.remove(MODAL_FAIL_CLASS);
      bar.style.inlineSize='0%'; status.textContent = msg || 'Optimizando…';
      scene.classList.remove(SCENE_PAUSED_CLASS);
      scene.classList.add('is-running');
      closeBtn.disabled = true;
      closeBtn.classList.remove(CLOSE_READY_CLASS);
      if(failTimer){ clearTimeout(failTimer); failTimer = null; }
      auto();
      return { setMessage, setProgress, finish, fail, close: hide };
    }
    function setMessage(t){ status.textContent = t; }
    function setProgress(p){ const v = clamp(p,0,100); bar.style.inlineSize=v+'%'; bar.parentElement.setAttribute('aria-valuenow', v); }
    function finish(t){ setProgress(100); setMessage(t||'Listo ✅'); setTimeout(hide, 500); }
    function fail(t){
      // Detenemos la animación y resaltamos el botón de cierre para guiar la recuperación del usuario.
      setMessage(t||'Ocurrió un error. Elegí una cabecera y volvé a intentar.');
      if(timerId !== null){ clearInterval(timerId); timerId = null; }
      stopAnimation();
      scene.classList.add(SCENE_PAUSED_CLASS);
      modal.classList.add(MODAL_FAIL_CLASS);
      closeBtn.disabled = false;
      closeBtn.classList.add(CLOSE_READY_CLASS);
      if(failTimer){ clearTimeout(failTimer); }
      failTimer = setTimeout(()=>{ closeBtn.focus(); failTimer = null; }, 180);
    }
    function hide(){
      if(timerId !== null){ clearInterval(timerId); timerId = null; }
      stopAnimation();
      scene.classList.remove(SCENE_PAUSED_CLASS);
      closeBtn.disabled = false;
      closeBtn.classList.remove(CLOSE_READY_CLASS);
      modal.classList.remove(MODAL_FAIL_CLASS);
      if(failTimer){ clearTimeout(failTimer); failTimer = null; }
      modal.classList.remove('open'); modal.setAttribute('aria-hidden','true');
    }
    function stopAnimation(){
      scene.classList.remove('is-running');
    }
    function auto(){ let v=0; if(timerId !== null){ clearInterval(timerId); } timerId=setInterval(()=>{ v = Math.min(v + (Math.random()*6+2), 95); setProgress(v); if(v>=95 && timerId !== null){ clearInterval(timerId); timerId = null; } }, 400); }
    return { open };
  })();

  /* =====================================================================
     RUTAS: Integración total
  ===================================================================== */
  const Route = (function(){
    let routeMap, routeMarkers = [], routeLines = [];
    let currentRoute = [[]]; // array de rutas (cada una lista de puntos {id, tipo, nombre, lat, lng, monto, servicio, priority})
    const UNDO_LIMIT = 50;
    let undoStack = [];

    const ptsTbody = document.getElementById('ptsTbody');
    const ptsQ = document.getElementById('ptsQ');
    const ptsCount = document.getElementById('ptsCount');
    const rutaTbody = document.getElementById('rutaTbody');
    const mapSk = document.getElementById('routeMapSkeleton');
    const mapEl = document.getElementById('routeMap');
    const selOrigen = document.getElementById('selOrigen');
    const selCamion = document.getElementById('selCamion');
    const prioAbast = document.getElementById('prioAbast');
    const prioDescAlta = document.getElementById('prioDescargaAlta');
    const nCamionesInput = document.getElementById('nCamiones');
    const btnOptimizar = document.getElementById('btnOptimizar');
    const btnExportar = document.getElementById('btnExportar');
    const ignoredPtsTbody = document.getElementById('ignoredPtsTbody');
    const ignoredPtsSummary = document.getElementById('ignoredPtsSummary');
    let missingOriginWarned = false;
    const ignoredRegistry = new Map();
    let lastMapIgnoredCount = 0;
    const lastSummary = { distKm: null };

    let lastSelectedCamion = null;

    function camionLabel(id){
      if(id === null || id === undefined) return '';
      const strId = String(id).trim();
      if(!strId) return '';
      const cam = State.cam.find(c => String(c.id) === strId);
      if(!cam){
        return strId;
      }
      const parts = [String(cam.id)];
      if(cam.modelo){ parts.push(String(cam.modelo)); }
      return parts.join(' — ');
    }

    function toCamionSnapshot(source){
      if(source === null || source === undefined) return null;
      const src = typeof source === 'string' ? { id: source } : source;
      if(!src || typeof src !== 'object') return null;
      const snapshot = {
        id: src.id !== undefined && src.id !== null ? String(src.id).trim() || null : null,
        modelo: src.modelo !== undefined && src.modelo !== null ? String(src.modelo).trim() || null : null,
        capMonto: null,
        capKg: null,
        velMax: null
      };
      const capMonto = parseNumber(src.capMonto);
      if(Number.isFinite(capMonto)){ snapshot.capMonto = capMonto; }
      const capKg = parseNumber(src.capKg);
      if(Number.isFinite(capKg)){ snapshot.capKg = capKg; }
      const velMax = parseNumber(src.velMax);
      if(Number.isFinite(velMax)){ snapshot.velMax = velMax; }
      if(snapshot.id || snapshot.modelo || snapshot.capMonto !== null || snapshot.capKg !== null || snapshot.velMax !== null){
        return snapshot;
      }
      return null;
    }

    function camionRefLabel(ref){
      const snap = toCamionSnapshot(ref);
      if(!snap) return '';
      const id = snap.id || '';
      const modelo = snap.modelo || '';
      if(id){
        const fromState = camionLabel(id);
        const trimmed = fromState ? fromState.trim() : '';
        if(trimmed && trimmed !== id){
          return trimmed;
        }
        if(modelo){
          return `${id} — ${modelo}`;
        }
        return id;
      }
      return modelo;
    }

    function snapshotToDataset(opt, src){
      const snap = toCamionSnapshot(src);
      if(!opt) return;
      if(snap){
        try{
          opt.dataset.snapshot = JSON.stringify(snap);
        }catch{
          delete opt.dataset.snapshot;
        }
      }else{
        delete opt.dataset.snapshot;
      }
    }

    function optionSnapshot(opt){
      if(!opt) return null;
      const raw = opt.dataset?.snapshot;
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch{return null;}
    }

    function ensureCamionOption(id, label, snapshot){
      if(!selCamion) return;
      const strId = String(id ?? '').trim();
      if(!strId) return;
      const exists = Array.from(selCamion.options || []).some(opt => opt.value === strId);
      if(exists) return;
      const opt = document.createElement('option');
      opt.value = strId;
      const lbl = label && String(label).trim() ? String(label).trim() : camionLabel(strId);
      opt.textContent = lbl || strId;
      opt.dataset.extra = '1';
      if(snapshot){ snapshotToDataset(opt, snapshot); }
      selCamion.appendChild(opt);
    }

    function populateCamionSelect(){
      if(!selCamion) return;
      const prev = selCamion.value;
      const prevOpt = selCamion.options && selCamion.selectedIndex >= 0
        ? selCamion.options[selCamion.selectedIndex]
        : null;
      const prevLabel = prevOpt?.textContent || '';
      const prevSnapshot = optionSnapshot(prevOpt) || lastSelectedCamion;
      selCamion.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = '—';
      selCamion.appendChild(placeholder);
      const camiones = State.cam.filter(cam => cam && cam.id);
      camiones.forEach(cam => {
        const opt = document.createElement('option');
        const id = String(cam.id);
        opt.value = id;
        opt.textContent = camionLabel(id);
        snapshotToDataset(opt, cam);
        selCamion.appendChild(opt);
      });
      let applied = false;
      if(prev && camiones.some(cam => String(cam.id) === prev)){
        selCamion.value = prev;
        applied = true;
      }else if(camiones.length === 1){
        selCamion.value = String(camiones[0].id);
        applied = true;
      }else{
        selCamion.value = '';
      }
      if(!applied && prev){
        ensureCamionOption(prev, prevLabel, prevSnapshot);
        selCamion.value = prev;
      }
    }

    function configureCfgWithTruck(camion){
      if(!camion){
        lastSelectedCamion = null;
        return null;
      }
      const snapshot = toCamionSnapshot(camion);
      if(!snapshot){
        lastSelectedCamion = null;
        return null;
      }
      let changed = false;
      const maxMontoInput = document.getElementById('cfgMaxMonto');
      const velInput = document.getElementById('cfgVel');
      const capMonto = snapshot.capMonto;
      if(Number.isFinite(capMonto) && capMonto > 0){
        if(cfg.maxMonto !== capMonto){
          cfg.maxMonto = capMonto;
          changed = true;
        }
        if(maxMontoInput){ maxMontoInput.value = String(capMonto); }
      }
      const capKg = snapshot.capKg;
      if(Number.isFinite(capKg) && capKg > 0){
        if(cfg.maxKg !== capKg){
          cfg.maxKg = capKg;
          changed = true;
        }
      }
      const velMax = snapshot.velMax;
      if(Number.isFinite(velMax) && velMax > 0){
        if(cfg.vel !== velMax){
          cfg.vel = velMax;
          changed = true;
        }
        if(velInput){ velInput.value = String(velMax); }
      }
      if(changed){
        save(DB.cfg, cfg);
        updateSummary();
      }
      lastSelectedCamion = snapshot;
      return snapshot;
    }

    populateCamionSelect();
    document.addEventListener('data:updated', (ev)=>{
      const scope = ev?.detail?.scope;
      if(!scope || scope === 'camiones'){
        const prev = selCamion?.value || '';
        populateCamionSelect();
        const current = selCamion?.value || '';
        if(selCamion && current && (current === prev || !prev)){
          selCamion.dispatchEvent(new Event('change'));
        }
      }
    });

    function clearIgnoredScope(scope){
      for(const [key, entry] of [...ignoredRegistry.entries()]){
        if(entry.scope === scope){ ignoredRegistry.delete(key); }
      }
    }
    function ignoredKey(scope, id){
      const suffix = id ? String(id) : Math.random().toString(36).slice(2);
      return `${scope}:${suffix}`;
    }
    function noteIgnored(scope, id, info){
      if(!ignoredPtsTbody) return;
      const key = ignoredKey(scope, id);
      ignoredRegistry.set(key, { scope, ...info });
    }
    function getIgnored(scope){
      return scope
        ? Array.from(ignoredRegistry.values()).filter(entry => entry.scope === scope)
        : Array.from(ignoredRegistry.values());
    }
    function renderIgnoredPoints(){
      if(!ignoredPtsTbody) return;
      const items = getIgnored();
      if(!items.length){
        ignoredPtsTbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted-text);font-style:italic;">Sin incidencias</td></tr>';
        if(ignoredPtsSummary){ ignoredPtsSummary.textContent = 'Sin incidencias'; }
        return;
      }
      items.sort((a,b)=>{
        const srcA = (a.fuente||'').localeCompare(b.fuente||'');
        if(srcA !== 0) return srcA;
        return (a.nombre||'').localeCompare(b.nombre||'');
      });
      ignoredPtsTbody.innerHTML = items.map(item => `
        <tr>
          <td>${item.fuente||'—'}</td>
          <td>${[(item.codigo||'').trim(), (item.nombre||'').trim()].filter(Boolean).join(' — ') || '—'}</td>
          <td class="right">${fmtCoord(item.lat)}</td>
          <td class="right">${fmtCoord(item.lng)}</td>
          <td>${item.reason||'—'}</td>
        </tr>
      `).join('');
      if(ignoredPtsSummary){
        const count = items.length;
        const label = count === 1 ? '1 punto ignorado' : `${count} puntos ignorados`;
        ignoredPtsSummary.textContent = label;
      }
    }

    function cloneRoutes(routes = currentRoute){
      return routes.map(route => route.map(p => ({...p})));
    }
    function pushUndoEntry(entry){
      if(!entry) return;
      undoStack.push(entry);
      if(undoStack.length > UNDO_LIMIT){
        undoStack.shift();
      }
    }
    function createSnapshot(){
      return { type: 'snapshot', state: cloneRoutes() };
    }
    function clonePoint(point){
      return point ? ({ ...point }) : null;
    }
    function ensureRouteIndex(idx){
      if(!Number.isInteger(idx) || idx < 0) return;
      ensureBaseRoute();
      while(currentRoute.length <= idx){
        currentRoute.push([]);
      }
    }
    function applyUndo(entry){
      if(!entry) return false;
      switch(entry.type){
        case 'snapshot':
          currentRoute = cloneRoutes(entry.state);
          return true;
        case 'remove-point':{
          const route = currentRoute[entry.routeIdx];
          if(!route) return false;
          if(entry.index < 0 || entry.index >= route.length) return false;
          route.splice(entry.index, 1);
          return true;
        }
        case 'insert-point':{
          if(!entry.point) return false;
          ensureRouteIndex(entry.routeIdx);
          const route = currentRoute[entry.routeIdx];
          if(!route) return false;
          const idx = Math.max(0, Math.min(entry.index, route.length));
          const pointCopy = clonePoint(entry.point);
          if(!pointCopy) return false;
          route.splice(idx, 0, pointCopy);
          return true;
        }
        case 'toggle-priority':{
          const route = currentRoute[entry.routeIdx];
          if(!route) return false;
          const point = route[entry.index];
          if(!point) return false;
          route[entry.index] = { ...point, priority: !point.priority };
          return true;
        }
        case 'move-point':{
          if(!entry.to || !entry.from) return false;
          const toRoute = currentRoute[entry.to.route];
          const fromRoute = currentRoute[entry.from.route];
          if(!toRoute || !fromRoute) return false;
          if(entry.to.index < 0 || entry.to.index >= toRoute.length) return false;
          const point = toRoute[entry.to.index];
          if(!point) return false;
          toRoute.splice(entry.to.index, 1);
          const insertIndex = Math.max(0, Math.min(entry.from.index, fromRoute.length));
          fromRoute.splice(insertIndex, 0, point);
          return true;
        }
        default:
          return false;
      }
    }
    function flattenRoutes(routes = currentRoute){
      return routes.reduce((acc, route)=> acc.concat(route), []);
    }
    function getLatLngCoords(item){
      if(!item) return null;
      const lat = parseNumber(item.lat);
      const lng = parseNumber(item.lng);
      if(Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
      return null;
    }
    function ensureBaseRoute(){
      if(!currentRoute.length){ currentRoute = [[]]; }
    }

    // render listado de puntos disponibles (suc + atms + otros + cab + órdenes marcadas "usar")
    function buildSourceRows(){
      clearIgnoredScope('source');
      const rows = [];
      const addItems = (items, cfg)=>{
        items.forEach(item => {
          const lat = parseNumber(item.lat);
          const lng = parseNumber(item.lng);
          if(Number.isFinite(lat) && Number.isFinite(lng)){
            const point = cfg.toPoint ? cfg.toPoint(item, lat, lng) : null;
            if(point){ rows.push(point); }
          }else{
            noteIgnored('source', `${cfg.prefix||'item'}:${cfg.id ? cfg.id(item) : (item.id||item.codigo||item.nombre||'')}`, {
              fuente: cfg.fuente || 'Datos',
              tipo: typeof cfg.tipo === 'function' ? cfg.tipo(item) : (cfg.tipo || ''),
              codigo: typeof cfg.codigo === 'function' ? cfg.codigo(item) : (item.codigo || ''),
              nombre: typeof cfg.nombre === 'function' ? cfg.nombre(item) : (item.nombre || ''),
              lat: item.lat,
              lng: item.lng,
              reason: cfg.reason || 'Coordenadas inválidas'
            });
          }
        });
      };
      const ords = State.ord.filter(o=>o.usar);
      addItems(ords, {
        prefix:'orden',
        fuente:'Órdenes',
        tipo:o=>o.categoria||'Orden',
        id:o=>o.id||o.codigo||o.nombre||uuid(),
        codigo:o=>o.codigo||'',
        nombre:o=>o.nombre||'',
        toPoint:(o,lat,lng)=> ({tipo:o.categoria, codigo:o.codigo, nombre:o.nombre, lat, lng, monto:o.monto, servicio:o.servicio, id:o.id})
      });
      addItems(State.suc, {
        prefix:'sucursal',
        fuente:'Sucursales',
        tipo:()=> 'Sucursal',
        id:s=>s.codigo||uuid(),
        toPoint:(s,lat,lng)=> ({tipo:'Sucursal', codigo:s.codigo, nombre:s.nombre, lat, lng, monto:0, servicio:'', id:'SUC:'+s.codigo})
      });
      addItems(State.atms, {
        prefix:'atm',
        fuente:'ATMs',
        tipo:()=> 'ATM',
        id:a=>a.codigo||uuid(),
        toPoint:(a,lat,lng)=> ({tipo:'ATM', codigo:a.codigo, nombre:a.nombre, lat, lng, monto:0, servicio:'', id:'ATM:'+a.codigo})
      });
      addItems(State.otros, {
        prefix:'otro',
        fuente:'Otros bancos',
        tipo:()=> 'Otros',
        id:o=>o.codigo||uuid(),
        toPoint:(o,lat,lng)=> ({tipo:'Otros', codigo:o.codigo, nombre:o.nombre, lat, lng, monto:0, servicio:'', id:'OTR:'+o.codigo})
      });
      State.cab.forEach(c=>{
        const lat = parseNumber(c.lat);
        const lng = parseNumber(c.lng);
        if(!Number.isFinite(lat) || !Number.isFinite(lng)){
          noteIgnored('source', `cabecera:${c.codigo||c.nombre||uuid()}`, {
            fuente:'Cabeceras',
            tipo:'Cabecera',
            codigo:c.codigo||'',
            nombre:c.nombre||'',
            lat:c.lat,
            lng:c.lng,
            reason:'Cabecera sin coordenadas válidas'
          });
        }
      });
      return rows; // cabeceras no se mezclan aquí (van como origen)
    }

    function renderPts(){
      const unusableOrders = State.ord.filter(o => o.usar && (!Number.isFinite(parseNumber(o.lat)) || !Number.isFinite(parseNumber(o.lng))));
      if(unusableOrders.length){
        if(renderPts._lastWarnedMissing !== unusableOrders.length){
          const isSingular = unusableOrders.length === 1;
          const label = isSingular ? 'orden' : 'órdenes';
          const verb = isSingular ? 'fue' : 'fueron';
          const suffix = isSingular ? '' : 's';
          showToast(`${unusableOrders.length} ${label} marcada${suffix} "usar" sin coordenadas ${verb} omitida${suffix}`);
        }
      }
      renderPts._lastWarnedMissing = unusableOrders.length;
      const arr = buildSourceRows();
      const q = (ptsQ.value||'').toLowerCase();
      const filtered = arr.filter(r=> !q || (r.codigo||'').toLowerCase().includes(q) || (r.nombre||'').toLowerCase().includes(q) || (r.tipo||'').toLowerCase().includes(q));
      ptsCount.textContent = filtered.length;
      ptsTbody.innerHTML = filtered.map(r => `
        <tr data-id="${r.id}">
          <td>${r.tipo}</td>
          <td>${(r.codigo||'')+' — '+(r.nombre||'')}</td>
          <td class="right">${fmtCoord(r.lat)}</td>
          <td class="right">${fmtCoord(r.lng)}</td>
          <td class="right">${r.monto? fmtMoney(r.monto): ''}</td>
          <td>${r.servicio||''}</td>
          <td><input type="checkbox" data-act="prio"></td>
          <td><button class="chip" data-act="add">Agregar</button></td>
        </tr>
      `).join('');
      [...ptsTbody.querySelectorAll('button[data-act="add"]')].forEach(b=> b.addEventListener('click', ()=>{
        const id = b.closest('tr').dataset.id;
        const src = buildSourceRows().find(x=>x.id===id); if(!src) return;
        addPointToRoute(src, b.closest('tr').querySelector('input[data-act="prio"]')?.checked);
      }));
      renderIgnoredPoints();
    }
    function refreshSources(){
      renderPts();
    }
    ptsQ?.addEventListener('input', renderPts);
    document.addEventListener('data:updated', ()=> refreshSources());
    document.getElementById('addFromOrdenes')?.addEventListener('click', ()=>{
      State.ord.filter(o=>o.usar).forEach(o => {
        const coords = getLatLngCoords(o);
        if(!coords){ return; }
        addPointToRoute({id:o.id, tipo:o.categoria, codigo:o.codigo, nombre:o.nombre, lat:coords.lat, lng:coords.lng, monto:o.monto, servicio:o.servicio}, false);
      });
      renderIgnoredPoints();
    });

    function addPointToRoute(p, priority=false){
      ensureBaseRoute();
      let target = currentRoute.findIndex(route => route.length===0);
      if(target<0){
        let bestScore = Infinity;
        currentRoute.forEach((route, idx)=>{
          const carga = route.reduce((acc, item)=> acc + Math.max(0, Number(item.monto)||0), 0);
          const score = route.length*1e6 + carga;
          if(score < bestScore){ bestScore = score; target = idx; }
        });
        if(target<0) target = 0;
      }
      ensureRouteIndex(target);
      const route = currentRoute[target];
      if(!route) return;
      const insertionIndex = route.length;
      pushUndoEntry({ type: 'remove-point', routeIdx: target, index: insertionIndex });
      route.push({ ...p, priority: !!priority });
      draw();
    }
    function removeAt(routeIdx, pointIdx){
      if(routeIdx<0 || routeIdx>=currentRoute.length) return;
      const route = currentRoute[routeIdx];
      if(!route) return;
      if(pointIdx<0 || pointIdx>=route.length) return;
      const point = route[pointIdx];
      if(!point) return;
      const totalPointsBefore = flattenRoutes().length;
      if(totalPointsBefore <= 0) return;
      if(totalPointsBefore === 1 && currentRoute.length > 1){
        pushUndoEntry(createSnapshot());
      }else{
        pushUndoEntry({ type: 'insert-point', routeIdx, index: pointIdx, point: clonePoint(point) });
      }
      route.splice(pointIdx,1);
      if(totalPointsBefore === 1){ currentRoute = [[]]; }
      draw();
    }
    function movePoint(from, to){
      if(!from || !to) return;
      const fromRouteIdx = Number(from.route);
      const fromIdx = Number(from.index);
      const toRouteIdx = Number(to.route);
      const toIdx = Number(to.index);
      if(!Number.isInteger(fromRouteIdx) || !Number.isInteger(fromIdx) || !Number.isInteger(toRouteIdx) || !Number.isInteger(toIdx)){
        return;
      }
      if(fromRouteIdx < 0 || fromRouteIdx >= currentRoute.length) return;
      if(toRouteIdx < 0 || toRouteIdx >= currentRoute.length) return;
      const fromRoute = currentRoute[fromRouteIdx];
      const toRoute = currentRoute[toRouteIdx];
      if(!fromRoute || !toRoute) return;
      if(fromIdx < 0 || fromIdx >= fromRoute.length) return;
      if(fromRouteIdx === toRouteIdx && fromIdx === toIdx) return;
      const point = fromRoute[fromIdx];
      if(!point) return;
      const movingPoint = fromRoute.splice(fromIdx, 1)[0];
      let targetIndex = toIdx;
      const maxIndex = toRoute.length;
      if(fromRouteIdx === toRouteIdx){
        if(targetIndex > fromIdx){
          targetIndex = Math.min(targetIndex, maxIndex);
        }else{
          targetIndex = Math.max(0, Math.min(targetIndex, maxIndex));
        }
      }else{
        targetIndex = Math.max(0, Math.min(targetIndex, maxIndex));
      }
      pushUndoEntry({
        type: 'move-point',
        from: { route: fromRouteIdx, index: fromIdx },
        to: { route: toRouteIdx, index: targetIndex }
      });
      toRoute.splice(targetIndex, 0, movingPoint);
      draw();
    }
    function togglePriority(routeIdx, pointIdx){
      if(routeIdx<0 || routeIdx>=currentRoute.length) return;
      const route = currentRoute[routeIdx];
      if(!route) return;
      if(pointIdx<0 || pointIdx>=route.length) return;
      const point = route[pointIdx];
      if(!point) return;
      pushUndoEntry({ type: 'toggle-priority', routeIdx, index: pointIdx });
      route[pointIdx] = { ...point, priority: !point.priority };
      draw();
    }
    document.getElementById('btnDeshacer')?.addEventListener('click', ()=>{
      const action = undoStack.pop();
      if(action && applyUndo(action)){
        draw();
      }
    });
    document.getElementById('btnLimpiarRuta')?.addEventListener('click', ()=>{
      if(!confirm('¿Eliminar todas las paradas?')) return;
      pushUndoEntry(createSnapshot());
      currentRoute = [[]];
      draw();
    });

    function stopTimeFor(tipo){
      if(/^suc/i.test(tipo||'')) return cfg.stopSuc||5;
      if(/^atm/i.test(tipo||'')) return cfg.stopATM||15;
      if(/^cab/i.test(tipo||'')) return cfg.stopCab||10;
      return cfg.stopExt||20;
    }

    function draw(){
      ensureBaseRoute();
      const multipleRoutes = currentRoute.length > 1;
      const rows = [];
      let globalIdx = 0;
      currentRoute.forEach((route, rIdx)=>{
        const label = `Camión ${rIdx+1}`;
        if(multipleRoutes){
          rows.push(`<tr class="route-header"><td colspan="7"><strong>${label}</strong>${route.length? '': ' — sin paradas'}</td></tr>`);
        }
        if(route.length){
          route.forEach((r,i)=>{
            globalIdx++;
            const canMoveUp = i > 0;
            const canMoveDown = i < route.length - 1;
            const priorityMark = r.priority ? ' <span class="priority">★</span>' : '';
            const priorityButton = `<button type="button" class="chip icon prio-toggle${r.priority ? ' active' : ''}" data-route="${rIdx}" data-i="${i}" data-act="prio" aria-pressed="${r.priority ? 'true' : 'false'}" title="${r.priority ? 'Quitar prioridad manual' : 'Priorizar parada'}">${r.priority ? '★' : '☆'}</button>`;
            rows.push([
              '<tr>',
                `<td><span class="order-num">${globalIdx}</span></td>`,
                `<td>${r.tipo||''}</td>`,
                `<td>${r.nombre||''}</td>`,
                `<td class="right">${r.monto?fmtMoney(r.monto):''}</td>`,
                `<td>${r.servicio||''}${priorityMark}</td>`,
                `<td>${priorityButton}</td>`,
                '<td>',
                  '<div class="route-actions">',
                    `<button type="button" class="chip icon" data-route="${rIdx}" data-i="${i}" data-act="up"${canMoveUp ? '' : ' disabled'} title="Subir">↑</button>`,
                    `<button type="button" class="chip icon" data-route="${rIdx}" data-i="${i}" data-act="down"${canMoveDown ? '' : ' disabled'} title="Bajar">↓</button>`,
                    `<button type="button" class="chip" data-route="${rIdx}" data-i="${i}" data-act="rm">Quitar</button>`,
                  '</div>',
                '</td>',
              '</tr>'
            ].join(''));
          });
        }else if(multipleRoutes){
          rows.push(`<tr><td colspan="7" style="color:var(--muted-text);font-style:italic;">Sin paradas asignadas</td></tr>`);
        }
      });
      if(!rows.length){
        rows.push(`<tr><td colspan="7" style="color:var(--muted-text);font-style:italic;">Sin paradas</td></tr>`);
      }
      rutaTbody.innerHTML = rows.join('');
      [...rutaTbody.querySelectorAll('button[data-act="rm"]')].forEach(b=>{
        const routeIdx = parseInt(b.dataset.route, 10);
        const pointIdx = parseInt(b.dataset.i, 10);
        removeAt(routeIdx, pointIdx);
      });
      [...rutaTbody.querySelectorAll('button[data-act="up"]')].forEach(b=>{
        b.addEventListener('click', ()=>{
          if(b.disabled) return;
          const routeIdx = parseInt(b.dataset.route, 10);
          const pointIdx = parseInt(b.dataset.i, 10);
          movePoint({ route: routeIdx, index: pointIdx }, { route: routeIdx, index: pointIdx - 1 });
        });
      });
      [...rutaTbody.querySelectorAll('button[data-act="down"]')].forEach(b=>{
        b.addEventListener('click', ()=>{
          if(b.disabled) return;
          const routeIdx = parseInt(b.dataset.route, 10);
          const pointIdx = parseInt(b.dataset.i, 10);
          movePoint({ route: routeIdx, index: pointIdx }, { route: routeIdx, index: pointIdx + 1 });
        });
      });
      [...rutaTbody.querySelectorAll('button[data-act="prio"]')].forEach(b=>{
        b.addEventListener('click', ()=>{
          const routeIdx = parseInt(b.dataset.route, 10);
          const pointIdx = parseInt(b.dataset.i, 10);
          togglePriority(routeIdx, pointIdx);
        });
      });
      updateSummary();

      // mapa
      waitForLeaflet().then(()=>{
        clearIgnoredScope('map');
        if(!routeMap){
          mapSk.classList.add('hidden'); mapEl.classList.remove('hidden');
          routeMap = L.map('routeMap', { zoomControl:true, minZoom:3 });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(routeMap);
          routeMap.setView([-34.60,-58.38], 9);
        }
        routeMarkers.forEach(m=> m.remove()); routeMarkers=[];
        routeLines.forEach(l=> l.remove()); routeLines=[];
        const origenCodigo = selOrigen.value;
        const origen = State.cab.find(c=>c.codigo===origenCodigo);
        const bounds = [];
        const palette = ['var(--route-a)','var(--route-b)','var(--route-c)','#f39c12','#8e44ad','#16a085','#34495e'];
        const originCoords = getLatLngCoords(origen);
        if(origen && originCoords){
          const m = L.marker([originCoords.lat, originCoords.lng], { title:'Origen: '+origen.nombre });
          m.addTo(routeMap); routeMarkers.push(m); bounds.push(m.getLatLng());
        }else if(origen){
          noteIgnored('map', `cabecera:${origen.codigo||origen.nombre||uuid()}`, {
            fuente:'Cabecera seleccionada',
            tipo:'Cabecera',
            codigo:origen.codigo||'',
            nombre:origen.nombre||'',
            lat:origen.lat,
            lng:origen.lng,
            reason:'Cabecera sin coordenadas válidas'
          });
        }
        let seq = 0;
        currentRoute.forEach((route, rIdx)=>{
          const color = palette[rIdx % palette.length];
          const validCoords = [];
          route.forEach((p)=>{
            seq++;
            const coords = getLatLngCoords(p);
            if(!coords){
              noteIgnored('map', `ruta:${p.id||p.codigo||p.nombre||seq}`, {
                fuente:'Ruta actual',
                tipo:p.tipo||'Punto',
                codigo:p.codigo||'',
                nombre:p.nombre||'',
                lat:p.lat,
                lng:p.lng,
                reason:'Coordenadas inválidas en el mapa'
              });
              return;
            }
            const divIcon = L.divIcon({className:'', html:`<div style="display:grid;place-items:center;width:30px;height:30px;border-radius:10px;background:#fff;border:2px solid ${color}; font:800 12px/1 Inter,sans-serif;color:var(--ink-800);">${seq}</div>`, iconSize:[30,30], iconAnchor:[15,15]});
            const m = L.marker([coords.lat, coords.lng], {icon:divIcon, title: `${labelForRoute(rIdx)} · ${seq}. ${p.tipo} — ${p.nombre}`});
            m.addTo(routeMap); routeMarkers.push(m); bounds.push(m.getLatLng());
            validCoords.push(coords);
          });
          if(originCoords && validCoords.length){
            const coords = [[originCoords.lat, originCoords.lng], ...validCoords.map(c=>[c.lat, c.lng]), [originCoords.lat, originCoords.lng]];
            const l = L.polyline(coords, { color, weight:4, opacity:.9 });
            l.addTo(routeMap); routeLines.push(l);
          }
        });
        if(bounds.length) routeMap.fitBounds(L.latLngBounds(bounds), {padding:[20,20]});
        renderIgnoredPoints();
        const mapIgnoredCount = getIgnored('map').length;
        if(mapIgnoredCount && mapIgnoredCount !== lastMapIgnoredCount){
          const label = mapIgnoredCount === 1 ? '1 punto se omitió en el mapa por coordenadas inválidas' : `${mapIgnoredCount} puntos se omitieron en el mapa por coordenadas inválidas`;
          showToast(label);
        }
        lastMapIgnoredCount = mapIgnoredCount;
        updateSummary();
      });
    }

    selOrigen?.addEventListener('change', draw);
    selCamion?.addEventListener('change', ()=>{
      const camionId = (selCamion.value || '').trim();
      if(!camionId){
        lastSelectedCamion = null;
        return;
      }
      const camion = State.cam.find(c => String(c.id) === camionId);
      if(camion){
        configureCfgWithTruck(camion);
        return;
      }
      const opt = selCamion.options?.[selCamion.selectedIndex] || null;
      const snap = optionSnapshot(opt) || toCamionSnapshot({ id: camionId });
      if(snap){ configureCfgWithTruck(snap); }
    });
    if(selCamion && selCamion.value){
      selCamion.dispatchEvent(new Event('change'));
    }

    function labelForRoute(idx){
      return `Camión ${idx+1}`;
    }

    const defaultOptimizeTip = btnOptimizar?.dataset?.tip || 'Optimizar (A* + 2-opt)';

    function updateSummary(){
      const totalPoints = flattenRoutes().length;
      document.getElementById('sumPuntos').textContent = totalPoints;
      const selectedTrucks = parseInt(nCamionesInput?.value, 10) || 1;
      const usedTrucks = currentRoute.filter(route => route.length>0).length;
      document.getElementById('sumCamiones').textContent = Math.max(selectedTrucks, usedTrucks || (totalPoints?1:0));
      const sumMontoEl = document.getElementById('sumMonto');
      const sumTiempoEl = document.getElementById('sumTiempo');
      const sumPesoEl = document.getElementById('sumPeso');
      const sumDistEl = document.getElementById('sumDistKm');
      const sumMontoCard = sumMontoEl?.closest('.kv') || null;
      const sumTiempoCard = sumTiempoEl?.closest('.kv') || null;
      const sumPesoCard = sumPesoEl?.closest('.kv') || null;
      const summaryEl = document.getElementById('routeSummary');
      const origen = State.cab.find(c=>c.codigo===selOrigen.value);
      const originCoords = getLatLngCoords(origen);
      const hasOrigen = Boolean(originCoords);

      if(btnExportar){ btnExportar.disabled = !hasOrigen; }

      if(!hasOrigen){
        if(sumMontoEl){
          sumMontoEl.textContent = '—';
          sumMontoEl.removeAttribute('title');
        }
        if(sumTiempoEl){
          sumTiempoEl.textContent = '—';
          sumTiempoEl.removeAttribute('title');
        }
        if(sumPesoEl){
          sumPesoEl.textContent = '—';
          sumPesoEl.removeAttribute('title');
        }
        if(sumDistEl){
          sumDistEl.textContent = '—';
          sumDistEl.removeAttribute('title');
        }
        setMetricLevel('monto','ok', sumMontoCard);
        setMetricLevel('tiempo','ok', sumTiempoCard);
        setMetricLevel('peso','ok', sumPesoCard);
        if(btnOptimizar){
          btnOptimizar.disabled = true;
          btnOptimizar.dataset.tip = 'Seleccioná una cabecera con coordenadas válidas';
        }
        summaryEl?.classList.remove('alert');
        if(totalPoints>0){
          if(!missingOriginWarned){
            showToast('Seleccioná una cabecera para calcular tiempos y montos');
            missingOriginWarned = true;
          }
        }else{
          missingOriginWarned = false;
        }
        lastSummary.distKm = null;
        return;
      }

      missingOriginWarned = false;

      let maxMonto = 0;
      let totalTiempo = 0;
      let totalDistKm = 0;
      let totalPeso = 0;
      let maxPeso = 0;
      currentRoute.forEach(route=>{
        let carga = 0;
        let maxCargaRuta = 0;
        let minRuta = 0;
        let distKmRuta = 0;
        let cargaPeso = 0;
        let maxCargaPesoRuta = 0;
        let last = originCoords ? {...originCoords} : null;
        route.forEach(p=>{
          const coords = getLatLngCoords(p);
          if(last && coords){ distKmRuta += haversine(last.lat,last.lng,coords.lat,coords.lng); }
          minRuta += stopTimeFor(p.tipo);
          const monto = Number(p.monto) || 0;
          carga += monto < 0 ? 0 : monto;
          maxCargaRuta = Math.max(maxCargaRuta, carga);
          const peso = parseNumber(p.peso);
          if(Number.isFinite(peso)){
            totalPeso += peso;
            if(peso >= 0){
              cargaPeso += peso;
            }else{
              cargaPeso = Math.max(0, cargaPeso + peso);
            }
            maxCargaPesoRuta = Math.max(maxCargaPesoRuta, cargaPeso);
          }
          if(coords){ last = coords; }
        });
        if(originCoords && route.length && last){
          distKmRuta += haversine(last.lat,last.lng, originCoords.lat, originCoords.lng);
        }
        const tiempoTraslado = distKmRuta / (cfg.vel||40) * 60 * (cfg.trafficFactor||1);
        totalTiempo += minRuta + tiempoTraslado;
        maxMonto = Math.max(maxMonto, maxCargaRuta);
        totalDistKm += distKmRuta;
        maxPeso = Math.max(maxPeso, maxCargaPesoRuta);
      });
      lastSummary.distKm = Number.isFinite(totalDistKm) ? totalDistKm : null;
      if(sumDistEl){
        const distKm = Number.isFinite(totalDistKm) ? Math.round(totalDistKm * 10) / 10 : null;
        if(distKm !== null){
          sumDistEl.textContent = fmtES.format(distKm);
        }else{
          sumDistEl.textContent = '—';
        }
        if(Number.isFinite(totalDistKm) && totalDistKm > 0){
          sumDistEl.setAttribute('title', `${totalDistKm.toLocaleString('es-AR', { maximumFractionDigits: 2 })} km totales`);
        }else{
          sumDistEl.removeAttribute('title');
        }
      }
      const totalMin = Math.round(totalTiempo);
      if(sumMontoEl){
        sumMontoEl.textContent = fmtMoney(maxMonto);
      }
      if(sumTiempoEl){
        sumTiempoEl.textContent = fmtMinutes(totalMin);
      }
      if(sumPesoEl){
        sumPesoEl.textContent = fmtKg(totalPeso);
      }
      const maxPermitido = Number(cfg.maxMonto);
      const tieneLimite = Number.isFinite(maxPermitido) && maxPermitido > 0;
      const excedido = tieneLimite && maxMonto > maxPermitido + 1e-6;
      const maxMinPermitido = Number(cfg.maxMin);
      const tieneLimiteTiempo = Number.isFinite(maxMinPermitido) && maxMinPermitido > 0;
      const excedeTiempo = tieneLimiteTiempo && totalMin > maxMinPermitido + 1e-6;
      const maxKgPermitido = Number(cfg.maxKg);
      const tieneLimiteKg = Number.isFinite(maxKgPermitido) && maxKgPermitido > 0;
      const excedePeso = tieneLimiteKg && maxPeso > maxKgPermitido + 1e-6;
      const montoRatio = tieneLimite && maxPermitido > 0 ? maxMonto / maxPermitido : NaN;
      const tiempoRatio = tieneLimiteTiempo && maxMinPermitido > 0 ? totalMin / maxMinPermitido : NaN;
      const pesoRatio = tieneLimiteKg && maxKgPermitido > 0 && Number.isFinite(maxPeso) ? maxPeso / maxKgPermitido : NaN;

      const montoLevel = excedido ? 'danger' : (Number.isFinite(montoRatio) && montoRatio >= WARN_THRESHOLD ? 'warning' : 'ok');
      const tiempoLevel = excedeTiempo ? 'danger' : (Number.isFinite(tiempoRatio) && tiempoRatio >= WARN_THRESHOLD ? 'warning' : 'ok');
      const pesoLevel = excedePeso ? 'danger' : (Number.isFinite(pesoRatio) && pesoRatio >= WARN_THRESHOLD ? 'warning' : 'ok');

      setMetricLevel('monto', montoLevel, sumMontoCard, 'El pico de monto supera el límite configurado.');
      setMetricLevel('tiempo', tiempoLevel, sumTiempoCard, 'El tiempo estimado supera el máximo configurado.');
      setMetricLevel('peso', pesoLevel, sumPesoCard, 'La carga supera la capacidad configurada.');

      if(summaryEl){
        summaryEl.classList.toggle('alert', montoLevel === 'danger' || tiempoLevel === 'danger' || pesoLevel === 'danger');
      }
      if(sumMontoEl){
        const ratioPct = Number.isFinite(montoRatio) ? (montoRatio * 100) : NaN;
        const pctStr = Number.isFinite(ratioPct) ? `${ratioPct.toLocaleString('es-AR', { maximumFractionDigits: 1 })}%` : '—';
        if(tieneLimite){
          if(excedido){
            sumMontoEl.setAttribute('title', `Supera el límite configurado (${fmtMoney(maxPermitido)}). Pico actual: ${fmtMoney(maxMonto)}. El indicador se marca en rojo al excederlo.`);
          }else{
            sumMontoEl.setAttribute('title', `Límite configurado: ${fmtMoney(maxPermitido)}. Pico actual: ${fmtMoney(maxMonto)} (${pctStr} del límite). Se marca en naranja desde el ${WARN_PERCENT_LABEL}% y en rojo al superarlo.`);
          }
        }else{
          sumMontoEl.setAttribute('title', `Pico actual: ${fmtMoney(maxMonto)}. Configurá un límite de monto máximo para activar alertas.`);
        }
      }
      if(sumTiempoEl){
        const ratioPct = Number.isFinite(tiempoRatio) ? (tiempoRatio * 100) : NaN;
        const pctStr = Number.isFinite(ratioPct) ? `${ratioPct.toLocaleString('es-AR', { maximumFractionDigits: 1 })}%` : '—';
        if(tieneLimiteTiempo){
          if(excedeTiempo){
            sumTiempoEl.setAttribute('title', `Supera el máximo permitido (${fmtMinutes(maxMinPermitido)}). Tiempo estimado: ${fmtMinutes(totalMin)}. El indicador se marca en rojo al excederlo.`);
          }else{
            sumTiempoEl.setAttribute('title', `Máximo permitido: ${fmtMinutes(maxMinPermitido)}. Tiempo estimado: ${fmtMinutes(totalMin)} (${pctStr} del límite). Se marca en naranja desde el ${WARN_PERCENT_LABEL}% y en rojo al superarlo.`);
          }
        }else{
          sumTiempoEl.setAttribute('title', `Tiempo estimado: ${fmtMinutes(totalMin)}. Configurá un límite de tiempo máximo para activar alertas.`);
        }
      }
      if(sumPesoEl){
        const ratioPct = Number.isFinite(pesoRatio) ? (pesoRatio * 100) : NaN;
        const pctStr = Number.isFinite(ratioPct) ? `${ratioPct.toLocaleString('es-AR', { maximumFractionDigits: 1 })}%` : '—';
        const totalPesoStr = fmtKg(totalPeso);
        if(tieneLimiteKg){
          if(Number.isFinite(maxPeso)){
            if(excedePeso){
              sumPesoEl.setAttribute('title', `Supera la capacidad de carga (${fmtKg(maxKgPermitido)}). Pico registrado: ${fmtKg(maxPeso)} (${pctStr} del límite). Total acumulado: ${totalPesoStr}. El indicador se marca en rojo al excederlo.`);
            }else{
              sumPesoEl.setAttribute('title', `Capacidad configurada: ${fmtKg(maxKgPermitido)}. Pico registrado: ${fmtKg(maxPeso)} (${pctStr} del límite). Total acumulado: ${totalPesoStr}. Se marca en naranja desde el ${WARN_PERCENT_LABEL}% y en rojo al superarlo.`);
            }
          }else{
            sumPesoEl.setAttribute('title', `Capacidad configurada: ${fmtKg(maxKgPermitido)}. Pico registrado: —. Total acumulado: ${totalPesoStr}. Se marca en naranja desde el ${WARN_PERCENT_LABEL}% y en rojo al superarlo.`);
          }
        }else{
          sumPesoEl.setAttribute('title', `Peso acumulado estimado: ${totalPesoStr}. Configurá la capacidad máxima de carga para activar alertas.`);
        }
      }
      if(btnOptimizar){
        let reason = '';
        if(excedido){
          reason = `Supera el máximo permitido (${fmtMoney(maxPermitido)})`;
        }else if(excedePeso){
          reason = `Supera la capacidad de carga (${fmtKg(maxKgPermitido)})`;
        }
        btnOptimizar.disabled = Boolean(reason);
        btnOptimizar.dataset.tip = reason || defaultOptimizeTip;
      }
    }

    // ===================== OPTIMIZACIÓN =====================
    function optimize(){
      const ctl = Loader.open('Preparando la optimización…');
      setTimeout(()=> ctl.setMessage('Evaluando restricciones…'), 1000);
      const origen = State.cab.find(c=>c.codigo===selOrigen.value);
      if(!origen){ ctl.fail('Seleccioná una cabecera origen'); return; }

      const camionId = (selCamion?.value || '').trim();
      if(!camionId){ ctl.fail('Seleccioná un camión/vehículo'); return; }
      const camion = State.cam.find(c => String(c.id) === camionId);
      const opt = selCamion?.options?.[selCamion?.selectedIndex] || null;
      const optSnap = optionSnapshot(opt);
      const camionSource = camion || optSnap || { id: camionId };
      const camionInfo = configureCfgWithTruck(camionSource) || toCamionSnapshot(camionSource);
      if(!camionInfo){ ctl.fail('El camión seleccionado no está disponible. Actualizá el listado de vehículos.'); return; }
      const camionEtiqueta = camionRefLabel(camionInfo) || camionLabel(camionId) || (camion?.modelo ? `${camionId} — ${camion.modelo}` : camionId);

      // Construir lista de puntos con prioridad
      const pts = flattenRoutes().map(p=> ({...p}));
      if(pts.length===0){ ctl.fail('No hay paradas'); return; }
      const camiones = parseInt(nCamionesInput?.value, 10) || 1;
      pushUndoEntry(createSnapshot());
      // Aplica prioridades: manual ★, abastecimientos primero, descargas altas antes
      pts.sort((a,b)=>{
        const pa = (a.priority? -1000:0) + (prioAbast.checked && /^abastec/i.test(a.servicio||'') ? -100 : 0) + (prioDescAlta.checked ? -Math.sign(-(a.monto||0)) * Math.abs(a.monto||0)/1e6 : 0);
        const pb = (b.priority? -1000:0) + (prioAbast.checked && /^abastec/i.test(b.servicio||'') ? -100 : 0) + (prioDescAlta.checked ? -Math.sign(-(b.monto||0)) * Math.abs(b.monto||0)/1e6 : 0);
        if(pa!==pb) return pa-pb;
        // si igual, más cercano al origen
        const da = haversine(parseNumber(origen.lat), parseNumber(origen.lng), a.lat, a.lng);
        const db = haversine(parseNumber(origen.lat), parseNumber(origen.lng), b.lat, b.lng);
        return da-db;
      });

      ctl.setMessage(`Distribuyendo en ${camiones} camión${camiones===1?'':'es'}…`);
      const distribuidas = splitIntoRoutes(pts, camiones);
      let shownHeld = false, shownHeur = false;
      const optimizadas = distribuidas.map(routePts=>{
        if(routePts.length===0) return [];
        const localPts = routePts.map(p=> ({...p}));
        const N = localPts.length;
        let orderIdx = [];
        if(N <= 11){
          if(!shownHeld){ ctl.setMessage('Ejecutando A* / Held-Karp (N pequeño)…'); shownHeld=true; }
          orderIdx = tspHeldKarp([origen, ...localPts], cfg).map(i=> i-1);
        }else{
          if(!shownHeur){ ctl.setMessage('Heurística (vecino + 2-opt)…'); shownHeur=true; }
          orderIdx = heuristicOrder(origen, localPts);
          orderIdx = twoOptImprove(origen, localPts, orderIdx);
        }
        return orderIdx.map(i => localPts[i]);
      });

      const maxPermitido = Number(cfg.maxMonto);
      if(isFinite(maxPermitido) && maxPermitido > 0){
        const violacion = optimizadas.findIndex(route =>{
          let carga = 0;
          let pico = 0;
          for(const p of route){
            const monto = Number(p.monto) || 0;
            if(monto > 0){
              carga += monto;
            }
            pico = Math.max(pico, carga);
            if(pico > maxPermitido + 1e-6){
              return true;
            }
          }
          return false;
        });
        if(violacion >= 0){
          undoStack.pop();
          ctl.fail(`La ruta del camión ${violacion+1} supera el máximo permitido (${fmtMoney(maxPermitido)}). Ajustá la ruta o aumentá el límite.`);
          return;
        }
      }

      const maxKgPermitido = Number(cfg.maxKg);
      if(isFinite(maxKgPermitido) && maxKgPermitido > 0){
        const violacionKg = optimizadas.findIndex(route =>{
          let carga = 0;
          let pico = 0;
          for(const p of route){
            const peso = parseNumber(p.peso);
            if(Number.isFinite(peso)){
              if(peso >= 0){
                carga += peso;
              }else{
                carga = Math.max(0, carga + peso);
              }
            }
            pico = Math.max(pico, carga);
            if(pico > maxKgPermitido + 1e-6){
              return true;
            }
          }
          return false;
        });
        if(violacionKg >= 0){
          undoStack.pop();
          ctl.fail(`La ruta del camión ${violacionKg+1} supera la capacidad de carga (${maxKgPermitido.toLocaleString('es-AR')} kg). Ajustá la ruta o elegí otro vehículo.`);
          return;
        }
      }

      const maxMinPermitido = Number(cfg.maxMin);
      if(isFinite(maxMinPermitido) && maxMinPermitido > 0){
        const origenLat = parseNumber(origen.lat);
        const origenLng = parseNumber(origen.lng);
        let totalMin = 0;
        optimizadas.forEach(route => {
          let minRuta = 0;
          let distKmRuta = 0;
          let last = { lat: origenLat, lng: origenLng };
          route.forEach(p => {
            if(last){ distKmRuta += haversine(last.lat, last.lng, p.lat, p.lng); }
            minRuta += stopTimeFor(p.tipo);
            last = p;
          });
          if(route.length && last){
            distKmRuta += haversine(last.lat, last.lng, origenLat, origenLng);
          }
          const tiempoTraslado = distKmRuta / (cfg.vel||40) * 60 * (cfg.trafficFactor||1);
          totalMin += minRuta + tiempoTraslado;
        });
        const totalMinRedondeado = Math.round(totalMin);
        if(totalMinRedondeado > maxMinPermitido + 1e-6){
          undoStack.pop();
          ctl.fail(`El tiempo estimado (${fmtMinutes(totalMinRedondeado)}) supera el máximo permitido (${fmtMinutes(maxMinPermitido)}). Considerá dividir la ruta entre más camiones o reducir paradas.`);
          return;
        }
      }

      currentRoute = optimizadas.length? optimizadas : [[]];
      draw();
      ctl.finish('Optimización completada');
      addRecent({ camionId: camionInfo.id || camionId, camionModelo: camionInfo.modelo || camion?.modelo || null, camionEtiqueta, camionRef: camionInfo });
    }

    function splitIntoRoutes(pts, camiones){
      const trucks = Math.max(1, camiones|0);
      const routes = Array.from({length: trucks}, ()=>[]);
      const loads = new Array(trucks).fill(0);
      pts.forEach(p=>{
        let target = 0;
        for(let i=1;i<trucks;i++){
          if(loads[i] < loads[target] - 1e-6 || (Math.abs(loads[i]-loads[target]) <= 1e-6 && routes[i].length < routes[target].length)){
            target = i;
          }
        }
        routes[target].push(p);
        const monto = Number(p.monto) || 0;
        loads[target] += monto < 0 ? 0 : monto;
      });
      return routes;
    }

    function tspHeldKarp(nodes, cfg){
      // nodes[0] = origen; nodes[1..N] = puntos
      const n = nodes.length;
      const dist = Array.from({length:n},()=>Array(n).fill(0));
      for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(i!==j){
        dist[i][j] = haversine(nodes[i].lat, nodes[i].lng, nodes[j].lat, nodes[j].lng);
      }
      // Held-Karp DP
      const size = 1<<(n-1); // solo para nodos 1..n-1
      const dp = Array.from({length:size},()=>Array(n).fill(Infinity));
      const parent = Array.from({length:size},()=>Array(n).fill(-1));
      for(let j=1;j<n;j++){ dp[1<<(j-1)][j] = dist[0][j]; }
      for(let mask=1; mask<size; mask++){
        for(let j=1;j<n;j++){
          if(!(mask & (1<<(j-1)))) continue;
          const pmask = mask ^ (1<<(j-1));
          if(pmask===0) continue;
          for(let k=1;k<n;k++){
            if(!(pmask & (1<<(k-1)))) continue;
            const val = dp[pmask][k] + dist[k][j];
            if(val < dp[mask][j]){ dp[mask][j] = val; parent[mask][j] = k; }
          }
        }
      }
      // cerrar ciclo al origen
      let best=Infinity, end=-1; const full= size-1;
      for(let j=1;j<n;j++){ const val = dp[full][j] + dist[j][0]; if(val<best){ best=val; end=j; } }
      // reconstruir
      const seq = []; let mask = full, j=end;
      while(j!==-1){ seq.push(j); const pj = parent[mask][j]; mask = mask ^ (1<<(j-1)); j = pj; }
      seq.reverse(); //  [j1, j2, ...]
      return seq; // índices 1..n-1 en términos de nodes
    }

    function heuristicOrder(origen, pts){
      const unvis = new Set(pts.map((_,i)=>i));
      let cur = {lat: parseNumber(origen.lat), lng: parseNumber(origen.lng)};
      const order = [];
      while(unvis.size){
        let best=null, bestD=Infinity;
        unvis.forEach(i=>{
          const p=pts[i];
          const d = haversine(cur.lat,cur.lng,p.lat,p.lng);
          const penalty = (prioAbast.checked && /^abastec/i.test(p.servicio||''))? 0.85 : 1;
          const score = d*penalty - (p.priority? 5:0) - (prioDescAlta.checked ? Math.abs(p.monto||0)/1e7 : 0);
          if(score<bestD){ bestD=score; best=i; }
        });
        order.push(best); cur = pts[best]; unvis.delete(best);
      }
      return order;
    }
    function routeLength(origen, pts, order){
      let total=0; let last={lat: parseNumber(origen.lat), lng: parseNumber(origen.lng)};
      for(const i of order){ const p=pts[i]; total += haversine(last.lat,last.lng,p.lat,p.lng); last=p; }
      total += haversine(last.lat,last.lng, parseNumber(origen.lat), parseNumber(origen.lng));
      return total;
    }
    function twoOptImprove(origen, pts, order){
      let improved=true; let bestOrder=order.slice(); let bestLen=routeLength(origen, pts, bestOrder);
      while(improved){
        improved=false;
        for(let i=0;i<bestOrder.length-1;i++){
          for(let k=i+1;k<bestOrder.length;k++){
            const newOrder = bestOrder.slice(0,i).concat(bestOrder.slice(i,k+1).reverse(), bestOrder.slice(k+1));
            const len = routeLength(origen, pts, newOrder);
            if(len + 1e-6 < bestLen){ bestLen=len; bestOrder=newOrder; improved=true; }
          }
        }
      }
      return bestOrder;
    }

    // ===================== EXPORTAR / TRÁNSITO / HISTORIAL =====================
    document.getElementById('btnOptimizar')?.addEventListener('click', optimize);
    document.getElementById('btnTransito')?.addEventListener('click', ()=>{
      // Toggle de factor de tránsito (simulado). Para datos reales, configurar API externa.
      cfg.trafficFactor = (cfg.trafficFactor>=1.45? 1.0 : (cfg.trafficFactor+0.25));
      save(DB.cfg, cfg);
      updateSummary();
      showToast('Factor de tránsito: x'+cfg.trafficFactor.toFixed(2));
    });
    document.getElementById('btnExportar')?.addEventListener('click', ()=>{
      const origen = State.cab.find(c=>c.codigo===selOrigen.value);
      if(!origen){ return showToast('Elegí una cabecera'); }
      const allPts = flattenRoutes();
      if(allPts.length===0){ return showToast('No hay paradas'); }
      const origin = `${parseNumber(origen.lat)},${parseNumber(origen.lng)}`;
      const dest = origin;
      const maxWaypoints = 25;
      const needsSplit = allPts.length > maxWaypoints;
      const chunks = [];
      for(let i=0; i<allPts.length; i+=maxWaypoints){
        chunks.push(allPts.slice(i, i+maxWaypoints));
      }
      const urls = chunks.map(chunk => {
        const waypoints = chunk.map(p => `${p.lat},${p.lng}`).join('|');
        const wayParam = waypoints ? `&waypoints=${encodeURIComponent(waypoints)}` : '';
        return `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}${wayParam}&travelmode=driving`;
      });
      urls.forEach(url => window.open(url, '_blank'));
      if(needsSplit){
        showToast(`Se generaron ${urls.length} URLs por superar el límite de ${maxWaypoints} paradas de Google Maps (total: ${allPts.length}).`);
      }else{
        showToast('Se generó 1 URL para Google Maps (ruta dentro del límite de 25 paradas).');
      }
    });
    document.getElementById('btnAprobar')?.addEventListener('click', ()=>{
      const origenCodigo = (selOrigen?.value || '').trim();
      const hasRoute = Array.isArray(currentRoute) && currentRoute.length > 0
        && currentRoute.some(route => Array.isArray(route) && route.length > 0);
      if(!hasRoute || !origenCodigo){
        showToast('Seleccioná una cabecera y asegurate de que la ruta tenga paradas antes de aprobar.');
        return;
      }
      const nombre = prompt('Nombre de la ruta para historial:', 'Ruta '+ new Date().toLocaleString('es-AR'));
      if(!nombre) return;
      const origen = State.cab.find(c=>c.codigo===origenCodigo);
      if(!origen){
        showToast('Cabecera inválida. Revisá la selección antes de aprobar.');
        return;
      }
      const rutas = cloneRoutes().filter(route => Array.isArray(route) && route.length > 0);
      const puntos = flattenRoutes(rutas).map(p => ({...p}));
      const distKm = Number.isFinite(lastSummary.distKm) ? Math.round(lastSummary.distKm * 10) / 10 : null;
      const camionIdSel = (selCamion?.value || '').trim();
      const camionSel = camionIdSel ? State.cam.find(c => String(c.id) === camionIdSel) : null;
      const optSel = selCamion && selCamion.selectedIndex >= 0 ? selCamion.options[selCamion.selectedIndex] : null;
      const camionSnapSel = optionSnapshot(optSel) || toCamionSnapshot(camionSel) || toCamionSnapshot({ id: camionIdSel });
      const camionEtiquetaSel = camionIdSel ? (camionSnapSel ? camionRefLabel(camionSnapSel) : (camionSel ? camionLabel(camionSel.id) : camionIdSel)) : '';
      const rec = {
        id: uuid(), fecha: new Date().toISOString().slice(0,10), nombre,
        origen: origenCodigo,
        rutas,
        puntos,
        distKm,
        camionId: camionIdSel || null,
        camionModelo: camionSel?.modelo || null,
        camionEtiqueta: camionEtiquetaSel || null,
        camionRef: camionSnapSel || null,
        camiones: parseInt(nCamionesInput?.value, 10)||1,
        tiempo: document.getElementById('sumTiempo').textContent, montoPico: document.getElementById('sumMonto').textContent,
        aprobado: true
      };
      State.hist.unshift(rec); save(DB.hist, State.hist); renderHist(); addRecent(rec); showToast('Ruta aprobada y guardada');
    });

    function addRecent(entry = {}, options = {}){
      const tb = document.getElementById('recentRoutes');
      if(!tb) return;
      const { prepend = true } = options;
      tb.querySelector('[data-placeholder="recent"]')?.remove();
      const defaultName = 'Ruta '+(new Date().toLocaleDateString('es-AR'));
      const nombre = typeof entry.nombre === 'string' && entry.nombre.trim() ? entry.nombre.trim() : defaultName;
      let totalPts;
      if(Number.isFinite(entry.totalPuntos)){
        totalPts = entry.totalPuntos;
      }else if(Array.isArray(entry.puntos)){
        totalPts = entry.puntos.length;
      }else if(Array.isArray(entry.rutas)){
        totalPts = entry.rutas.reduce((acc, route)=> acc + (Array.isArray(route)? route.length : 0), 0);
      }else{
        totalPts = flattenRoutes().length;
      }
      const sumTiempoEl = document.getElementById('sumTiempo');
      const tiempoRaw = typeof entry.tiempo === 'string' ? entry.tiempo.trim() : '';
      const fallbackTiempo = (sumTiempoEl?.textContent || '').trim();
      const tiempo = tiempoRaw && tiempoRaw !== '—' ? tiempoRaw : (fallbackTiempo && fallbackTiempo !== '—' ? fallbackTiempo : 'N/D');
      const vehiculoRaw = entry.camionId ?? entry.camionAsignado ?? entry.vehiculo ?? entry.camion ?? entry.camionRef?.id ?? null;
      const currentSel = selCamion?.value || '';
      let vehiculo = 'N/D';
      if(entry.camionRef){
        const formatted = camionRefLabel(entry.camionRef);
        if(formatted && formatted.trim()){ vehiculo = formatted.trim(); }
      }
      if(vehiculo === 'N/D' && vehiculoRaw !== null && vehiculoRaw !== undefined && String(vehiculoRaw).trim() !== ''){
        const formatted = camionLabel(vehiculoRaw);
        vehiculo = formatted && formatted.trim() ? formatted.trim() : String(vehiculoRaw).trim();
      }else if(entry.camionEtiqueta && String(entry.camionEtiqueta).trim()){
        vehiculo = String(entry.camionEtiqueta).trim();
      }else if(entry.camionModelo && String(entry.camionModelo).trim()){
        vehiculo = String(entry.camionModelo).trim();
      }else if(currentSel && String(currentSel).trim()){
        const formatted = camionLabel(currentSel);
        vehiculo = formatted && formatted.trim() ? formatted.trim() : String(currentSel).trim();
      }
      if(!vehiculo || !vehiculo.trim()){
        vehiculo = 'N/D';
      }
      const distSource = Number.isFinite(entry.distKm) ? entry.distKm : (Number.isFinite(lastSummary.distKm) ? lastSummary.distKm : null);
      let km = 'N/D';
      if(Number.isFinite(distSource)){
        const rounded = Math.round(distSource * 10) / 10;
        const minFraction = Number.isInteger(rounded) ? 0 : 1;
        km = rounded.toLocaleString('es-AR', { minimumFractionDigits: minFraction, maximumFractionDigits: 1 });
      }
      const rowHtml = `<td>${nombre}</td><td>${totalPts}</td><td>${vehiculo}</td><td>${tiempo}</td><td>${km}</td>`;
      let existing = null;
      if(entry && entry.id){
        existing = Array.from(tb.querySelectorAll('tr[data-id]')).find(tr => tr.dataset.id === entry.id) || null;
      }
      if(existing){
        existing.innerHTML = rowHtml;
        if(prepend){ tb.prepend(existing); }
        return existing;
      }
      const tr = document.createElement('tr');
      if(entry && entry.id){ tr.dataset.id = entry.id; }
      tr.innerHTML = rowHtml;
      if(prepend){
        tb.prepend(tr);
      }else{
        tb.appendChild(tr);
      }
      return tr;
    }

    function renderRecentFromHistory(){
      const tb = document.getElementById('recentRoutes');
      if(!tb) return;
      tb.innerHTML = '';
      const recent = State.hist.filter(item => item && item.aprobado).slice(0, 5);
      if(!recent.length){
        const placeholder = document.createElement('tr');
        placeholder.dataset.placeholder = 'recent';
        placeholder.innerHTML = `<td colspan="5" style="padding:16px;text-align:center;color:var(--muted-text);font-weight:700;">Sin rutas aprobadas todavía</td>`;
        tb.appendChild(placeholder);
        return;
      }
      recent.forEach(entry => addRecent(entry, { prepend: false }));
    }

    function renderHist(){
      const tbody = document.getElementById('histTbody');
      if(!tbody) return;
      tbody.innerHTML = State.hist.map(h=>{
        const rutas = Array.isArray(h.rutas)? h.rutas : [h.puntos||[]];
        const totalPts = rutas.reduce((acc, route)=> acc + (Array.isArray(route)? route.length : 0), 0);
        const vehiculoLabel = (()=>{
          const etiqueta = typeof h.camionEtiqueta === 'string' ? h.camionEtiqueta.trim() : '';
          if(etiqueta) return etiqueta;
          const refLabel = camionRefLabel(h.camionRef);
          if(refLabel && refLabel.trim()) return refLabel.trim();
          const idRaw = h.camionId ?? h.camionAsignado ?? h.vehiculo ?? h.camion ?? '';
          const idStr = typeof idRaw === 'string' ? idRaw.trim() : String(idRaw||'').trim();
          if(idStr){
            const formatted = camionLabel(idStr);
            if(formatted && formatted.trim() && formatted.trim() !== idStr){ return formatted.trim(); }
            if(h.camionModelo && String(h.camionModelo).trim()){
              return `${idStr} — ${String(h.camionModelo).trim()}`;
            }
            return idStr;
          }
          const modelo = typeof h.camionModelo === 'string' ? h.camionModelo.trim() : '';
          return modelo || 'N/D';
        })();
        const distLabel = (()=>{
          const dist = parseNumber(h.distKm);
          if(Number.isFinite(dist)){
            const rounded = Math.round(dist * 10) / 10;
            return fmtES.format(rounded);
          }
          return '—';
        })();
        return `
        <tr data-id="${h.id}"><td>${h.fecha||''}</td><td>${h.nombre||''}</td><td>${totalPts}</td><td>${vehiculoLabel}</td><td>${h.tiempo||'N/D'}</td><td>${distLabel}</td><td>${h.montoPico||'—'}</td><td>${h.aprobado?'Aprobado':'Borrador'}</td>
        <td><button class="chip" data-act="cargar">Cargar</button> <button class="chip" data-act="del">Eliminar</button></td></tr>
      `;}).join('');
      [...tbody.querySelectorAll('button[data-act="cargar"]')].forEach(b=> b.addEventListener('click', ()=>{
        const id = b.closest('tr').dataset.id;
        const h = State.hist.find(x=>x.id===id); if(!h) return;
        selOrigen.value = h.origen || '';
        const rutas = Array.isArray(h.rutas)? h.rutas : [h.puntos || []];
        currentRoute = rutas.map(route => Array.isArray(route)? route.map(p => ({...p})) : []);
        if(!currentRoute.length){ currentRoute = [[]]; }
        if(nCamionesInput){ nCamionesInput.value = h.camiones || Math.max(1, rutas.length); }
        if(selCamion){
          populateCamionSelect();
          const fallbackLabel = (typeof h.camionEtiqueta === 'string' && h.camionEtiqueta.trim())
            ? h.camionEtiqueta.trim()
            : (typeof h.camionModelo === 'string' ? h.camionModelo.trim() : '');
          const targetId = h.camionId || h.camionRef?.id || '';
          if(targetId){
            const labelFromRef = camionRefLabel(h.camionRef);
            ensureCamionOption(targetId, fallbackLabel || labelFromRef || targetId, h.camionRef || { id: targetId, modelo: fallbackLabel });
            selCamion.value = targetId;
          }else{
            selCamion.value = '';
          }
          selCamion.dispatchEvent(new Event('change'));
        }
        draw(); showToast('Ruta cargada desde historial');
      }));
      [...tbody.querySelectorAll('button[data-act="del"]')].forEach(b=> b.addEventListener('click', ()=>{
        const id = b.closest('tr').dataset.id;
        const i = State.hist.findIndex(x=>x.id===id); if(i>=0 && confirm('¿Eliminar del historial?')){ State.hist.splice(i,1); save(DB.hist, State.hist); renderHist(); }
      }));
      renderRecentFromHistory();
    }
    renderHist();

    document.getElementById('btnExportHist')?.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(State.hist, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = Object.assign(document.createElement('a'), {href:url, download:'historial_rutas.json'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('histImportInput')?.addEventListener('change', (ev)=>{
      const f=ev.target.files?.[0]; if(!f) return; const reader=new FileReader();
      reader.onload = (e)=>{ try{ const arr = JSON.parse(e.target.result); if(Array.isArray(arr)){ State.hist = arr; save(DB.hist, State.hist); renderHist(); showToast('Historial importado'); } }catch(e){ alert('JSON inválido'); } };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('btnImportHist')?.addEventListener('click', ()=> document.getElementById('histImportInput').click());

    // Init
    renderPts(); draw();
    const api = { renderPts, refreshSources };
    globalThis.Route = api;
    return api;
  })();

  /* =====================================================================
     CONFIGURACIÓN (persistir y aplicar)
  ===================================================================== */
  (function(){
    const bind = (id, prop, onChange)=>{
      const el = document.getElementById(id); if(!el) return;
      el.value = cfg[prop];
      el.addEventListener('input', ()=>{ cfg[prop] = (el.type==='color'||el.type==='text')? el.value : parseNumber(el.value); save(DB.cfg, cfg); if(onChange) onChange(); if(prop.startsWith('ui')) applyUIConfig(); });
    };
    bind('cfgMaxMonto','maxMonto');
    bind('cfgMaxMin','maxMin');
    bind('cfgVel','vel');
    bind('cfgStopSuc','stopSuc', ()=>{});
    bind('cfgStopATM','stopATM', ()=>{});
    bind('cfgStopCab','stopCab', ()=>{});
    bind('cfgStopExt','stopExt', ()=>{});
    bind('cfgFont','uiFont', applyUIConfig);
    bind('cfgRadius','uiRadius', applyUIConfig);
    bind('cfgAccent','uiAccent', applyUIConfig);
  })();

  // Copiar versión
  document.getElementById('versionChip')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText('v8.0.0'); showToast('Versión copiada'); }catch{}
  });
  </script>
</body>
</html>
