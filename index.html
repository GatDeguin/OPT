<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Banco Provincia — OptiRutas v8 (Dashboard · Rutas · Órdenes · ATMs · Sucursales · Cabeceras · Otros)</title>

  <!-- Fuentes y librerías -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <!-- Leaflet (mapas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    /* ===========================================================
       VARIABLES DE TEMA (claro/oscuro) + UI parametrizable
       =========================================================== */
    :root{
      /* Base (claro) */
      --app-bg:#f3f5f6;
      --text:#182230;
      --muted-text:#6B7B86;

      /* Paleta */
      --brand-50:#effaf3;  --brand-100:#dff5e7; --brand-200:#c8ecd7; --brand-300:#a4ddbe; --brand-400:#7acc9f;
      --brand-500:#55b97f; --brand-600:#43a46d; --brand-650:#3b9562; --brand-700:#2f7c51; --brand-800:#275f41;

      --ink-900:#0f1720; --ink-800:#1a2430; --ink-700:#223042; --ink-600:#2f3f53; --ink-500:#415468; --ink-400:#6b7a8c; --ink-300:#94a0ae; --ink-200:#c9d0d6; --ink-100:#e9edf0;

      --card:#ffffff; 
      --muted:#f7f8f9; 
      --shadow:0 2px 10px rgba(16, 24, 40, .08), 0 1px 3px rgba(16, 24, 40, .06);
      --line-clr: rgba(0,0,0,.08);

      /* Shell */
      --sidebar-bg:linear-gradient(180deg,#11181f 0%, #0e151a 70%);
      --sidebar-text:#EAF0F4;
      --topbar-grad:linear-gradient(180deg,#4a9c6f 0%, #3a865f 100%);

      /* Charts */
      --chart-text:#6b7a8c;
      --chart-grid:#ebeff3;
      --chart-accent:#43a46d;
      --chart-accent-2:#3b9562;
      --chart-accent-soft:rgba(67,164,109,.18);

      /* Rutas */
      --route-a:#2fbb6b;   /* tramo A */
      --route-b:#2a7bc6;   /* tramo B */
      --route-c:#e35a5a;   /* tramo conflicto/penalidad */

      /* Banner */
      --banner-from:#2a7bc6; --banner-mid:#1e589b; --banner-to:#134476; --banner-text:#ffffff;

      /* Accentos */
      --accent:#2fbb6b;
      --accent-2:#2aa862;
      --danger:#e35a5a;

      /* UI parametrizable */
      --ui-fontscale: 1;             /* escala tipográfica */
      --ui-radius: 14px;             /* radio por defecto */
      --ui-accent: #43a46d;          /* color acento */
    }

    html[data-theme="dark"]{
      --app-bg:#0e1620;
      --text:#e8eef7;
      --muted-text:#c8d3e3;

      --brand-50:#141e2c; 
      --brand-100:rgba(255,255,255,.08); 
      --brand-200:#1f2a3a; 
      --brand-300:#233042; 
      --brand-400:#2b3a4e;
      --brand-500:#31614e; 
      --brand-600:#3ca870; 
      --brand-650:#3b9562; 
      --brand-700:#2b7a51; 
      --brand-800:#1f5b3e;

      --ink-900:#f2f6fb; --ink-800:#e8eef7; --ink-700:#c8d3e3; --ink-600:#aab6c8; --ink-500:#8e9cb0; --ink-400:#7f8da4; --ink-300:#6c7b93; --ink-200:#56657c; --ink-100:#3a485d;

      --card:#182231; 
      --muted:#111b28; 
      --shadow:0 14px 26px rgba(0,10,30,.28), inset 0 1px 0 rgba(255,255,255,.04);
      --line-clr: rgba(255,255,255,.12);

      --sidebar-bg:#0c141d;
      --sidebar-text:#c8d3e3;
      --topbar-grad:linear-gradient(180deg,#1b2636 0%, #131c29 100%);

      --chart-text:#c8d3e3;
      --chart-grid:rgba(255,255,255,.12);
      --chart-accent:#39d07c;
      --chart-accent-2:#2f6df6;
      --chart-accent-soft:rgba(67,164,109,.20);

      --banner-from:#2a7bc6; --banner-mid:#1e589b; --banner-to:#134476; --banner-text:#ffffff;

      --accent:#2fbb6b;
      --accent-2:#2aa862;
      --danger:#e35a5a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-size:calc(16px * var(--ui-fontscale));
      background:var(--app-bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Layout ===== */
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{background:var(--sidebar-bg);color:var(--sidebar-text);position:relative}
    .sidebar .brand{position:absolute;bottom:16px;left:16px;display:flex;gap:10px;align-items:center;opacity:.9}
    .sidebar .brand svg{filter:drop-shadow(0 2px 0 rgba(0,0,0,.25))}
    .menu{padding:14px 12px 84px;}
    .menu h1{display:flex;gap:10px;align-items:center;padding:14px 14px 10px;font-weight:800;font-size:18px;opacity:.95}
    .menu h1 .logo{border-radius:10px;background:rgba(255,255,255,.07);padding:8px;display:grid;place-items:center}
    .nav{margin-top:8px;display:flex;flex-direction:column;gap:4px}
    .nav button{appearance:none;border:0;background:transparent;color:var(--sidebar-text);display:flex;gap:12px;align-items:center;width:100%;padding:10px 12px;border-radius:10px;cursor:pointer;position:relative;overflow:hidden}
    .nav button .ico{width:20px;height:20px;opacity:.95}
    .nav button .txt{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:165px}
    .nav button:hover{background:rgba(255,255,255,.06)}
    .nav button.active{background:rgba(59,149,98,.25);color:#fff;box-shadow:inset 0 0 0 1px rgba(87,177,128,.55)}
    .ripple{position:absolute;border-radius:50%;transform:scale(0);animation:ripple .6s linear;background:rgba(255,255,255,.25)}
    @keyframes ripple{to{transform:scale(3.5);opacity:0}}

    .main{display:grid;grid-template-rows:78px 1fr;}
    .topbar{background:var(--topbar-grad);padding:14px 22px;color:#fff;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow)}
    .topbar .title{display:flex;gap:10px;align-items:center;font-weight:800;font-size:22px;letter-spacing:.2px}
    .topbar .title .mark{display:grid;place-items:center;background:rgba(255,255,255,.15);padding:8px;border-radius:10px}
    .topbar .actions{display:flex;gap:10px;align-items:center}

    .icon-btn{--size:36px;width:var(--size);height:var(--size);border-radius:10px;background:rgba(255,255,255,.15);display:grid;place-items:center;border:1px solid rgba(255,255,255,.25);backdrop-filter: blur(2px);cursor:pointer;transition:transform .15s ease, background .2s;}
    .icon-btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.22)}

    .content{padding:22px;display:grid;gap:18px;grid-template-columns:1fr}
    .hidden{display:none !important}

    /* ====== Cards / tablas ====== */
    .card{background:var(--card);border-radius:var(--ui-radius);box-shadow:var(--shadow);position:relative;border:1px solid var(--line-clr)}
    .card.fade-in{animation:rise .35s ease both}
    @keyframes rise{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

    .table{background:var(--card);border-radius:var(--ui-radius);box-shadow:var(--shadow);border:1px solid var(--line-clr)}
    .table header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 0}
    .table header h3{margin:0;font-size:16px;font-weight:800;color:var(--text)}
    .table .body{padding:10px 18px 18px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{text-align:left;padding:12px 10px;color:var(--muted-text);font-weight:800;border-bottom:1px solid var(--line-clr)}
    tbody td{padding:12px 10px;border-bottom:1px solid var(--line-clr);color:var(--text)}
    tbody tr{transition: background .18s ease}
    tbody tr:hover{background:rgba(0,0,0,.03)}
    html[data-theme="dark"] tbody tr:hover{background:rgba(255,255,255,.03)}
    tbody tr.selected{background:linear-gradient(180deg, rgba(47,187,107,.22), rgba(47,187,107,.09)); box-shadow: inset 0 0 0 1px rgba(47,187,107,.38)}

    /* ====== Dashboard ====== */
    .stats{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:18px}
    .stat{display:grid;grid-template-columns:auto 1fr;gap:12px;padding:18px}
    .stat .circle{width:44px;height:44px;border-radius:12px;background:var(--brand-50);display:grid;place-items:center;border:1px solid var(--brand-100);box-shadow: inset 0 -1px 0 rgba(0,0,0,.05)}
    .stat .value{font-size:28px;font-weight:800;color:var(--ink-800);letter-spacing:-.5px}
    .stat .label{margin-top:-3px;color:var(--muted-text);font-weight:700}
    .panels{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .panel{background:var(--card);border-radius:var(--ui-radius);box-shadow:var(--shadow);padding:18px;border:1px solid var(--line-clr)}
    .panel h3{margin:0 0 12px 2px;font-size:16px;font-weight:800;color:var(--text)}
    .legend{display:flex;gap:18px;align-items:center;justify-content:center;margin-top:8px}
    .legend .item{display:flex;gap:8px;align-items:center;color:var(--ink-600);font-weight:700}
    .legend .dot{width:10px;height:10px;border-radius:999px}
    .panel-wide{grid-column:1/-1}
    canvas{user-select:none}
    .chart-wrap{position:relative}
    .pie-side-label{position:absolute;top:45%;transform:translateY(-50%);font-weight:800;color:var(--ink-600)}
    .pie-side-label.left{left:4%}
    .pie-side-label.right{right:4%}

    /* ====== About ====== */
    .about .head{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;margin-bottom:8px}
    .about .title{font-size:28px;font-weight:800;letter-spacing:.2px;margin:0;color:var(--text)}
    .about .lead{font-size:18px;line-height:1.55;color:var(--ink-600);margin:12px 0 18px;max-width:980px}
    .about .grid{display:grid;gap:18px;grid-template-columns:1fr 1fr}
    .about .card h4{margin:0 0 10px;font-size:16px;font-weight:800;color:var(--text)}
    .about ul{margin:0;padding-left:20px;color:var(--ink-600);font-weight:700}
    .about li{margin:8px 0}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.04));border:1px solid var(--line-clr);color:var(--text);font-weight:800;letter-spacing:.2px;cursor:pointer;transition:transform .15s ease, box-shadow .25s ease, background .25s ease}
    html[data-theme="dark"] .chip{background:linear-gradient(180deg,#0c1015,#0a0e13)}
    .chip:hover{transform:translateY(-1px)}
    .banner{position:relative;border-radius:var(--ui-radius);overflow:hidden;min-height:110px;display:flex;align-items:center;justify-content:space-between;padding:0 24px;border:1px solid var(--line-clr);background:radial-gradient(120% 140% at -10% 50%, var(--banner-from) 0%, var(--banner-mid) 60%, var(--banner-to) 100%);box-shadow:var(--shadow);isolation:isolate}
    .banner .bapro{font-weight:800;font-size:46px;letter-spacing:.4px;color:var(--banner-text);text-shadow:0 2px 8px rgba(0,0,0,.35)}
    .banner .tag{font-weight:700;font-size:22px;color:var(--banner-text);opacity:.96}

    /* ====== Map panels comunes ====== */
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .search{--h:44px;position:relative;display:flex;align-items:center;gap:10px;min-width:260px;flex:1 1 420px;background:linear-gradient(180deg,rgba(0,0,0,.02),rgba(0,0,0,.04));border:1px solid var(--line-clr);border-radius:12px;height:var(--h);padding:0 12px}
    html[data-theme="dark"] .search{background:linear-gradient(180deg,#26323c,#202a33)}
    .search input{all:unset;color:var(--text);font:700 15px/1 "Inter",sans-serif;width:100%}
    .chip.muted{padding:6px 10px;border-radius:100px;font-weight:700;font-size:12px;background:rgba(0,0,0,.03);border:1px solid var(--line-clr);color:var(--muted-text)}
    html[data-theme="dark"] .chip.muted{background:rgba(255,255,255,.05)}
    .coord{color:var(--muted-text);font-variant-numeric:tabular-nums}
    .map-skeleton{height:420px;display:grid;place-items:center;background:linear-gradient(90deg, #e8edf0 25%, #f1f4f6 37%, #e8edf0 63%);background-size:400% 100%;animation: shimmer 1.6s infinite;border-radius:0 0 var(--ui-radius) var(--ui-radius);overflow:hidden}
    html[data-theme="dark"] .map-skeleton{background: linear-gradient(90deg, #22303a 25%, #273845 37%, #22303a 63%)}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    #atmMap,#sucMap,#routeMap{height:520px;border-radius: 0 0 var(--ui-radius) var(--ui-radius);overflow:hidden}

    /* ====== RUTAS UI ====== */
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .toolbar .left, .toolbar .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:100px;background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.05));border:1px solid var(--line-clr);font-weight:800}
    html[data-theme="dark"] .pill{background:linear-gradient(180deg,#263744,#21323d)}

    .tag{padding:3px 8px;border-radius:999px;font-weight:800;font-size:11px;letter-spacing:.3px;text-transform:uppercase;border:1px solid var(--line-clr);background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.05))}
    .tag.ok{background:linear-gradient(180deg, rgba(47,187,107,.20), rgba(47,187,107,.06));border-color:rgba(47,187,107,.38)}

    .split{display:grid;grid-template-columns:minmax(420px, 0.9fr) minmax(480px, 1.1fr);gap:14px}
    @media (max-width:1150px){ .split{grid-template-columns:1fr} }

    .order-num{display:inline-grid;place-items:center;width:22px;height:22px;border-radius:6px;background:var(--brand-50);border:1px solid var(--brand-100);font:800 11px/1 "Inter",sans-serif}
    .priority{color:#d97706;font-weight:800}
    .route-summary{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width:900px){ .route-summary{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .kv{background:linear-gradient(180deg,rgba(0,0,0,.02),rgba(0,0,0,.04));border:1px solid var(--line-clr);border-radius:12px;padding:12px 12px 10px}
    html[data-theme="dark"] .kv{background:linear-gradient(180deg,#263744,#21323d)}
    .kv small{color:var(--muted-text);display:block;font-weight:800;letter-spacing:.1em;text-transform:uppercase}
    .kv div{margin-top:6px;font-weight:800;font-size:16px}

    /* ====== Login + Splash ====== */
    .splash{position:fixed;inset:0;display:none;place-items:center;background:#0b1a12;z-index:400}
    .splash.is-open{display:grid;animation:fadeOut 1s ease 1.2s forwards}
    .splash img{width:min(70vw,640px);max-width:92vw;filter:drop-shadow(0 20px 40px rgba(0,0,0,.4))}
    @keyframes fadeOut{to{opacity:0;visibility:hidden;pointer-events:none}}

    .login-view{position:fixed; inset:0; display:grid; place-items:center; background: radial-gradient(circle at center, #1f3529, #0d1a13); z-index:300}
    .login-container{background:#111; padding:2rem; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,.5); width:min(92vw, 340px); animation: rise .35s ease both}
    .login-container .logo{display:flex; align-items:center; justify-content:center; margin-bottom:1rem}
    .login-container .logo img{width:48px; margin-right:10px}
    .login-container .logo h1{font-size:1.2rem; color:#fff; font-weight:800; line-height:1.1}
    .login-container .logo span{display:block; font-weight:600; font-size:1rem}
    .login-container h2{ text-align:center; color:#fff; font-weight:800; margin:0 0 1rem}
    .login-container .input-group{ margin-bottom:1rem }
    .login-container label{ display:block; color:#ccc; font-weight:700; font-size:.9rem; margin-bottom:6px }
    .login-container input[type="text"], 
    .login-container input[type="password"]{ width:100%; padding:10px 12px; border:1px solid #444; border-radius:8px; background:#1a1a1a; color:#fff; font:600 15px/1 "Inter", system-ui, sans-serif; outline:none; transition: all .2s ease }
    .login-container input:focus{ border-color:#2ecc71; background:#222; box-shadow: 0 0 0 3px rgba(46,204,113,.25) }
    .login-container .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin: 4px 0 12px }
    .login-container .remember{ color:#bbb; font-weight:700; font-size:.85rem; display:flex; align-items:center; gap:8px }
    .login-container .btn{ width:100%; padding:12px; border:0; border-radius:10px; background:#1f5e3a; color:#fff; font:800 15px/1 "Inter", system-ui, sans-serif; cursor:pointer; transition: transform .12s ease, box-shadow .2s ease, background .2s ease }
    .login-container .btn:hover{ background:#2ecc71; transform: translateY(-1px); box-shadow:0 10px 24px rgba(46,204,113,.25) }
    .login-container .error{ margin-top:10px; color:#ff9b9b; font-weight:800; min-height:1.1em }
    @media (prefers-color-scheme: light){
      .login-view{ background: radial-gradient(circle at center, #e9f3ed, #cfe4d8) }
      .login-container{ background:#fff; color:#182230; box-shadow:0 14px 30px rgba(16,24,40,.22) }
      .login-container label{ color:#51606b }
      .login-container input{ background:#f7f8f9; color:#182230 }
      .login-container .btn{ background:#43a46d }
      .login-container .btn:hover{ background:#55b97f }
    }

    /* ====== Loader (camioncito) ====== */
    .modal{position:fixed;inset:0;display:none;place-items:center;padding:20px;z-index:350;background:rgba(9,12,16,.6);backdrop-filter: blur(8px) saturate(120%);transition:opacity .2s ease}
    .modal.open{display:grid}
    .sheet{width:min(760px, 96vw);background:var(--card);border:1px solid var(--line-clr);border-radius:20px;box-shadow:var(--shadow);animation: sheetIn .18s ease}
    @keyframes sheetIn{from{opacity:0;transform:translateY(12px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    .sheet-h{padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;justify-content:space-between;align-items:center;font-weight:800}
    .sheet-b{padding:12px 16px 18px;display:grid;gap:12px}
    .progress{margin: 6px 2px 0 2px;background: #ffffff;border-radius: 999px;border: 1px solid rgba(15,23,42,.08);overflow:hidden;inline-size: 100%; block-size: 10px}
    .bar{inline-size:0%;block-size:100%;background:linear-gradient(90deg, var(--accent), #7cc2ff);transition:inline-size .4s ease}
    .status{font-size:.95rem;color:var(--text);opacity:.85;margin-top:6px}

    .scene{position:relative;inline-size:100%; block-size: clamp(240px, 48svh, 460px); border: 12px solid #fff; border-radius: calc(var(--ui-radius) + 6px); overflow:hidden; background:#e6f5ff; box-shadow: inset 0 0 0 1px rgba(15,23,42,.05)}
    .background, .foreground{position:absolute; inset:auto 0 0 0; inline-size:100%; block-size:100%; background-size:cover; background-repeat: repeat-x; z-index:0; animation-play-state:paused}
    .background{background-image:url('load1.png'); animation:scroll-bg 15s linear infinite}
    .foreground{background-image:url('load2.png'); animation:scroll-fg 6s linear infinite; z-index:1}
    .truck{position:absolute; left:50%; bottom:1%; transform:translateX(-50%); inline-size:clamp(200px, 36vw, 520px); z-index:3; animation:bounce 1.2s ease-in-out infinite; animation-play-state:paused}
    .smoke, .dust{position:absolute;border-radius:50%;z-index:2;animation-play-state:paused}
    .smoke{left:30%; bottom:3%; inline-size:40px; block-size:40px; background:rgba(150,150,150,.6); animation:smoke 2s infinite}
    .dust{ left:30%; bottom:3%; inline-size:16px; block-size:16px; background:rgba(180,140,80,.6); animation:dust 1.5s infinite}

    .scene.is-running .background,
    .scene.is-running .foreground,
    .scene.is-running .truck,
    .scene.is-running .smoke,
    .scene.is-running .dust{ animation-play-state:running }

    @keyframes scroll-bg{ from{background-position:0 0} to{background-position:-1920px 0} }
    @keyframes scroll-fg{ from{background-position:0 0} to{background-position:-1280px 0} }
    @keyframes bounce{ 0%,100%{ transform:translate(-50%, 0) } 50%{ transform:translate(-50%, -8px) rotate(-1deg) } }
    @keyframes smoke{ 0%{ transform:scale(.4); opacity:.8 } 50%{ transform:scale(1.2) translateY(-30px); opacity:.4 } 100%{ transform:scale(2) translateY(-60px); opacity:0 } }
    @keyframes dust{ 0%{ transform:scale(.5); opacity:.7 } 50%{ transform:scale(1) translateX(-20px) translateY(-10px); opacity:.5 } 100%{ transform:scale(1.5) translateX(-40px) translateY(-20px); opacity:0 } }
  </style>
</head>
<body>

  <!-- ===== SPLASH ===== -->
  <div id="splash" class="splash" aria-hidden="true">
    <!-- El usuario debe colocar splash.png al lado de index -->
    <img src="splash.png" alt="OptiRutas" />
  </div>

  <!-- ===== LOGIN ===== -->
  <div id="loginView" class="login-view" role="dialog" aria-label="Iniciar sesión">
    <div class="login-container">
      <div class="logo">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d7/Logo_Banco_Provincia.svg/1024px-Logo_Banco_Provincia.svg.png" alt="Banco Provincia" />
        <h1>Banco <span>Provincia</span></h1>
      </div>
      <h2>Iniciar sesión</h2>
      <form id="loginForm" autocomplete="on" novalidate>
        <div class="input-group">
          <label for="usuario">Usuario</label>
          <input type="text" id="usuario" placeholder="1001@oper" required autofocus />
        </div>
        <div class="input-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" placeholder="••••••••" required />
        </div>
        <div class="row">
          <label class="remember"><input type="checkbox" id="remember" /> Recordarme</label>
          <a href="#" id="fakeForgot" style="color:#9ad6b0;font-weight:800; text-decoration:none">¿Olvidaste tu clave?</a>
        </div>
        <button class="btn" id="loginBtn" type="submit">Iniciar sesión</button>
        <div class="error" id="loginError" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="appRoot" class="app hidden" aria-hidden="true">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="menu">
        <h1><span class="logo" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20.5 3.5C14 4 6 9.5 6 15.5C6 17.985 8.015 20 10.5 20C16.5 20 22 12 20.5 3.5Z" fill="#9ee3b4"/><path d="M3 21C6 16 10.5 12.5 14.5 10.5" stroke="#d9f6df" stroke-width="2" stroke-linecap="round"/></svg>
        </span>Banco Provincia</h1>

        <nav class="nav" id="nav">
          <button class="active" data-name="Dashboard" data-target="dashboard">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M4 19l4-7 4 3 4-8 4 12" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span class="txt">Dashboard</span>
          </button>
          <button data-name="Rutas" data-target="rutas">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M4 6h5l3 3h8M4 18h10l3-4h3" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <span class="txt">Rutas</span>
          </button>
          <button data-name="Órdenes" data-target="ordenes">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M4 5h16v14H4z"/><path d="M7 8h10M7 12h10M7 16h6"/></svg>
            <span class="txt">Órdenes</span>
          </button>
          <button data-name="Sucursales" data-target="sucursales">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 9l9-6 9 6-9 6-9-6z"/><path d="M21 15l-9 6-9-6"/><path d="M3 9l9 6 9-6"/></svg>
            <span class="txt">Sucursales</span>
          </button>
          <button data-name="ATMs" data-target="atms">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M8 4v4m8-4v4"/></svg>
            <span class="txt">ATMs</span>
          </button>
          <button data-name="Cabeceras" data-target="cabeceras">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 7l1.5-3h9L18 7M6 7h12l-1 12H7L6 7Z"/><path d="M9 11h6" stroke-linecap="round"/></svg>
            <span class="txt">Cabeceras</span>
          </button>
          <button data-name="Otros Bancos" data-target="otros">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
            <span class="txt">Otros Bancos</span>
          </button>
          <button data-name="Choferes" data-target="choferes">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="8" r="3"/><path d="M4 20c1.5-4 6.5-6 8-6s6.5 2 8 6"/></svg>
            <span class="txt">Choferes</span>
          </button>
          <button data-name="Camiones" data-target="camiones">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="7" width="10" height="8" rx="1"/><path d="M13 10h4l3 3v2h-2"/><circle cx="7" cy="18" r="1.5"/><circle cx="17" cy="18" r="1.5"/></svg>
            <span class="txt">Camiones</span>
          </button>
          <button data-name="Costos" data-target="costos">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="9"/><path d="M8 12h8M12 8v8"/></svg>
            <span class="txt">Costos</span>
          </button>
          <button data-name="Reportes" data-target="reportes">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M4 4h16v16H4z"/><path d="M8 8h8M8 12h8M8 16h5"/></svg>
            <span class="txt">Reportes</span>
          </button>
          <button data-name="Configuración" data-target="config">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1 .6l-.09.1a2 2 0 1 1-3.2 0l-.09-.1a1.65 1.65 0 0 0-1-.6 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-.6-1l-.1-.09a2 2 0 1 1 0-3.2l.1-.09a1.65 1.65 0 0 0 .6-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 6.94 3.9l.06.06A1.65 1.65 0 0 0 8 4.6c.38 0 .74-.14 1-.4l.09-.1a2 2 0 1 1 3.2 0l.09.1c.26.26.62.4 1 .4.63 0 1.22-.25 1.65-.69l.06-.06A2 2 0 1 1 20.1 6.94l-.06.06c-.46.43-.7 1.02-.7 1.65 0 .38.14.74.4 1l.1.09a1.65 1.65 0 0 0 .6 1z"/></svg>
            <span class="txt">Configuración</span>
          </button>
          <button data-name="Acerca de" data-target="about">
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
              <circle cx="12" cy="12" r="9"></circle>
              <line x1="12" y1="10" x2="12" y2="16"></line>
              <circle cx="12" cy="7" r="1" fill="currentColor"></circle>
            </svg>
            <span class="txt">Acerca de</span>
          </button>
        </nav>
      </div>
      <div class="brand" aria-hidden="true">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="2" y="2" width="20" height="20" rx="6" fill="#2b865b"/>
          <path d="M7 16c2.5-3.5 6.5-6 10-7-1 5-5 9-10 7z" fill="#bdf1cc"/>
        </svg>
        <div>
          <div style="font-weight:800;letter-spacing:.2px">Banco</div>
          <div style="opacity:.7">Provincia</div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="title" id="topTitle">
          <span class="mark" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M12 3l3 7h7l-6 4 2 7-6-4-6 4 2-7-6-4h7l3-7z"/></svg>
          </span>
          <span id="topTitleText">Dashboard</span>
        </div>
        <div class="actions">
          <button class="icon-btn" aria-label="Notificaciones" data-tip="Notificaciones">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M15 17h5l-1.4-1.4A2 2 0 0 1 18 14.2V11a6 6 0 1 0-12 0v3.2c0 .53-.21 1.04-.59 1.41L4 17h5"/><path d="M9 20a3 3 0 0 0 6 0"/></svg>
          </button>
          <button class="icon-btn" id="themeToggle" aria-label="Cambiar tema" data-tip="Cambiar tema">
            <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>
          <span class="chip muted hidden" id="userChip" style="user-select:none"></span>
          <button class="icon-btn" id="logoutBtn" aria-label="Cerrar sesión" data-tip="Cerrar sesión">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8">
              <path d="M10 17l-1 0a6 6 0 110-10h1" stroke-linecap="round"/>
              <path d="M14 8l4 4-4 4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M18 12H9" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </header>

      <!-- ===== Dashboard ===== -->
      <section class="content" id="dashboardSection" aria-label="Dashboard">
        <div class="stats">
          <div class="card stat fade-in" style="animation-delay:.02s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.8"><path d="M3 21l4-7 4 3 4-8 4 12" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
            <div><div class="value" data-count="12">12</div><div class="label">Rutas</div></div>
          </div>
          <div class="card stat fade-in" style="animation-delay:.06s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.7"><path d="M4 18c3-5 7-5 10-10 1.5-2.1 3-3 6-3" stroke-linecap="round"/><path d="M15 14c2.5-1 4-1 5.5 0" stroke-linecap="round"/></svg></div>
            <div><div class="value" data-count="427">427</div><div class="label">Km</div></div>
          </div>
          <div class="card stat fade-in" style="animation-delay:.1s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.7"><circle cx="12" cy="12" r="8"/><path d="M12 7v5l3 3" stroke-linecap="round"/></svg></div>
            <div><div class="value" data-count="8.2" data-decimal="," data-fixed="1">8,2</div><div class="label">Horas</div></div>
          </div>
          <div class="card stat fade-in" style="animation-delay:.14s">
            <div class="circle"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--brand-650)" stroke-width="1.8"><path d="M6 6l12 12M6 18L18 6" stroke-linecap="round"/></svg></div>
            <div><div class="value" data-count="5">5</div><div class="label">No servidos</div></div>
          </div>
        </div>

        <div class="panels">
          <div class="panel fade-in" style="animation-delay:.18s">
            <h3>Montos Transportados</h3>
            <div class="chart-wrap"><canvas id="montosChart" height="172"></canvas></div>
          </div>
          <div class="panel fade-in" style="animation-delay:.22s">
            <h3>Desglose de Entregas con Éxito</h3>
            <div class="chart-wrap" style="height:200px">
              <canvas id="entregasChart"></canvas>
              <div class="pie-side-label left" id="pieLeft">31,3 %</div>
              <div class="pie-side-label right" id="pieRight">68,7 %</div>
            </div>
            <div class="legend">
              <div class="item"><span class="dot" style="background:var(--brand-650)"></span> Sucursales</div>
              <div class="item"><span class="dot" style="background:var(--brand-200)"></span> ATMs</div>
            </div>
          </div>
          <div class="panel panel-wide fade-in" style="animation-delay:.26s">
            <h3>Entregas Fallidas y Exitosas</h3>
            <div class="chart-wrap"><canvas id="fallidasChart" height="160"></canvas></div>
          </div>
        </div>

        <div class="table card fade-in" style="animation-delay:.30s">
          <header><h3>Rutas Recientes</h3></header>
          <div class="body">
            <table aria-label="Rutas recientes">
              <thead><tr><th>Ruta</th><th>Paradas</th><th>Vehículo</th><th>Horas</th><th>Kilómetros</th></tr></thead>
              <tbody id="recentRoutes"><tr><td>Ruta 1</td><td>9</td><td>Camión 101</td><td>17:20</td><td>874</td></tr></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ===== RUTAS ===== -->
      <section class="content hidden" id="rutasSection" aria-label="Rutas">
        <div class="toolbar">
          <div class="left">
            <span class="pill">
              <label for="selOrigen" style="font-weight:800;color:var(--muted-text)">Cabecera</label>
              <select id="selOrigen" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;min-width:180px;font-weight:800"><option value="">—</option></select>
            </span>
            <span class="pill">
              <label for="nCamiones" style="font-weight:800;color:var(--muted-text)">Camiones</label>
              <input id="nCamiones" type="number" min="1" value="1" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:70px;font-weight:800" />
            </span>
            <span class="pill">
              <label><input type="checkbox" id="prioAbast" checked /> Abastecimientos primero</label>
            </span>
            <span class="pill">
              <label><input type="checkbox" id="prioDescargaAlta" /> Descargar montos altos antes</label>
            </span>
          </div>
          <div class="right">
            <button class="chip" id="btnOptimizar" data-tip="Optimizar (A* + 2-opt)">Optimizar</button>
            <button class="chip" id="btnTransito" data-tip="Consultar tránsito/Simular">Tránsito</button>
            <button class="chip" id="btnExportar" data-tip="Abrir en Google Maps">Exportar</button>
            <button class="chip" id="btnAprobar" data-tip="Aprobar y agregar al historial" style="background: linear-gradient(180deg, rgba(47,187,107,.24), rgba(47,187,107,.08)); border-color:rgba(47,187,107,.32)">Aprobar</button>
          </div>
        </div>

        <div class="split">
          <!-- LISTA DE PUNTOS -->
          <section class="card" aria-labelledby="ptsTitle">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" id="ptsTitle" style="font-weight:800">Puntos disponibles</div>
              <div class="row">
                <div class="search">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                  <input id="ptsQ" placeholder="Buscar (código/nombre)" />
                </div>
                <span class="chip muted">Mostrando <strong id="ptsCount">0</strong></span>
                <button class="chip" id="addFromOrdenes" data-tip="Agregar órdenes seleccionadas">+ Órdenes</button>
              </div>
            </div>
            <div class="card-body" style="overflow:auto; max-height:520px">
              <table class="table" id="ptsTable" role="grid" aria-label="Listado de puntos" style="border:0">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Código/Nombre</th>
                    <th class="right">Lat</th>
                    <th class="right">Lng</th>
                    <th class="right">Monto</th>
                    <th>Servicio</th>
                    <th>Priorizar</th>
                    <th>Agregar</th>
                  </tr>
                </thead>
                <tbody id="ptsTbody"></tbody>
              </table>
            </div>
          </section>

          <!-- MAPA RUTA -->
          <section class="card" aria-labelledby="mapTitle">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" id="mapTitle" style="font-weight:800">Ruta manual / optimizada</div>
              <div class="row">
                <button class="chip" id="btnLimpiarRuta">Limpiar</button>
                <button class="chip" id="btnDeshacer">Deshacer</button>
              </div>
            </div>
            <div class="card-body">
              <div class="map-skeleton" id="routeMapSkeleton">Cargando mapa…</div>
              <div id="routeMap" class="hidden" role="application" aria-label="Mapa de Rutas"></div>
            </div>
            <div class="card-footer" style="padding:12px 16px;border-top:1px solid var(--line-clr)">
              <div class="route-summary" id="routeSummary">
                <div class="kv"><small>Puntos</small><div id="sumPuntos">0</div></div>
                <div class="kv"><small>Camiones comisión</small><div id="sumCamiones">1</div></div>
                <div class="kv"><small>Monto transportado (pico)</small><div id="sumMonto">$ 0</div></div>
                <div class="kv"><small>Tiempo estimado</small><div id="sumTiempo">0:00 h</div></div>
              </div>
            </div>
          </section>

          <!-- RUTA ACTUAL -->
          <section class="card" style="grid-column:1/-1">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" style="font-weight:800">Paradas de la ruta (orden manual/opt.)</div>
            </div>
            <div class="card-body" style="overflow:auto; max-height:320px">
              <table class="table" style="border:0">
                <thead><tr><th>#</th><th>Tipo</th><th>Nombre</th><th class="right">Monto</th><th>Servicio</th><th>Quitar</th></tr></thead>
                <tbody id="rutaTbody"></tbody>
              </table>
            </div>
          </section>

          <!-- HISTORIAL -->
          <section class="card" style="grid-column:1/-1">
            <div class="card-header" style="padding:12px 16px;border-bottom:1px solid var(--line-clr);display:flex;align-items:center;justify-content:space-between">
              <div class="card-title" style="font-weight:800">Historial de Rutas</div>
              <div class="row">
                <button class="chip" id="btnExportHist">Exportar Historial</button>
                <button class="chip" id="btnImportHist">Importar Historial</button>
                <input type="file" id="histImportInput" accept=".json" class="hidden">
              </div>
            </div>
            <div class="card-body" style="overflow:auto; max-height:260px">
              <table class="table" style="border:0">
                <thead><tr><th>Fecha</th><th>Nombre</th><th>Paradas</th><th>Tiempo</th><th>Monto pico</th><th>Estado</th><th>Acciones</th></tr></thead>
                <tbody id="histTbody"></tbody>
              </table>
            </div>
          </section>
        </div>
      </section>

      <!-- ===== ÓRDENES ===== -->
      <section class="content hidden" id="ordenesSection" aria-label="Órdenes">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="ordQ" placeholder="Buscar por código/nombre/fecha" />
          </div>
          <span class="chip muted">Mostrando <strong id="ordCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="ordNew">Nuevo</button>
            <button class="chip" id="ordImport">Importar CSV</button>
            <button class="chip" id="ordExport">Exportar CSV</button>
            <button class="chip" id="ordTemplate">Descargar plantilla</button>
            <input type="file" id="ordImportInput" accept=".csv" class="hidden">
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="ordTable" aria-label="Listado de órdenes" style="border:0">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Categoría</th>
                  <th>Código/Nombre</th>
                  <th class="right">Monto</th>
                  <th>Moneda</th>
                  <th>Denominación</th>
                  <th>Servicio</th>
                  <th class="right">Peso (kg)</th>
                  <th>Lat</th>
                  <th>Lng</th>
                  <th>Usar</th>
                  <th>Editar</th>
                  <th>Borrar</th>
                </tr>
              </thead>
              <tbody id="ordTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== Sucursales ===== -->
      <section class="content hidden" id="sucSection" aria-label="Sucursales">
        <div class="row" role="search">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="sucQ" placeholder="Buscar Código o Nombre (Ctrl/⌘+K)" />
          </div>
          <span class="chip muted">Mostrando <strong id="sucCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="sucNew">Nuevo</button>
            <button class="chip" id="sucImport">Importar CSV</button>
            <button class="chip" id="sucExport">Exportar CSV</button>
            <button class="chip" id="sucLocate">Mi ubicación</button>
            <input type="file" id="sucImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <div class="panels" style="grid-template-columns:minmax(520px,1.1fr) minmax(360px,.9fr)">
          <section class="card">
            <div class="card-body" style="overflow:auto; max-height:460px">
              <table class="table" id="sucTable" role="grid" aria-label="Listado de Sucursales" style="border:0">
                <thead><tr><th>Código</th><th>Nombre</th><th>Lat</th><th>Lng</th><th>Cochera</th></tr></thead>
                <tbody id="sucTbody"></tbody>
              </table>
            </div>
          </section>
          <section class="card">
            <div class="card-body">
              <div class="map-skeleton" id="sucMapSkeleton">Cargando mapa…</div>
              <div id="sucMap" class="hidden"></div>
            </div>
          </section>
        </div>
      </section>

      <!-- ===== ATMs ===== -->
      <section class="content hidden" id="atmsSection" aria-label="ATMs">
        <div class="row" role="search">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="atmQ" placeholder="Buscar Código o Nombre (Ctrl/⌘+K)" />
          </div>
          <span class="chip muted">Mostrando <strong id="atmCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="atmNew">Nuevo</button>
            <button class="chip" id="atmImport">Importar CSV</button>
            <button class="chip" id="atmExport">Exportar CSV</button>
            <button class="chip" id="atmLocate">Mi ubicación</button>
            <input type="file" id="atmImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <div class="panels" style="grid-template-columns:minmax(520px,1.1fr) minmax(360px,.9fr)">
          <section class="card">
            <div class="card-body" style="overflow:auto; max-height:460px">
              <table class="table" id="atmTable" role="grid" aria-label="Listado de ATMs" style="border:0">
                <thead><tr><th>Código</th><th>Nombre</th><th>Lat</th><th>Lng</th></tr></thead>
                <tbody id="atmTbody"></tbody>
              </table>
            </div>
          </section>
          <section class="card">
            <div class="card-body">
              <div class="map-skeleton" id="atmMapSkeleton">Cargando mapa…</div>
              <div id="atmMap" class="hidden"></div>
            </div>
          </section>
        </div>
      </section>

      <!-- ===== CABECERAS ===== -->
      <section class="content hidden" id="cabSection" aria-label="Cabeceras">
        <div class="row" role="search">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="cabQ" placeholder="Buscar en cualquier campo (Ctrl/⌘+/)" />
          </div>
          <span class="chip muted">Mostrando <strong id="cabCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="cabNew">Nuevo</button>
            <button class="chip" id="cabImport">Importar CSV</button>
            <button class="chip" id="cabExport">Exportar CSV</button>
            <input type="file" id="cabImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:460px">
            <table class="table" id="cabTable" role="grid" aria-label="Listado de Cabeceras" style="border:0">
              <thead><tr><th>Código</th><th>Nombre</th><th>Dirección</th><th>Localidad</th><th>Lat</th><th>Lng</th><th>Supervisor</th><th>Teléfono</th></tr></thead>
              <tbody id="cabTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== OTROS BANCOS ===== -->
      <section class="content hidden" id="otrosSection" aria-label="Otros Bancos">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="otrosQ" placeholder="Buscar Bancos/Terceros" />
          </div>
          <span class="chip muted">Mostrando <strong id="otrosCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="otrosNew">Nuevo</button>
            <button class="chip" id="otrosImport">Importar CSV</button>
            <button class="chip" id="otrosExport">Exportar CSV</button>
            <input type="file" id="otrosImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="otrosTable" aria-label="Otros Bancos/Terceros">
              <thead><tr><th>Código</th><th>Nombre</th><th>Lat</th><th>Lng</th><th>Dirección</th></tr></thead>
              <tbody id="otrosTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== CHOFERES ===== -->
      <section class="content hidden" id="choferesSection" aria-label="Choferes">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="choQ" placeholder="Buscar chofer" />
          </div>
          <span class="chip muted">Mostrando <strong id="choCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="choNew">Nuevo</button>
            <button class="chip" id="choImport">Importar CSV</button>
            <button class="chip" id="choExport">Exportar CSV</button>
            <input type="file" id="choImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="choTable" aria-label="Choferes">
              <thead><tr><th>Legajo</th><th>Nombre</th><th>Licencia</th><th>Vencimiento</th><th>Teléfono</th></tr></thead>
              <tbody id="choTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== CAMIONES ===== -->
      <section class="content hidden" id="camionesSection" aria-label="Camiones">
        <div class="row">
          <div class="search">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/><path d="M21 21l-4.3-4.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <input id="camQ" placeholder="Buscar camión" />
          </div>
          <span class="chip muted">Mostrando <strong id="camCount">0</strong></span>
          <div class="row" style="margin-left:auto">
            <button class="chip" id="camNew">Nuevo</button>
            <button class="chip" id="camImport">Importar CSV</button>
            <button class="chip" id="camExport">Exportar CSV</button>
            <input type="file" id="camImportInput" accept=".csv" class="hidden" />
          </div>
        </div>
        <section class="card" style="margin-top:6px">
          <div class="card-body" style="overflow:auto; max-height:520px">
            <table class="table" id="camTable" aria-label="Camiones">
              <thead><tr><th>Patente/ID</th><th>Modelo</th><th>Capacidad $</th><th>Capacidad (kg)</th><th>Vel máx (km/h)</th></tr></thead>
              <tbody id="camTbody"></tbody>
            </table>
          </div>
        </section>
      </section>

      <!-- ===== COSTOS (placeholder sintético) ===== -->
      <section class="content hidden" id="costosSection" aria-label="Costos">
        <div style="font-weight:800;font-size:16px">Parámetros de Costos</div>
        <div class="panel">
          <div class="kv"><small>Costo por parada</small><div>$ 750</div></div>
          <div class="kv"><small>Costo por km (CABA)</small><div>$ 50</div></div>
          <div class="kv"><small>Costo por km (AMBA)</small><div>$ 55</div></div>
        </div>
      </section>

      <!-- ===== REPORTES (placeholder ligero) ===== -->
      <section class="content hidden" id="reportesSection" aria-label="Reportes">
        <div class="panel"><h3>Reportes</h3><p style="color:var(--muted-text);font-weight:700">Listo para integrarse con los reportes de la versión anterior.</p></div>
      </section>

      <!-- ===== CONFIGURACIÓN ===== -->
      <section class="content hidden" id="configSection" aria-label="Configuración">
        <div class="panel">
          <h3>Parámetros operativos</h3>
          <div class="row" style="flex-wrap:wrap">
            <span class="pill"><label>Monto máx. por camión</label><input id="cfgMaxMonto" type="number" value="200000000" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:160px;font-weight:800" /></span>
            <span class="pill"><label>Tiempo máx. ruta (min)</label><input id="cfgMaxMin" type="number" value="480" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:120px;font-weight:800" /></span>
            <span class="pill"><label>Velocidad base (km/h)</label><input id="cfgVel" type="number" value="40" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:100px;font-weight:800" /></span>
            <span class="pill"><label>Parada Sucursal (min)</label><input id="cfgStopSuc" type="number" value="5" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
            <span class="pill"><label>Parada ATM (min)</label><input id="cfgStopATM" type="number" value="15" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
            <span class="pill"><label>Parada Cabecera (min)</label><input id="cfgStopCab" type="number" value="10" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
            <span class="pill"><label>Parada BCRA/Otros (min)</label><input id="cfgStopExt" type="number" value="20" style="all:unset;border:1px solid var(--line-clr);padding:8px 10px;border-radius:10px;width:80px;font-weight:800" /></span>
          </div>
        </div>
        <div class="panel">
          <h3>Interfaz</h3>
          <div class="row">
            <span class="pill"><label>Fuente/escala</label><input id="cfgFont" type="range" min="0.9" max="1.2" step="0.01" value="1" /></span>
            <span class="pill"><label>Radio UI</label><input id="cfgRadius" type="range" min="10" max="22" step="1" value="14" /></span>
            <span class="pill"><label>Acento</label><input id="cfgAccent" type="color" value="#43a46d" /></span>
          </div>
        </div>
      </section>

      <!-- ===== ACERCA DE ===== -->
      <section class="content hidden" id="aboutSection" aria-label="Acerca de">
        <div class="about">
          <div class="head"><h2 class="title">Acerca de</h2></div>
          <p class="lead">Aplicación de optimización logística de rutas y flota de la Tesorería General del Banco de la Provincia de Buenos Aires. Versión 8.</p>
          <div class="about grid">
            <div class="card"><div class="body" style="padding:18px">
              <h4>Créditos</h4>
              <ul>
                <li>Idea, diseño y desarrollo: <strong>Gaston Jorge Contreras Deguin</strong></li>
                <li>Departamento de Presupuesto del Tesoro</li>
              </ul>
              <div class="version" style="margin-top:14px">
                <h4 style="margin:14px 0 10px">Versión</h4>
                <button class="chip" id="versionChip" data-copy="v8.0.0">v8.0.0</button>
              </div>
            </div></div>
            <div class="card"><div class="body" style="padding:0">
              <div class="banner"><div class="bapro">Gerencia de Tesorería General</div><div class="tag">Banco Provincia</div></div>
            </div></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== MODAL: Loader (camioncito) ===== -->
  <div class="modal" id="loaderModal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="loaderTitle" aria-describedby="loaderDesc">
    <div class="sheet" role="document">
      <div class="sheet-h">
        <div id="loaderTitle">Optimizando…</div>
        <button class="icon-btn small" id="loaderClose" aria-label="Cerrar">
          <svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="sheet-b">
        <div class="scene" id="scene">
          <div class="background"></div>
          <div class="foreground"></div>
          <img src="camioncito.png" alt="Camión de reparto" class="truck" loading="eager">
          <div class="smoke"></div><div class="dust"></div>
        </div>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="bar" id="progressBar"></div></div>
        <p class="status" id="loaderDesc">Preparando…</p>
      </div>
    </div>
  </div>

  <!-- ===== TOAST ===== -->
  <div class="toast" id="toast">Listo</div>

  <script>
  /* =====================================================================
     UTILIDADES / ESTADO GLOBAL
  ===================================================================== */
  const fmtES = new Intl.NumberFormat('es-AR', { maximumFractionDigits: 1 });
  const fmtMoney = (n) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits:0 }).format(n||0);
  const htmlEl = document.documentElement;

  // THEME
  const THEME_KEY = 'bp-theme';
  const savedTheme = localStorage.getItem(THEME_KEY);
  htmlEl.dataset.theme = savedTheme || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  const themeIcon = document.getElementById('themeIcon');
  function setIcon(){
    if(!themeIcon) return;
    themeIcon.innerHTML = (htmlEl.dataset.theme==='dark')
      ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'
      : '<circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>';
  }
  setIcon();
  document.getElementById('themeToggle')?.addEventListener('click', ()=>{
    htmlEl.dataset.theme = htmlEl.dataset.theme === 'dark' ? 'light' : 'dark';
    localStorage.setItem(THEME_KEY, htmlEl.dataset.theme);
    setIcon();
  });

  // NAV
  const sections = {
    dashboard: document.getElementById('dashboardSection'),
    rutas: document.getElementById('rutasSection'),
    ordenes: document.getElementById('ordenesSection'),
    sucursales: document.getElementById('sucSection'),
    atms: document.getElementById('atmsSection'),
    cabeceras: document.getElementById('cabSection'),
    otros: document.getElementById('otrosSection'),
    choferes: document.getElementById('choferesSection'),
    camiones: document.getElementById('camionesSection'),
    costos: document.getElementById('costosSection'),
    reportes: document.getElementById('reportesSection'),
    config: document.getElementById('configSection'),
    about: document.getElementById('aboutSection')
  };
  const topTitleText = document.getElementById('topTitleText');
  document.getElementById('nav')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    Object.values(sections).forEach(s=>s.classList.add('hidden'));
    const target = btn.dataset.target || 'dashboard';
    sections[target].classList.remove('hidden');
    topTitleText.textContent = btn.dataset.name || 'Dashboard';
    // Fix Leaflet sizing when becoming visible
    setTimeout(()=>{
      try{ if(window.routeMap) routeMap.invalidateSize(); if(window.sucMap) sucMap.invalidateSize(); if(window.atmMap) atmMap.invalidateSize(); }catch(e){}
    }, 80);
  });

  // TOAST
  const toast = document.getElementById('toast');
  function showToast(text="Listo"){
    toast.textContent = text;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.classList.remove('show'), 1600);
  }

  /* =====================================================================
     AUTH + SPLASH
  ===================================================================== */
  (function(){
    const AUTH_KEY = 'bp-auth';
    const MAX_AGE = 1000 * 60 * 60 * 8; // 8 horas
    const USERS = {
      "1001@oper": { pwd:"oper123", name:"Operador", role:"oper" },
      "2001@super": { pwd:"super123", name:"Supervisor", role:"super" },
      "admin@tesoro": { pwd:"admin123", name:"Administrador", role:"admin" }
    };
    const appRoot   = document.getElementById('appRoot');
    const loginView = document.getElementById('loginView');
    const loginForm = document.getElementById('loginForm');
    const userEl    = document.getElementById('usuario');
    const passEl    = document.getElementById('password');
    const err       = document.getElementById('loginError');
    const remember  = document.getElementById('remember');
    const userChip  = document.getElementById('userChip');
    const logoutBtn = document.getElementById('logoutBtn');
    const splash    = document.getElementById('splash');

    function getSession(){ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)) || null; }catch(e){ return null; } }
    function setSession(s){ localStorage.setItem(AUTH_KEY, JSON.stringify(s)); }
    function clearSession(){ localStorage.removeItem(AUTH_KEY); }

    function isSessionValid(s){
      if(!s || !s.user) return false;
      const age = Date.now() - (s.ts||0);
      if(s.remember) return true;
      return age < MAX_AGE;
    }

    function showApp(){
      loginView.classList.add('hidden');
      appRoot.classList.remove('hidden');
      appRoot.removeAttribute('aria-hidden');
      const s = getSession();
      if(userChip && s){ userChip.textContent = s.name || s.user; userChip.classList.remove('hidden'); }
      // splash al ingresar
      splash.classList.add('is-open');
      // Leaflet sizing
      setTimeout(()=>{ try{ if(window.routeMap) routeMap.invalidateSize(); }catch(e){} }, 200);
      setTimeout(()=>{ splash.classList.remove('is-open'); splash.setAttribute('aria-hidden','true'); }, 2400);
    }

    function showLogin(){
      appRoot.classList.add('hidden'); appRoot.setAttribute('aria-hidden','true');
      loginView.classList.remove('hidden');
      if(err) err.textContent = '';
      userEl && userEl.focus();
    }

    function tryAuto(){ const s = getSession(); if(isSessionValid(s)) showApp(); else showLogin(); }

    loginForm?.addEventListener('submit', (ev)=>{
      ev.preventDefault();
      if(!userEl.value || !passEl.value){ err.textContent = 'Completá usuario y contraseña'; return; }
      const u = (userEl.value||'').trim(); const p = passEl.value;
      const ok = !!u && !!p && ((USERS[u] && USERS[u].pwd===p) || (!USERS[u] && p==='bapro')); // fallback demo
      if(ok){
        const profile = USERS[u] || {name: u, role: 'invitado'};
        setSession({ user:u, name:profile.name, role:profile.role, ts:Date.now(), remember: !!remember?.checked });
        passEl.value = ''; showApp();
      }else{
        err.textContent = 'Usuario o contraseña inválidos';
      }
    });

    logoutBtn?.addEventListener('click', ()=>{ clearSession(); showToast('Sesión cerrada'); showLogin(); });

    tryAuto();
  })();

  /* =====================================================================
     CHARTS DASHBOARD (ligeros)
  ===================================================================== */
  (function(){
    function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
    const barCtx = document.getElementById('montosChart');
    if(barCtx){
      const bar = new Chart(barCtx, {
        type: 'bar',
        data: { labels: ['mar. 9','mar. 10','mar. 12','mar. 12','mar. 14'],
          datasets: [{ label: 'Montos (M)', data: [4.4,3.5,2.6,1.9,1.4], backgroundColor: cssVar('--chart-accent')||'rgba(67,164,109,.85)', borderRadius: 6, borderSkipped: false, maxBarThickness: 46 }]},
        options: { animation:{duration:700}, plugins:{ legend:{display:false} },
          scales:{ x:{ grid:{display:false} }, y:{ grid:{color:cssVar('--chart-grid')}, suggestedMax:5 } }
        }
      });
    }
    const pieCtx = document.getElementById('entregasChart');
    if(pieCtx){
      new Chart(pieCtx, { type:'doughnut', data:{ labels:['Sucursales','ATMs'],
        datasets:[{ data:[68.7,31.3], backgroundColor:[cssVar('--chart-accent-2')||'#3b9562', cssVar('--brand-200')||'#c8ecd7'], borderColor:['#eaf7ef','#f3faf6'], borderWidth:2 }]},
        options:{ cutout:'62%', rotation:-40, plugins:{ legend:{display:false} } } });
    }
    const lineCtx = document.getElementById('fallidasChart');
    if(lineCtx){
      const grad = lineCtx.getContext('2d').createLinearGradient(0,0,0,160); grad.addColorStop(0, 'rgba(67,164,109,.18)'); grad.addColorStop(1,'rgba(67,164,109,0)');
      new Chart(lineCtx, { type:'line',
        data:{ labels:['abr. 2','abr. 4','abr. 6','abr. 7','abr. 8','abr. 10','abr. 4','abr. 10','abr. 10'],
               datasets:[{ data:[2,3,7,6,3,5,4,6,3], borderColor: cssVar('--chart-accent-2')||'#3b9562', backgroundColor: grad, tension:.35, fill:true, pointRadius:3, pointBackgroundColor:'#fff', pointBorderWidth:2 }]},
        options:{ plugins:{ legend:{display:false} }, scales:{ x:{grid:{display:false}}, y:{grid:{color:cssVar('--chart-grid')}, suggestedMax:10} } }
      });
    }
  })();

  /* =====================================================================
     HELPERS CSV + GEO + LEAFLET
  ===================================================================== */
  function parseNumber(x){
    if(typeof x === 'number') return x;
    if(!x) return NaN;
    const s = String(x).trim().replace(/\./g,'').replace(',', '.').replace(/[^0-9\.\-]/g, '');
    return parseFloat(s);
  }
  function haversine(lat1, lon1, lat2, lon2){
    const R = 6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); // km
  }
  function waitForLeaflet(){
    return new Promise(res=>{
      (function check(){ if(window.L && typeof L.map==='function') res(); else setTimeout(check, 40); })();
    });
  }
  function clamp(i, min, max){ return Math.max(min, Math.min(max, i)); }
  function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function fmtCoord(n){
    if(n === null || n === undefined || n === '') return '—';
    const num = typeof n === 'number' ? n : parseNumber(n);
    return Number.isFinite(num) ? num.toFixed(4) : '—';
  }

  /* =====================================================================
     BASES DE DATOS (localStorage) y Seeds
  ===================================================================== */
  const DB = {
    atms: 'db-atms-v3',
    suc:  'db-suc-v3',
    cab:  'db-cab-v3',
    otros:'db-otros-v1',
    cho:  'db-cho-v1',
    cam:  'db-cam-v1',
    ord:  'db-ord-v2',
    hist: 'db-routes-history-v3',
    cfg:  'db-config-v3'
  };
  function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch(e){ return fallback; } }
  function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  const seedATMs = [
    {codigo:"50007", nombre:"América",     lat:-35.426, lng:-61.306},
    {codigo:"50009", nombre:"Ayacucho",    lat:-37.149, lng:-57.139},
    {codigo:"50010", nombre:"Bahía Blanca",lat:-38.715, lng:-62.268},
    {codigo:"50012", nombre:"Bragado",     lat:-35.119, lng:-60.494}
  ];
  const seedSuc = [
    {codigo:"10001", nombre:"Bahía Blanca - Centro", lat:-38.718, lng:-62.268, cochera:false},
    {codigo:"10002", nombre:"La Plata - Catedral",   lat:-34.921, lng:-57.954, cochera:true},
    {codigo:"10003", nombre:"Mar del Plata",         lat:-38.002, lng:-57.556, cochera:false}
  ];
  const seedCab = [
    {codigo:"0106", nombre:"Quilmes", direccion:"Av. Calchaquí", localidad:"Quilmes", supervisor:"M. Ruiz", telefono:"11-23456", lat:-34.7206, lng:-58.2546},
    {codigo:"0101", nombre:"La Plata", direccion:"Av. 7 925", localidad:"La Plata", supervisor:"J. Pérez", telefono:"11-12348", lat:-34.9214, lng:-57.9545}
  ];
  const seedOtros = [
    {codigo:"BCRA01", nombre:"BCRA", lat:-34.6037, lng:-58.3816, direccion:"Reconquista 266"},
    {codigo:"OTRO01", nombre:"Otro Banco X", lat:-34.6, lng:-58.44, direccion:"Av. Siempre Viva 123"}
  ];
  const seedCho = [
    {legajo:"C001", nombre:"Juan Pérez", licencia:"C1", vto:"2026-06-30", tel:"11-1234-5678"},
    {legajo:"C002", nombre:"María López", licencia:"C2", vto:"2025-11-15", tel:"11-2345-6789"}
  ];
  const seedCam = [
    {id:"TRK101", modelo:"Iveco Daily", capMonto:200000000, capKg:1500, velMax:60},
    {id:"TRK102", modelo:"Mercedes Sprinter", capMonto:250000000, capKg:1700, velMax:65}
  ];
  const seedOrd = [
    {id:uuid(), fecha:"2025-08-22", categoria:"ATM", codigo:"50010", nombre:"Bahía Blanca", lat:-38.715, lng:-62.268, monto:-30000000, moneda:"ARS", denominacion:"$1000", servicio:"Abastecimiento", peso:20, usar:false},
    {id:uuid(), fecha:"2025-08-22", categoria:"Sucursal", codigo:"10003", nombre:"Mar del Plata", lat:-38.002, lng:-57.556, monto:45000000, moneda:"ARS", denominacion:"Mixta", servicio:"Retiro", peso:30, usar:false}
  ];

  // CONFIG por defecto
  const cfg = Object.assign({
    maxMonto: 200000000, // $
    maxMin:   480,       // minutos
    vel:      40,        // km/h
    stopSuc:  5,         // min
    stopATM:  15,        // min
    stopCab:  10,        // min
    stopExt:  20,        // min
    uiFont:   1,
    uiRadius: 14,
    uiAccent: '#43a46d',
    trafficFactor: 1.0
  }, load(DB.cfg, {}));
  applyUIConfig();

  function applyUIConfig(){
    document.documentElement.style.setProperty('--ui-fontscale', String(cfg.uiFont||1));
    document.documentElement.style.setProperty('--ui-radius', (cfg.uiRadius||14)+'px');
    document.documentElement.style.setProperty('--ui-accent', cfg.uiAccent||'#43a46d');
  }

  /* =====================================================================
     CSV IMPORT/EXPORT HELPERS
  ===================================================================== */
  function csvParse(text, sepGuess=','){
    const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
    if(!lines.length) return { headers:[], rows:[] };
    const sep = (lines[0].includes(';') && !lines[0].includes(',')) ? ';' : sepGuess;
    const headers = lines[0].split(sep).map(h=>h.trim());
    const rows = [];
    for(let i=1;i<lines.length;i++){
      const row = []; let cur='', inQ=false;
      const s = lines[i];
      for(let j=0;j<s.length;j++){
        const ch = s[j];
        if(ch==='\"'){ inQ = !inQ; continue; }
        if(ch===sep && !inQ){ row.push(cur); cur=''; } else cur+=ch;
      }
      row.push(cur);
      rows.push(row);
    }
    return { headers, rows };
  }
  function csvExport(arr, headers){
    const hdr = headers;
    const csv = [hdr.join(',')].concat(arr.map(o => hdr.map(h => {
      const v = (o[h]===undefined || o[h]===null) ? '' : String(o[h]);
      const needs = /[,"\n]/.test(v);
      return needs ? ('"'+v.replace(/"/g,'""')+'"') : v;
    }).join(','))).join('\n');
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement("a"), { href:url, download:"export.csv" });
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /* =====================================================================
     MÓDULO DATOS ENTIDADES (ATMs, Suc, Cab, Otros, Choferes, Camiones)
  ===================================================================== */
  const State = {
    atms: load(DB.atms, seedATMs),
    suc: load(DB.suc, seedSuc),
    cab: load(DB.cab, seedCab),
    otros: load(DB.otros, seedOtros),
    cho: load(DB.cho, seedCho),
    cam: load(DB.cam, seedCam),
    ord: load(DB.ord, seedOrd),
    hist: load(DB.hist, [])
  };

  // ========= Sucursales =========
  (function(){
    const tbody = document.getElementById('sucTbody');
    const cntEl = document.getElementById('sucCount');
    const qEl = document.getElementById('sucQ');
    let sucMap, sucMarker;

    function render(){
      const q = (qEl.value||'').toLowerCase();
      const arr = State.suc.filter(r=> !q || r.codigo.includes(q) || (r.nombre||'').toLowerCase().includes(q));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `
        <tr data-cod="${r.codigo}">
          <td>${r.codigo}</td><td>${r.nombre||''}</td><td class="right">${fmtCoord(r.lat)}</td><td class="right">${fmtCoord(r.lng)}</td><td>${r.cochera?'Sí':'No'}</td>
        </tr>
      `).join('');
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        tr.addEventListener('click', ()=>{
          const cod = tr.dataset.cod;
          const r = State.suc.find(x=>x.codigo===cod);
          if(r && sucMap){ sucMarker.setLatLng([r.lat,r.lng]); sucMap.flyTo([r.lat,r.lng], 12, {duration:.6}); }
        });
      });
    }
    qEl?.addEventListener('input', render);

    // CSV import/export
    document.getElementById('sucImport')?.addEventListener('click', ()=> document.getElementById('sucImportInput').click());
    document.getElementById('sucImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h)),
          cochera: headers.findIndex(h=>/cochera/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = parseNumber(cells[idx.lat]); const lng = parseNumber(cells[idx.lng]);
          return { codigo: (cells[idx.codigo]||'').trim(), nombre:(cells[idx.nombre]||'').trim(), lat, lng, cochera: String(cells[idx.cochera]||'').toLowerCase().startsWith('s') };
        }).filter(r=>r.codigo && r.nombre && isFinite(r.lat) && isFinite(r.lng));
        if(out.length){ State.suc = out; save(DB.suc, State.suc); render(); showToast('Sucursales importadas'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('sucExport')?.addEventListener('click', ()=>{
      csvExport(State.suc, ['codigo','nombre','lat','lng','cochera']);
    });

    // Mapa
    waitForLeaflet().then(()=>{
      const sk = document.getElementById('sucMapSkeleton'); const el = document.getElementById('sucMap'); if(!el) return;
      sk.classList.add('hidden'); el.classList.remove('hidden');
      sucMap = L.map('sucMap', { zoomControl:true, minZoom:3 }); 
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(sucMap);
      sucMarker = L.marker([State.suc[0]?.lat||-34.60, State.suc[0]?.lng||-58.38]).addTo(sucMap);
      sucMap.setView([State.suc[0]?.lat||-34.60, State.suc[0]?.lng||-58.38], 10);
    });

    // Quick actions
    document.getElementById('sucNew')?.addEventListener('click', ()=>{
      const cod = String(Math.max(0,...State.suc.map(r=>+r.codigo||0))+1).padStart(5,'0');
      State.suc.push({codigo:cod, nombre:'Nueva', lat:-34.6, lng:-58.38, cochera:false});
      save(DB.suc, State.suc); render();
    });
    document.getElementById('sucLocate')?.addEventListener('click', ()=>{
      if(!navigator.geolocation) return showToast('Sin geolocalización');
      navigator.geolocation.getCurrentPosition(pos=>{
        sucMap && sucMap.flyTo([pos.coords.latitude, pos.coords.longitude], 12, {duration:.8});
      });
    });

    render();
  })();

  // ========= ATMs =========
  (function(){
    const tbody = document.getElementById('atmTbody');
    const cntEl = document.getElementById('atmCount');
    const qEl = document.getElementById('atmQ');
    let atmMap, atmMarker;

    function render(){
      const q = (qEl.value||'').toLowerCase();
      const arr = State.atms.filter(r=> !q || r.codigo.includes(q) || (r.nombre||'').toLowerCase().includes(q));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `
        <tr data-cod="${r.codigo}"><td>${r.codigo}</td><td>${r.nombre||''}</td><td class="right">${fmtCoord(r.lat)}</td><td class="right">${fmtCoord(r.lng)}</td></tr>
      `).join('');
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        tr.addEventListener('click', ()=>{
          const r = State.atms.find(x=>x.codigo===tr.dataset.cod);
          if(r && atmMap){ atmMarker.setLatLng([r.lat,r.lng]); atmMap.flyTo([r.lat,r.lng], 12, {duration:.6}); }
        });
      });
    }
    qEl?.addEventListener('input', render);

    document.getElementById('atmImport')?.addEventListener('click', ()=> document.getElementById('atmImportInput').click());
    document.getElementById('atmImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = parseNumber(cells[idx.lat]); const lng = parseNumber(cells[idx.lng]);
          return { codigo: (cells[idx.codigo]||'').trim().padStart(5,'0'), nombre:(cells[idx.nombre]||'').trim(), lat, lng };
        }).filter(r=>r.codigo && r.nombre && isFinite(r.lat) && isFinite(r.lng));
        if(out.length){ State.atms = out; save(DB.atms, State.atms); render(); showToast('ATMs importados'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('atmExport')?.addEventListener('click', ()=> csvExport(State.atms, ['codigo','nombre','lat','lng']));

    waitForLeaflet().then(()=>{
      const sk = document.getElementById('atmMapSkeleton'); const el = document.getElementById('atmMap'); if(!el) return;
      sk.classList.add('hidden'); el.classList.remove('hidden');
      atmMap = L.map('atmMap', { zoomControl:true, minZoom:3 });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(atmMap);
      atmMarker = L.marker([State.atms[0]?.lat||-34.60, State.atms[0]?.lng||-58.38]).addTo(atmMap);
      atmMap.setView([State.atms[0]?.lat||-34.60, State.atms[0]?.lng||-58.38], 10);
    });

    document.getElementById('atmNew')?.addEventListener('click', ()=>{
      const cod = String(Math.max(0,...State.atms.map(r=>+r.codigo||0))+1).padStart(5,'0');
      State.atms.push({codigo:cod, nombre:'Nuevo', lat:-34.6, lng:-58.38});
      save(DB.atms, State.atms); render();
    });
    document.getElementById('atmLocate')?.addEventListener('click', ()=>{
      if(!navigator.geolocation) return showToast('Sin geolocalización');
      navigator.geolocation.getCurrentPosition(pos=>{
        atmMap && atmMap.flyTo([pos.coords.latitude, pos.coords.longitude], 12, {duration:.8});
      });
    });

    render();
  })();

  // ========= Cabeceras =========
  (function(){
    const tbody = document.getElementById('cabTbody');
    const cntEl = document.getElementById('cabCount');
    const qEl = document.getElementById('cabQ');
    const selOrigen = document.getElementById('selOrigen');

    function render(){
      const q = (qEl.value||'').toLowerCase();
      const arr = State.cab.filter(r => !q || Object.values(r).some(v => (''+v).toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `
        <tr>
          <td>${r.codigo}</td>
          <td>${r.nombre||''}</td>
          <td>${r.direccion||''}</td>
          <td>${r.localidad||''}</td>
          <td class="right">${fmtCoord(r.lat)}</td>
          <td class="right">${fmtCoord(r.lng)}</td>
          <td>${r.supervisor||''}</td>
          <td>${r.telefono||''}</td>
        </tr>
      `).join('');
      if(selOrigen){
        const prev = selOrigen.value;
        const validCab = State.cab.filter(c => Number.isFinite(parseNumber(c.lat)) && Number.isFinite(parseNumber(c.lng)));
        selOrigen.innerHTML = '<option value="">—</option>' + validCab.map(c => `<option value="${c.codigo}">${c.codigo} — ${c.nombre}</option>`).join('');
        if(validCab.some(c => c.codigo === prev)){
          selOrigen.value = prev;
        }else if(prev){
          selOrigen.value = '';
          selOrigen.dispatchEvent(new Event('change'));
        }
      }
    }
    qEl?.addEventListener('input', render);

    document.getElementById('cabImport')?.addEventListener('click', ()=> document.getElementById('cabImportInput').click());
    document.getElementById('cabImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          direccion: headers.findIndex(h=>/direccion/i.test(h)),
          localidad: headers.findIndex(h=>/localidad/i.test(h)),
          lat: headers.findIndex(h=>/(^lat$|latitud)/i.test(h)),
          lng: headers.findIndex(h=>/(^lng$|^lon$|longitud)/i.test(h)),
          supervisor: headers.findIndex(h=>/supervisor/i.test(h)),
          telefono: headers.findIndex(h=>/telefono/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = idx.lat>=0 ? parseNumber(cells[idx.lat]) : NaN;
          const lng = idx.lng>=0 ? parseNumber(cells[idx.lng]) : NaN;
          return {
            codigo:(cells[idx.codigo]||'').trim(),
            nombre:(cells[idx.nombre]||'').trim(),
            direccion:(cells[idx.direccion]||'').trim(),
            localidad:(cells[idx.localidad]||'').trim(),
            lat: Number.isFinite(lat) ? lat : null,
            lng: Number.isFinite(lng) ? lng : null,
            supervisor:(cells[idx.supervisor]||'').trim(),
            telefono:(cells[idx.telefono]||'').trim()
          };
        }).filter(r=>r.codigo && r.nombre);
        if(out.length){ State.cab = out; save(DB.cab, State.cab); render(); showToast('Cabeceras importadas'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('cabExport')?.addEventListener('click', ()=> csvExport(State.cab, ['codigo','nombre','direccion','localidad','lat','lng','supervisor','telefono']));

    document.getElementById('cabNew')?.addEventListener('click', ()=>{
      const cod = String(Math.max(0,...State.cab.map(r=>parseInt(r.codigo)||0))+1).padStart(4,'0');
      State.cab.push({codigo:cod, nombre:'Nueva', direccion:'—', localidad:'—', lat:null, lng:null, supervisor:'—', telefono:'—'});
      save(DB.cab, State.cab); render();
    });

    render();
  })();

  // ========= Otros Bancos =========
  (function(){
    const tbody = document.getElementById('otrosTbody'); const cntEl = document.getElementById('otrosCount'); const qEl = document.getElementById('otrosQ');
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.otros.filter(r=> !q || (r.codigo||'').toLowerCase().includes(q) || (r.nombre||'').toLowerCase().includes(q));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `<tr><td>${r.codigo||''}</td><td>${r.nombre||''}</td><td>${fmtCoord(r.lat)}</td><td>${fmtCoord(r.lng)}</td><td>${r.direccion||''}</td></tr>`).join('');
    }
    qEl?.addEventListener('input', render);
    document.getElementById('otrosImport')?.addEventListener('click', ()=> document.getElementById('otrosImportInput').click());
    document.getElementById('otrosImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h)),
          direccion: headers.findIndex(h=>/direccion/i.test(h))
        };
        const out = rows.map(cells => {
          const lat = parseNumber(cells[idx.lat]); const lng = parseNumber(cells[idx.lng]);
          return { codigo:(cells[idx.codigo]||'').trim(), nombre:(cells[idx.nombre]||'').trim(), lat, lng, direccion:(cells[idx.direccion]||'').trim() };
        }).filter(r=>r.codigo && isFinite(r.lat) && isFinite(r.lng));
        if(out.length){ State.otros = out; save(DB.otros, State.otros); render(); showToast('Otros bancos importados'); }
      };
      reader.readAsText(f);
      ev.target.value='';
    });
    document.getElementById('otrosExport')?.addEventListener('click', ()=> csvExport(State.otros, ['codigo','nombre','lat','lng','direccion']));
    document.getElementById('otrosNew')?.addEventListener('click', ()=>{
      State.otros.push({codigo:'OTRO'+String(State.otros.length+1).padStart(2,'0'), nombre:'Nuevo', lat:-34.6, lng:-58.38, direccion:'—'});
      save(DB.otros, State.otros); render();
    });
    render();
  })();

  // ========= Choferes =========
  (function(){
    const tbody = document.getElementById('choTbody'); const cntEl = document.getElementById('choCount'); const qEl = document.getElementById('choQ');
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.cho.filter(r=> !q || Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `<tr><td>${r.legajo}</td><td>${r.nombre}</td><td>${r.licencia}</td><td>${r.vto}</td><td>${r.tel||''}</td></tr>`).join('');
    }
    qEl?.addEventListener('input', render);
    document.getElementById('choImport')?.addEventListener('click', ()=> document.getElementById('choImportInput').click());
    document.getElementById('choImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return; const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {legajo: headers.indexOf('legajo'), nombre: headers.indexOf('nombre'), licencia: headers.indexOf('licencia'), vto: headers.indexOf('vto'), tel: headers.indexOf('tel')};
        const out = rows.map(c => ({legajo:c[idx.legajo], nombre:c[idx.nombre], licencia:c[idx.licencia], vto:c[idx.vto], tel:c[idx.tel]})).filter(r=>r.legajo && r.nombre);
        if(out.length){ State.cho = out; save(DB.cho, State.cho); render(); showToast('Choferes importados'); }
      };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('choExport')?.addEventListener('click', ()=> csvExport(State.cho, ['legajo','nombre','licencia','vto','tel']));
    document.getElementById('choNew')?.addEventListener('click', ()=>{
      State.cho.push({legajo:'C'+String(State.cho.length+1).padStart(3,'0'), nombre:'Nuevo', licencia:'C1', vto:'2026-01-01', tel:''});
      save(DB.cho, State.cho); render();
    });
    render();
  })();

  // ========= Camiones =========
  (function(){
    const tbody = document.getElementById('camTbody'); const cntEl = document.getElementById('camCount'); const qEl = document.getElementById('camQ');
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.cam.filter(r=> !q || Object.values(r).some(v => String(v).toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `<tr><td>${r.id}</td><td>${r.modelo||''}</td><td class="right">${fmtMoney(r.capMonto||0)}</td><td class="right">${r.capKg||0}</td><td class="right">${r.velMax||0}</td></tr>`).join('');
    }
    qEl?.addEventListener('input', render);
    document.getElementById('camImport')?.addEventListener('click', ()=> document.getElementById('camImportInput').click());
    document.getElementById('camImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return; const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {id: headers.indexOf('id'), modelo: headers.indexOf('modelo'), capMonto: headers.indexOf('capMonto'), capKg: headers.indexOf('capKg'), velMax: headers.indexOf('velMax')};
        const out = rows.map(c => ({id:c[idx.id], modelo:c[idx.modelo], capMonto: parseNumber(c[idx.capMonto]), capKg: parseNumber(c[idx.capKg]), velMax: parseNumber(c[idx.velMax])})).filter(r=>r.id);
        if(out.length){ State.cam = out; save(DB.cam, State.cam); render(); showToast('Camiones importados'); }
      };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('camExport')?.addEventListener('click', ()=> csvExport(State.cam, ['id','modelo','capMonto','capKg','velMax']));
    document.getElementById('camNew')?.addEventListener('click', ()=>{
      State.cam.push({id:'TRK'+String(State.cam.length+1).padStart(3,'0'), modelo:'Nuevo', capMonto:200000000, capKg:1500, velMax:60});
      save(DB.cam, State.cam); render();
    });
    render();
  })();

  /* =====================================================================
     ÓRDENES (CRUD + CSV)
  ===================================================================== */
  (function(){
    const tbody = document.getElementById('ordTbody'); const cntEl = document.getElementById('ordCount'); const qEl = document.getElementById('ordQ');
    const sel = (s,sc)=> (sc||document).querySelector(s);
    function render(){
      const q=(qEl.value||'').toLowerCase();
      const arr = State.ord.filter(r=> !q || [r.fecha, r.categoria, r.codigo, r.nombre, r.servicio].some(v => String(v||'').toLowerCase().includes(q)));
      cntEl.textContent = arr.length;
      tbody.innerHTML = arr.map(r => `
        <tr data-id="${r.id}">
          <td>${r.fecha||''}</td><td>${r.categoria||''}</td><td>${(r.codigo||'')+' — '+(r.nombre||'')}</td>
          <td class="right">${fmtMoney(r.monto||0)}</td><td>${r.moneda||'ARS'}</td><td>${r.denominacion||''}</td><td>${r.servicio||''}</td>
          <td class="right">${r.peso||0}</td><td>${r.lat??''}</td><td>${r.lng??''}</td>
          <td><input type="checkbox" ${r.usar?'checked':''} data-act="usar" /></td>
          <td><button class="chip" data-act="edit">Editar</button></td>
          <td><button class="chip" data-act="del">Borrar</button></td>
        </tr>`).join('');
      [...tbody.querySelectorAll('input[data-act="usar"]')].forEach(inp=>{
        inp.addEventListener('change', (ev)=>{
          const id = ev.target.closest('tr').dataset.id;
          const o = State.ord.find(x=>x.id===id); if(o){ o.usar = !!ev.target.checked; save(DB.ord, State.ord); }
        });
      });
      [...tbody.querySelectorAll('button[data-act="edit"]')].forEach(btn=>{
        btn.addEventListener('click', ()=> editRow(btn.closest('tr').dataset.id));
      });
      [...tbody.querySelectorAll('button[data-act="del"]')].forEach(btn=>{
        btn.addEventListener('click', ()=> delRow(btn.closest('tr').dataset.id));
      });
    }
    qEl?.addEventListener('input', render);

    function editRow(id){
      const o = State.ord.find(x=>x.id===id) || {id:uuid(), fecha:'', categoria:'', codigo:'', nombre:'', lat:'', lng:'', monto:0, moneda:'ARS', denominacion:'', servicio:'', peso:0, usar:false};
      const html = `
        <div class="field"><label>Fecha</label><input id="fFecha" type="date" value="${o.fecha||''}"></div>
        <div class="field"><label>Categoría</label><input id="fCat" value="${o.categoria||''}" placeholder="Sucursal/ATM/Cabecera/BCRA/Otro"></div>
        <div class="field"><label>Código</label><input id="fCod" value="${o.codigo||''}"></div>
        <div class="field"><label>Nombre</label><input id="fNom" value="${o.nombre||''}"></div>
        <div class="field"><label>Lat</label><input id="fLat" value="${o.lat??''}"></div>
        <div class="field"><label>Lng</label><input id="fLng" value="${o.lng??''}"></div>
        <div class="field"><label>Monto (negativo=entrega)</label><input id="fMonto" value="${o.monto??0}"></div>
        <div class="field"><label>Moneda</label><input id="fMon" value="${o.moneda||'ARS'}"></div>
        <div class="field"><label>Denominación</label><input id="fDen" value="${o.denominacion||''}"></div>
        <div class="field"><label>Servicio</label><input id="fServ" value="${o.servicio||''}" placeholder="Abastecimiento/Retiro/Transferencia/Descarga"></div>
        <div class="field"><label>Peso (kg)</label><input id="fPeso" value="${o.peso||0}"></div>
      `;
      openSmallModal('Editar orden', html, ()=>{
        Object.assign(o, {
          fecha: sel('#fFecha').value, categoria: sel('#fCat').value, codigo: sel('#fCod').value, nombre: sel('#fNom').value,
          lat: parseNumber(sel('#fLat').value), lng: parseNumber(sel('#fLng').value), monto: parseNumber(sel('#fMonto').value),
          moneda: sel('#fMon').value, denominacion: sel('#fDen').value, servicio: sel('#fServ').value, peso: parseNumber(sel('#fPeso').value)
        });
        if(!State.ord.find(x=>x.id===o.id)) State.ord.push(o);
        save(DB.ord, State.ord); render(); showToast('Orden guardada');
      });
    }
    function delRow(id){
      const i = State.ord.findIndex(x=>x.id===id); if(i<0) return;
      if(confirm('¿Eliminar orden?')){ State.ord.splice(i,1); save(DB.ord, State.ord); render(); }
    }

    // Botones
    document.getElementById('ordNew')?.addEventListener('click', ()=> editRow(null));
    document.getElementById('ordImport')?.addEventListener('click', ()=> document.getElementById('ordImportInput').click());
    document.getElementById('ordImportInput')?.addEventListener('change', (ev)=>{
      const f = ev.target.files?.[0]; if(!f) return; const reader = new FileReader();
      reader.onload = (e)=>{
        const {headers, rows} = csvParse(e.target.result);
        const idx = {
          fecha: headers.findIndex(h=>/fecha/i.test(h)),
          categoria: headers.findIndex(h=>/categoria/i.test(h)),
          codigo: headers.findIndex(h=>/codigo/i.test(h)),
          nombre: headers.findIndex(h=>/nombre/i.test(h)),
          monto: headers.findIndex(h=>/monto/i.test(h)),
          moneda: headers.findIndex(h=>/moneda/i.test(h)),
          denominacion: headers.findIndex(h=>/denominacion/i.test(h)),
          servicio: headers.findIndex(h=>/servicio/i.test(h)),
          peso: headers.findIndex(h=>/peso/i.test(h)),
          lat: headers.findIndex(h=>/^lat/i.test(h)),
          lng: headers.findIndex(h=>/^lng|long/i.test(h))
        };
        const out = rows.map(c => ({
          id: uuid(),
          fecha: c[idx.fecha]||'',
          categoria: c[idx.categoria]||'',
          codigo: c[idx.codigo]||'',
          nombre: c[idx.nombre]||'',
          monto: parseNumber(c[idx.monto]), moneda: c[idx.moneda]||'ARS', denominacion: c[idx.denominacion]||'',
          servicio: c[idx.servicio]||'', peso: parseNumber(c[idx.peso]),
          lat: parseNumber(c[idx.lat]), lng: parseNumber(c[idx.lng]), usar:false
        })).filter(o => o.categoria && isFinite(o.lat) && isFinite(o.lng));
        if(out.length){ State.ord = out; save(DB.ord, State.ord); render(); showToast('Órdenes importadas'); }
      };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('ordExport')?.addEventListener('click', ()=> csvExport(State.ord, ['id','fecha','categoria','codigo','nombre','monto','moneda','denominacion','servicio','peso','lat','lng','usar']));
    document.getElementById('ordTemplate')?.addEventListener('click', ()=>{
      const sample = [
        {fecha:'2025-08-23', categoria:'ATM', codigo:'50010', nombre:'Bahía Blanca', monto:-30000000, moneda:'ARS', denominacion:'$1000', servicio:'Abastecimiento', peso:20, lat:-38.715, lng:-62.268},
        {fecha:'2025-08-23', categoria:'Sucursal', codigo:'10003', nombre:'Mar del Plata', monto:45000000, moneda:'ARS', denominacion:'Mixta', servicio:'Retiro', peso:30, lat:-38.002, lng:-57.556}
      ];
      csvExport(sample, ['fecha','categoria','codigo','nombre','monto','moneda','denominacion','servicio','peso','lat','lng']);
    });

    render();
  })();

  /* =====================================================================
     UI: Modal pequeño reutilizable
  ===================================================================== */
  function openSmallModal(title, innerHTML, onAccept){
    const m = document.createElement('div'); m.className='modal open';
    m.innerHTML = `
      <div class="sheet" role="dialog" aria-modal="true">
        <div class="sheet-h"><div>${title||''}</div><button class="icon-btn small" id="mClose"><svg viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></button></div>
        <div class="sheet-b" id="mBody" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">${innerHTML||''}</div>
        <div style="display:flex;gap:10px;justify-content:flex-end;padding:0 16px 12px">
          <button class="chip" id="mCancel">Cancelar</button>
          <button class="chip" id="mOk" style="background: linear-gradient(180deg, rgba(47,187,107,.24), rgba(47,187,107,.08)); border-color:rgba(47,187,107,.32)">Guardar</button>
        </div>
      </div>`;
    document.body.appendChild(m);
    const close = ()=>{ m.remove(); };
    m.addEventListener('click', (e)=>{ if(e.target===m) close(); });
    m.querySelector('#mClose').addEventListener('click', close);
    m.querySelector('#mCancel').addEventListener('click', close);
    m.querySelector('#mOk').addEventListener('click', ()=>{ if(onAccept) onAccept(); close(); });
  }

  /* =====================================================================
     LOADER API (Camioncito)
  ===================================================================== */
  const Loader = (()=>{
    const modal = document.getElementById('loaderModal');
    const scene = document.getElementById('scene');
    const bar = document.getElementById('progressBar');
    const status = document.getElementById('loaderDesc');
    document.getElementById('loaderClose').addEventListener('click', hide);
    function open(msg){
      modal.classList.add('open'); modal.setAttribute('aria-hidden','false');
      bar.style.inlineSize='0%'; status.textContent = msg || 'Optimizando…';
      scene.classList.add('is-running'); auto();
      return { setMessage, setProgress, finish, fail, close: hide };
    }
    function setMessage(t){ status.textContent = t; }
    function setProgress(p){ const v = clamp(p,0,100); bar.style.inlineSize=v+'%'; bar.parentElement.setAttribute('aria-valuenow', v); }
    function finish(t){ setProgress(100); setMessage(t||'Listo ✅'); setTimeout(hide, 500); }
    function fail(t){ setMessage(t||'Ocurrió un error'); }
    function hide(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); scene.classList.remove('is-running'); }
    function auto(){ let v=0; Loader._int && clearInterval(Loader._int); Loader._int=setInterval(()=>{ v = Math.min(v + (Math.random()*6+2), 95); setProgress(v); if(v>=95) clearInterval(Loader._int); }, 400); }
    return { open };
  })();

  /* =====================================================================
     RUTAS: Integración total
  ===================================================================== */
  const Route = (function(){
    let routeMap, routeMarkers = [], routeLines = [];
    let currentRoute = []; // array de puntos {id, tipo, nombre, lat, lng, monto, servicio, priority}
    let undoStack = [];

    const ptsTbody = document.getElementById('ptsTbody');
    const ptsQ = document.getElementById('ptsQ');
    const ptsCount = document.getElementById('ptsCount');
    const rutaTbody = document.getElementById('rutaTbody');
    const mapSk = document.getElementById('routeMapSkeleton');
    const mapEl = document.getElementById('routeMap');
    const selOrigen = document.getElementById('selOrigen');
    const prioAbast = document.getElementById('prioAbast');
    const prioDescAlta = document.getElementById('prioDescargaAlta');

    // render listado de puntos disponibles (suc + atms + otros + cab + órdenes marcadas "usar")
    function buildSourceRows(){
      const ords = State.ord.filter(o=>o.usar);
      const suc = State.suc.map(s=> ({tipo:'Sucursal', codigo:s.codigo, nombre:s.nombre, lat:s.lat, lng:s.lng, monto:0, servicio:'', id:'SUC:'+s.codigo}));
      const atms = State.atms.map(a=> ({tipo:'ATM', codigo:a.codigo, nombre:a.nombre, lat:a.lat, lng:a.lng, monto:0, servicio:'', id:'ATM:'+a.codigo}));
      const cab = State.cab.map(c=> ({tipo:'Cabecera', codigo:c.codigo, nombre:c.nombre, lat: parseNumber(c.lat)||null, lng: parseNumber(c.lng)||null, monto:0, servicio:'', id:'CAB:'+c.codigo})).filter(x=> isFinite(x.lat) && isFinite(x.lng));
      const otros = State.otros.map(o=> ({tipo:'Otros', codigo:o.codigo, nombre:o.nombre, lat:o.lat, lng:o.lng, monto:0, servicio:'', id:'OTR:'+o.codigo}));
      const ordMapped = ords.map(o=> ({tipo:o.categoria, codigo:o.codigo, nombre:o.nombre, lat:o.lat, lng:o.lng, monto:o.monto, servicio:o.servicio, id:o.id}));
      return [...ordMapped, ...suc, ...atms, ...otros]; // cabeceras no se mezclan aquí (van como origen)
    }

    function renderPts(){
      const arr = buildSourceRows();
      const q = (ptsQ.value||'').toLowerCase();
      const filtered = arr.filter(r=> !q || (r.codigo||'').toLowerCase().includes(q) || (r.nombre||'').toLowerCase().includes(q) || (r.tipo||'').toLowerCase().includes(q));
      ptsCount.textContent = filtered.length;
      ptsTbody.innerHTML = filtered.map(r => `
        <tr data-id="${r.id}">
          <td>${r.tipo}</td>
          <td>${(r.codigo||'')+' — '+(r.nombre||'')}</td>
          <td class="right">${fmtCoord(r.lat)}</td>
          <td class="right">${fmtCoord(r.lng)}</td>
          <td class="right">${r.monto? fmtMoney(r.monto): ''}</td>
          <td>${r.servicio||''}</td>
          <td><input type="checkbox" data-act="prio"></td>
          <td><button class="chip" data-act="add">Agregar</button></td>
        </tr>
      `).join('');
      [...ptsTbody.querySelectorAll('button[data-act="add"]')].forEach(b=> b.addEventListener('click', ()=>{
        const id = b.closest('tr').dataset.id;
        const src = buildSourceRows().find(x=>x.id===id); if(!src) return;
        addPointToRoute(src, b.closest('tr').querySelector('input[data-act="prio"]')?.checked);
      }));
    }
    ptsQ?.addEventListener('input', renderPts);
    document.getElementById('addFromOrdenes')?.addEventListener('click', ()=>{
      State.ord.filter(o=>o.usar).forEach(o => addPointToRoute({id:o.id, tipo:o.categoria, codigo:o.codigo, nombre:o.nombre, lat:o.lat, lng:o.lng, monto:o.monto, servicio:o.servicio}, false));
    });

    function addPointToRoute(p, priority=false){
      undoStack.push(currentRoute.slice());
      currentRoute.push({ ...p, priority: !!priority });
      draw();
    }
    function removeAt(idx){
      undoStack.push(currentRoute.slice());
      currentRoute.splice(idx,1);
      draw();
    }
    document.getElementById('btnDeshacer')?.addEventListener('click', ()=>{
      const prev = undoStack.pop(); if(prev){ currentRoute = prev; draw(); }
    });
    document.getElementById('btnLimpiarRuta')?.addEventListener('click', ()=>{ undoStack.push(currentRoute.slice()); currentRoute = []; draw(); });

    function stopTimeFor(tipo){
      if(/^suc/i.test(tipo||'')) return cfg.stopSuc||5;
      if(/^atm/i.test(tipo||'')) return cfg.stopATM||15;
      if(/^cab/i.test(tipo||'')) return cfg.stopCab||10;
      return cfg.stopExt||20;
    }

    function draw(){
      // tabla paradas
      rutaTbody.innerHTML = currentRoute.map((r,i)=>`
        <tr><td><span class="order-num">${i+1}</span></td><td>${r.tipo||''}</td><td>${r.nombre||''}</td><td class="right">${r.monto?fmtMoney(r.monto):''}</td><td>${r.servicio||''}${r.priority? ' <span class="priority">★</span>':''}</td><td><button class="chip" data-i="${i}" data-act="rm">Quitar</button></td></tr>
      `).join('');
      [...rutaTbody.querySelectorAll('button[data-act="rm"]')].forEach(b=> b.addEventListener('click', ()=> removeAt(parseInt(b.dataset.i))));

      // mapa
      waitForLeaflet().then(()=>{
        if(!routeMap){
          mapSk.classList.add('hidden'); mapEl.classList.remove('hidden');
          routeMap = L.map('routeMap', { zoomControl:true, minZoom:3 });
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(routeMap);
          routeMap.setView([-34.60,-58.38], 9);
        }
        routeMarkers.forEach(m=> m.remove()); routeMarkers=[];
        routeLines.forEach(l=> l.remove()); routeLines=[];
        const origenCodigo = selOrigen.value;
        const origen = State.cab.find(c=>c.codigo===origenCodigo);
        const pts = currentRoute.slice();
        // Dibujar markers (numerados)
        const bounds = [];
        if(origen && isFinite(parseNumber(origen.lat)) && isFinite(parseNumber(origen.lng))){
          const m = L.marker([parseNumber(origen.lat), parseNumber(origen.lng)], { title:'Origen: '+origen.nombre });
          m.addTo(routeMap); routeMarkers.push(m); bounds.push(m.getLatLng());
        }
        pts.forEach((p,i)=>{
          const num = i+1;
          const divIcon = L.divIcon({className:'', html:`<div style="display:grid;place-items:center;width:30px;height:30px;border-radius:10px;background:#fff;border:2px solid rgba(47,187,107,.8); font:800 12px/1 Inter,sans-serif">${num}</div>`, iconSize:[30,30], iconAnchor:[15,15]});
          const m = L.marker([p.lat, p.lng], {icon:divIcon, title: `${num}. ${p.tipo} — ${p.nombre}`});
          m.addTo(routeMap); routeMarkers.push(m); bounds.push(m.getLatLng());
        });
        if(bounds.length) routeMap.fitBounds(L.latLngBounds(bounds), {padding:[20,20]});

        // Dibujar líneas si ya optimizada/ordenada (tramos alternando colores)
        if(origen && pts.length){
          const coords = [[parseNumber(origen.lat), parseNumber(origen.lng)]].concat(pts.map(p=>[p.lat,p.lng])).concat([[parseNumber(origen.lat), parseNumber(origen.lng)]]);
          for(let i=0;i<coords.length-1;i++){
            const color = (i%2===0? 'var(--route-a)' : 'var(--route-b)');
            const l = L.polyline([coords[i], coords[i+1]], { color, weight:4, opacity:.9 });
            l.addTo(routeMap); routeLines.push(l);
          }
        }
        updateSummary();
      });
    }

    function updateSummary(){
      document.getElementById('sumPuntos').textContent = currentRoute.length;
      document.getElementById('sumCamiones').textContent = document.getElementById('nCamiones').value || 1;
      // calcular monto pico y tiempo estimado
      const origen = State.cab.find(c=>c.codigo===selOrigen.value);
      const pts = currentRoute;
      let maxMonto = 0, carga = 0;
      let distKm = 0, min = 0;
      let last = origen ? {lat: parseNumber(origen.lat), lng: parseNumber(origen.lng)} : null;
      for(const p of pts){
        if(last){ distKm += haversine(last.lat,last.lng,p.lat,p.lng); }
        min += stopTimeFor(p.tipo);
        carga += (p.monto||0 < 0 ? 0 : (p.monto||0)); // solo sumo abastecimientos como descarga del camión? ajustable
        maxMonto = Math.max(maxMonto, carga);
        last = p;
      }
      if(last && origen){ distKm += haversine(last.lat,last.lng, parseNumber(origen.lat), parseNumber(origen.lng)); }
      const tiempoTraslado = distKm / (cfg.vel||40) * 60 * (cfg.trafficFactor||1);
      const totalMin = Math.round(min + tiempoTraslado);
      document.getElementById('sumMonto').textContent = fmtMoney(maxMonto);
      document.getElementById('sumTiempo').textContent = `${Math.floor(totalMin/60)}:${String(totalMin%60).padStart(2,'0')} h`;
    }

    // ===================== OPTIMIZACIÓN =====================
    function optimize(){
      const ctl = Loader.open('Preparando la optimización…');
      setTimeout(()=> ctl.setMessage('Evaluando restricciones…'), 1000);
      const origen = State.cab.find(c=>c.codigo===selOrigen.value);
      if(!origen){ ctl.fail('Seleccioná una cabecera origen'); return; }

      // Construir lista de puntos con prioridad
      let pts = currentRoute.map(p=> ({...p}));
      // Aplica prioridades: manual ★, abastecimientos primero, descargas altas antes
      pts.sort((a,b)=>{
        const pa = (a.priority? -1000:0) + (prioAbast.checked && /^abastec/i.test(a.servicio||'') ? -100 : 0) + (prioDescAlta.checked ? -Math.sign(-(a.monto||0)) * Math.abs(a.monto||0)/1e6 : 0);
        const pb = (b.priority? -1000:0) + (prioAbast.checked && /^abastec/i.test(b.servicio||'') ? -100 : 0) + (prioDescAlta.checked ? -Math.sign(-(b.monto||0)) * Math.abs(b.monto||0)/1e6 : 0);
        if(pa!==pb) return pa-pb;
        // si igual, más cercano al origen
        const da = haversine(parseNumber(origen.lat), parseNumber(origen.lng), a.lat, a.lng);
        const db = haversine(parseNumber(origen.lat), parseNumber(origen.lng), b.lat, b.lng);
        return da-db;
      });

      // Para N<=11 usar Held-Karp (óptimo exacto por distancia), si no, nearest + 2-opt
      const N = pts.length;
      let orderIdx = [];
      if(N <= 11){
        ctl.setMessage('Ejecutando A* / Held-Karp (N pequeño)…');
        orderIdx = tspHeldKarp([origen, ...pts], cfg);
        // orderIdx devuelve orden visitando 1..N (sin el 0 que es origen); convertimos a lista de puntos
        orderIdx = orderIdx.map(i=> i-1); // a índices 0..N-1 de pts
      }else{
        ctl.setMessage('Heurística (vecino + 2-opt)…');
        orderIdx = heuristicOrder(origen, pts);
        orderIdx = twoOptImprove(origen, pts, orderIdx);
      }

      currentRoute = orderIdx.map(i => pts[i]);
      draw();
      ctl.finish('Optimización completada');
      addRecent();
    }

    function tspHeldKarp(nodes, cfg){
      // nodes[0] = origen; nodes[1..N] = puntos
      const n = nodes.length;
      const dist = Array.from({length:n},()=>Array(n).fill(0));
      for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(i!==j){
        dist[i][j] = haversine(nodes[i].lat, nodes[i].lng, nodes[j].lat, nodes[j].lng);
      }
      // Held-Karp DP
      const size = 1<<(n-1); // solo para nodos 1..n-1
      const dp = Array.from({length:size},()=>Array(n).fill(Infinity));
      const parent = Array.from({length:size},()=>Array(n).fill(-1));
      for(let j=1;j<n;j++){ dp[1<<(j-1)][j] = dist[0][j]; }
      for(let mask=1; mask<size; mask++){
        for(let j=1;j<n;j++){
          if(!(mask & (1<<(j-1)))) continue;
          const pmask = mask ^ (1<<(j-1));
          if(pmask===0) continue;
          for(let k=1;k<n;k++){
            if(!(pmask & (1<<(k-1)))) continue;
            const val = dp[pmask][k] + dist[k][j];
            if(val < dp[mask][j]){ dp[mask][j] = val; parent[mask][j] = k; }
          }
        }
      }
      // cerrar ciclo al origen
      let best=Infinity, end=-1; const full= size-1;
      for(let j=1;j<n;j++){ const val = dp[full][j] + dist[j][0]; if(val<best){ best=val; end=j; } }
      // reconstruir
      const seq = []; let mask = full, j=end;
      while(j!==-1){ seq.push(j); const pj = parent[mask][j]; mask = mask ^ (1<<(j-1)); j = pj; }
      seq.reverse(); //  [j1, j2, ...]
      return seq; // índices 1..n-1 en términos de nodes
    }

    function heuristicOrder(origen, pts){
      const unvis = new Set(pts.map((_,i)=>i));
      let cur = {lat: parseNumber(origen.lat), lng: parseNumber(origen.lng)};
      const order = [];
      while(unvis.size){
        let best=null, bestD=Infinity;
        unvis.forEach(i=>{
          const p=pts[i];
          const d = haversine(cur.lat,cur.lng,p.lat,p.lng);
          const penalty = (prioAbast.checked && /^abastec/i.test(p.servicio||''))? 0.85 : 1;
          const score = d*penalty - (p.priority? 5:0) - (prioDescAlta.checked ? Math.abs(p.monto||0)/1e7 : 0);
          if(score<bestD){ bestD=score; best=i; }
        });
        order.push(best); cur = pts[best]; unvis.delete(best);
      }
      return order;
    }
    function routeLength(origen, pts, order){
      let total=0; let last={lat: parseNumber(origen.lat), lng: parseNumber(origen.lng)};
      for(const i of order){ const p=pts[i]; total += haversine(last.lat,last.lng,p.lat,p.lng); last=p; }
      total += haversine(last.lat,last.lng, parseNumber(origen.lat), parseNumber(origen.lng));
      return total;
    }
    function twoOptImprove(origen, pts, order){
      let improved=true; let bestOrder=order.slice(); let bestLen=routeLength(origen, pts, bestOrder);
      while(improved){
        improved=false;
        for(let i=0;i<bestOrder.length-1;i++){
          for(let k=i+1;k<bestOrder.length;k++){
            const newOrder = bestOrder.slice(0,i).concat(bestOrder.slice(i,k+1).reverse(), bestOrder.slice(k+1));
            const len = routeLength(origen, pts, newOrder);
            if(len + 1e-6 < bestLen){ bestLen=len; bestOrder=newOrder; improved=true; }
          }
        }
      }
      return bestOrder;
    }

    // ===================== EXPORTAR / TRÁNSITO / HISTORIAL =====================
    document.getElementById('btnOptimizar')?.addEventListener('click', optimize);
    document.getElementById('btnTransito')?.addEventListener('click', ()=>{
      // Toggle de factor de tránsito (simulado). Para datos reales, configurar API externa.
      cfg.trafficFactor = (cfg.trafficFactor>=1.45? 1.0 : (cfg.trafficFactor+0.25));
      save(DB.cfg, cfg);
      updateSummary();
      showToast('Factor de tránsito: x'+cfg.trafficFactor.toFixed(2));
    });
    document.getElementById('btnExportar')?.addEventListener('click', ()=>{
      const origen = State.cab.find(c=>c.codigo===selOrigen.value);
      if(!origen){ return showToast('Elegí una cabecera'); }
      if(currentRoute.length===0){ return showToast('No hay paradas'); }
      const origin = `${parseNumber(origen.lat)},${parseNumber(origen.lng)}`;
      const dest = origin;
      const way = currentRoute.map(p=> `${p.lat},${p.lng}`).join('|');
      const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&waypoints=${encodeURIComponent(way)}&travelmode=driving`;
      window.open(url, '_blank');
    });
    document.getElementById('btnAprobar')?.addEventListener('click', ()=>{
      const nombre = prompt('Nombre de la ruta para historial:', 'Ruta '+ new Date().toLocaleString('es-AR'));
      if(!nombre) return;
      const origen = State.cab.find(c=>c.codigo===selOrigen.value);
      const rec = {
        id: uuid(), fecha: new Date().toISOString().slice(0,10), nombre,
        origen: selOrigen.value, puntos: currentRoute.map(p => ({...p})), camiones: parseInt(document.getElementById('nCamiones').value)||1,
        tiempo: document.getElementById('sumTiempo').textContent, montoPico: document.getElementById('sumMonto').textContent,
        aprobado: true
      };
      State.hist.unshift(rec); save(DB.hist, State.hist); renderHist(); showToast('Ruta aprobada y guardada');
    });

    function addRecent(){
      const tb = document.getElementById('recentRoutes');
      if(!tb) return;
      const km = '—';
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${'Ruta '+(new Date().toLocaleDateString('es-AR'))}</td><td>${currentRoute.length}</td><td>${'—'}</td><td>${document.getElementById('sumTiempo').textContent}</td><td>${km}</td>`;
      tb.prepend(tr);
    }

    function renderHist(){
      const tbody = document.getElementById('histTbody');
      tbody.innerHTML = State.hist.map(h=>`
        <tr data-id="${h.id}"><td>${h.fecha}</td><td>${h.nombre}</td><td>${h.puntos.length}</td><td>${h.tiempo}</td><td>${h.montoPico}</td><td>${h.aprobado?'Aprobado':'Borrador'}</td>
        <td><button class="chip" data-act="cargar">Cargar</button> <button class="chip" data-act="del">Eliminar</button></td></tr>
      `).join('');
      [...tbody.querySelectorAll('button[data-act="cargar"]')].forEach(b=> b.addEventListener('click', ()=>{
        const id = b.closest('tr').dataset.id;
        const h = State.hist.find(x=>x.id===id); if(!h) return;
        selOrigen.value = h.origen || '';
        currentRoute = (h.puntos || []).map(p => ({...p}));
        document.getElementById('nCamiones').value = h.camiones || 1;
        draw(); showToast('Ruta cargada desde historial');
      }));
      [...tbody.querySelectorAll('button[data-act="del"]')].forEach(b=> b.addEventListener('click', ()=>{
        const id = b.closest('tr').dataset.id;
        const i = State.hist.findIndex(x=>x.id===id); if(i>=0 && confirm('¿Eliminar del historial?')){ State.hist.splice(i,1); save(DB.hist, State.hist); renderHist(); }
      }));
    }
    renderHist();

    document.getElementById('btnExportHist')?.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(State.hist, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = Object.assign(document.createElement('a'), {href:url, download:'historial_rutas.json'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    document.getElementById('histImportInput')?.addEventListener('change', (ev)=>{
      const f=ev.target.files?.[0]; if(!f) return; const reader=new FileReader();
      reader.onload = (e)=>{ try{ const arr = JSON.parse(e.target.result); if(Array.isArray(arr)){ State.hist = arr; save(DB.hist, State.hist); renderHist(); showToast('Historial importado'); } }catch(e){ alert('JSON inválido'); } };
      reader.readAsText(f); ev.target.value='';
    });
    document.getElementById('btnImportHist')?.addEventListener('click', ()=> document.getElementById('histImportInput').click());

    // Init
    renderPts(); draw();
  })();

  /* =====================================================================
     CONFIGURACIÓN (persistir y aplicar)
  ===================================================================== */
  (function(){
    const bind = (id, prop, onChange)=>{
      const el = document.getElementById(id); if(!el) return;
      el.value = cfg[prop];
      el.addEventListener('input', ()=>{ cfg[prop] = (el.type==='color'||el.type==='text')? el.value : parseNumber(el.value); save(DB.cfg, cfg); if(onChange) onChange(); if(prop.startsWith('ui')) applyUIConfig(); });
    };
    bind('cfgMaxMonto','maxMonto');
    bind('cfgMaxMin','maxMin');
    bind('cfgVel','vel');
    bind('cfgStopSuc','stopSuc', ()=>{});
    bind('cfgStopATM','stopATM', ()=>{});
    bind('cfgStopCab','stopCab', ()=>{});
    bind('cfgStopExt','stopExt', ()=>{});
    bind('cfgFont','uiFont', applyUIConfig);
    bind('cfgRadius','uiRadius', applyUIConfig);
    bind('cfgAccent','uiAccent', applyUIConfig);
  })();

  // Copiar versión
  document.getElementById('versionChip')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText('v8.0.0'); showToast('Versión copiada'); }catch{}
  });
  </script>
</body>
</html>
